      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Sparse matrices, K-means clustering, topic modelling with KOS blogs on the 2004 Presidential election</title>
      	
         
         
            <meta name ="description" content ="The shadow economy as a percentage of GDP in wealthier countries is in decline; and had a spike in 2009 with the economic crisis.  More research is needed to adequately understand it.  Along the way I experiment with extracting data frames from PDF tables; and show it's always worthwhile looking at the same data in different ways, which can be as simple as freeing up the vertical axes of graphics.">
            <meta property="og:description" content ="The shadow economy as a percentage of GDP in wealthier countries is in decline; and had a spike in 2009 with the economic crisis.  More research is needed to adequately understand it.  Along the way I experiment with extracting data frames from PDF tables; and show it's always worthwhile looking at the same data in different ways, which can be as simple as freeing up the vertical axes of graphics.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Sparse matrices, K-means clustering, topic modelling with KOS blogs on the 2004 Presidential election" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0075-shadow-line.png" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2016/12/26/sparse-bags/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">     
		<link href="/css/syntax.css" rel ="stylesheet">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2016/12/26/sparse-bags>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
              <li><a href="/presentations/index.html">Presentations</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Sparse matrices, K-means clustering, topic modelling with KOS blogs on the 2004 Presidential election</h1>
         <p class="meta">26 Dec 2016</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>At a glance:</h2>
   The shadow economy as a percentage of GDP in wealthier countries is in decline; and had a spike in 2009 with the economic crisis.  More research is needed to adequately understand it.  Along the way I experiment with extracting data frames from PDF tables; and show it's always worthwhile looking at the same data in different ways, which can be as simple as freeing up the vertical axes of graphics.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="data-on-the-shadow-economy">Data on the shadow economy?</h2>
<p>I’m reading Kenneth Rogoff’s <a href="http://press.princeton.edu/titles/10798.html">The Curse of Cash</a>.  It was one of Bloomberg’s Best Books of 2016 and the Financial Times’ Best Economics Books of 2016, and I recommend it.  It’s an excellent and convincing book, making the case for getting rid of large denomination notes for three reasons:</p>

<ul>
  <li>to put the squeeze on the shadow economy (everything from breaches of labour standards, visa requirements, and tax evasion)</li>
  <li>make life harder for organised crime</li>
  <li>make negative interest rates a credible weapon in the armoury of central banks.</li>
</ul>

<p>If you’re interested, there’s also a <a href="http://www.lse.ac.uk/website-archive/newsAndMedia/videoAndAudio/channels/publicLecturesAndEvents/player.aspx?id=3663">talk at the London School of Economics</a> from 23 November 2016 that’s worth listening to or watching; actually that talk was what prompted me to buy the book for holiday reading.</p>

<p>The book has prompted me to follow up something I’ve wondered about for a while, which is “how do people try to measure the shadow economy?”. One of the broadest definitions of the shadow economy is:</p>

<blockquote>
  <p><a href="http://ftp.iza.org/dp6423.pdf">“…those economic activities, and the income derived from them, that circumvent or otherwise avoid government regulation, taxation or observation”</a>.</p>
</blockquote>

<p>This includes both legal and illegal economic activities.  What I am interested in here is the measurement of otherwise legal economic activities, such as cash payments for the purpose of tax-evasion, rather than intrinsically illegal activities, such as drug trafficking.</p>

<p>Estimating the size of this shadow economy is fraught with obvious difficulties and there is no universally accepted way of doing it.  Rogoff cites research by Friedrich Schneider and colleagues.  A bit of googling shows that their approach seems to be pretty systematic and mature, and takes into account a range of previous efforts.  It looks like Schneider et al’s 2010 <a href="https://www.researchgate.net/profile/Friedrich_Schneider/publication/227346997_New_Estimates_for_the_Shadow_Economies_All_over_the_World/links/09e415061fa38ccf13000000.pdf"><em>New Estimates for the Shadow Economies all over the World</em></a> is a seminal paper, with the data reproduced or cited by a range of researchers and NGOs.  An updated consideration of methodological issues is in Schneider and Buehn’s 2016 <a href="http://ftp.iza.org/dp9820.pdf"><em>Estimating the Size of the Shadow
Economy: Methods, Problems and Open Questions</em></a>.</p>

<p>Figures in the 2010 paper were improved and updated in the short January 2015 paper <a href="http://www.econ.jku.at/members/schneider/files/publications/2015/shadeceurope31.pdf"><em>Size and Development of the Shadow Economy of
31 European and 5 other OECD Countries from 2003 to 2015: Different Developments</em></a>.  It includes tables with estimates from 2003 to 2015 of the shadow economy for 28 European Union (EU), three non-EU, and five non-European countries.  There’s only a basic barchart of average values in that paper, but here’s a graphic I made that I think summarises the data:</p>

<p><img src="/img/0075-shadow-line.svg" alt="plot" /></p>

<p>It’s pretty self-explanatory.  The universal (for these generally wealthier countries) downwards trend over time is the obvious feature.  The inter-country variations won’t surprise anyone aware of the different institutional arrangements and cultural practices across these countries.  Worth noting is that value-added taxes in the USA are low by international standards, with proportionately more government revenue coming from income tax.  Rogoff and others argue that lower incentives to avoid sales and value-added taxes can partly explain the relatively low level of this kind of shadow economy activity in countries like the USA.  A cursory glance at <a href="https://en.wikipedia.org/wiki/Value-added_tax">VAT rates in wikipedia</a> suggests this factor, if it exists, is not a particularly important one in explaining differences across countries.  A question I may follow up one day.</p>

<p>A close up view of the same data, by allowing a tailored vertical axis for each country, draws attention to micro structural influences on this kind of shadow economic activity.  Note the upward blips across countries around the time of the recent international financial crises in 2008-2009.</p>

<p><img src="/img/0075-shadow-line-free.svg" alt="plot2" /></p>

<p>According to Schneider the decrease since the 2008-2009 economic crisis can be explained as follows:</p>

<blockquote>
  <p>“…the most important reason for this decrease is that if the official economy is recovering or booming, people have fewer incentives to undertake additional activities in the shadow economy and to earn extra “black” money.”</p>
</blockquote>

<p>I’m sure Schneider is correct that economic boom and bust has a short term impact, but the general trend downwards over the longer period (2003 onwards) makes it clear that something more substantive is going on.</p>

<h2 id="data-extraction-from-pdf-files">Data extraction from PDF files</h2>

<p>Extracting the data was a pain because it is in three tables in a PDF document.  My strategy to make this easier was to:</p>

<ul>
  <li>download and save the PDF</li>
  <li>use the extremely excellent and useful <a href="http://ropensci.org/blog/2016/03/01/pdftools-and-jeroen"><code class="highlighter-rouge">pdftools</code></a> R package to import the article into R as a list of character vectors, with one element of the list per page of the PDF</li>
  <li>use regular expressions to extract and tidy up tables 1, 2 and 3 from pages 6 and 7 (most importantly, replace sequences of adjacent spaces with a single “pipe” <code class="highlighter-rouge">|</code>)</li>
  <li>take advantage of those <code class="highlighter-rouge">|</code> delimiters to save each table as its own pipe-delimited text file</li>
  <li>re-import back to R as three different data frames, combine and tidy up for analysis</li>
  <li>check final results against the original PDF.</li>
</ul>

<p>As far as I’m aware there’s no general and robust way of converting the wide variety of tables in PDF documents into machine-usable data, but this approach could be used in quite a wide variety of situations.  There’s a bit of manual adjustment required (for example, dealing with the spaces in “New Zealand” and “Czech Republic”, which I do in quite an ad hoc way given there are only a few to take into account).  Here’s the code for the data import and table extraction:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#-----functionality------------------
</span><span class="n">library</span><span class="p">(</span><span class="n">pdftools</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">

</span><span class="c1">#------download file and bring into R------------
</span><span class="n">download.file</span><span class="p">(</span><span class="s2">"http://www.econ.jku.at/members/schneider/files/publications/2015/shadeceurope31.pdf"</span><span class="p">,</span><span class="w">
              </span><span class="n">destfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"shadeceurope31.pdf"</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wb"</span><span class="p">)</span><span class="w">

</span><span class="n">shade</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pdf_text</span><span class="p">(</span><span class="s2">"shadeceurope31.pdf"</span><span class="p">)</span><span class="w">

</span><span class="c1">#---------Import and clean up page six, which is Table 1------------
</span><span class="n">tab1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">shade</span><span class="p">[[</span><span class="m">6</span><span class="p">]]</span><span class="w">
</span><span class="c1"># replace spaces in country names with under scores
</span><span class="n">tab1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Luxembourg (Grand"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Luxembourg_(Grand"</span><span class="p">,</span><span class="w"> </span><span class="n">tab1</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">tab1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Czech Republic"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Czech_Republic"</span><span class="p">,</span><span class="w"> </span><span class="n">tab1</span><span class="p">)</span><span class="w">
</span><span class="n">tab1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"United Kingdom"</span><span class="p">,</span><span class="w"> </span><span class="s2">"United_Kingdom"</span><span class="p">,</span><span class="w"> </span><span class="n">tab1</span><span class="p">)</span><span class="w">
</span><span class="c1"># replace all other sets of 1 or more spaces with a single | delimieter
</span><span class="n">tab1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" * "</span><span class="p">,</span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">tab1</span><span class="p">)</span><span class="w">

</span><span class="c1"># save as a text file
</span><span class="n">writeLines</span><span class="p">(</span><span class="n">tab1</span><span class="p">,</span><span class="w"> </span><span class="s2">"tab1.txt"</span><span class="p">)</span><span class="w">

</span><span class="c1"># read back in
</span><span class="n">eur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"tab1.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">eur</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"empty"</span><span class="p">,</span><span class="w"> </span><span class="s2">"country"</span><span class="p">,</span><span class="w"> </span><span class="m">2003</span><span class="o">:</span><span class="m">2015</span><span class="p">)</span><span class="w">
</span><span class="n">eur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eur</span><span class="p">[,</span><span class="m">2</span><span class="o">:</span><span class="m">15</span><span class="p">]</span><span class="w"> 
</span><span class="n">eur</span><span class="o">$</span><span class="n">country</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Luxembourg.*"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Luxembourg"</span><span class="p">,</span><span class="w"> </span><span class="n">eur</span><span class="o">$</span><span class="n">country</span><span class="p">)</span><span class="w">

</span><span class="c1">#--------Import and clean up page seven, which is Tables 2 and 3--------------
</span><span class="n">page7</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">shade</span><span class="p">[[</span><span class="m">7</span><span class="p">]]</span><span class="w">
</span><span class="n">tab2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Source:.*"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">page7</span><span class="p">)</span><span class="w">



</span><span class="c1"># Table 2 clean up, export, import
</span><span class="n">tab2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" * "</span><span class="p">,</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">tab2</span><span class="p">)</span><span class="w">
</span><span class="n">writeLines</span><span class="p">(</span><span class="n">tab2</span><span class="p">,</span><span class="w"> </span><span class="s2">"tab2.txt"</span><span class="p">)</span><span class="w">
</span><span class="n">noneu</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.table</span><span class="p">(</span><span class="s2">"tab2.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">noneu</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">eur</span><span class="p">)</span><span class="w">

</span><span class="c1"># Table 3 clean up, export, import
</span><span class="n">tab3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">".*Table 3"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">page7</span><span class="p">)</span><span class="w">
</span><span class="n">tab3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"New Zealand"</span><span class="p">,</span><span class="w"> </span><span class="s2">"New_Zealand"</span><span class="p">,</span><span class="w"> </span><span class="n">tab3</span><span class="p">)</span><span class="w">
</span><span class="n">tab3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"United States USA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"USA"</span><span class="p">,</span><span class="w"> </span><span class="n">tab3</span><span class="p">)</span><span class="w">
</span><span class="n">tab3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" * "</span><span class="p">,</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">tab3</span><span class="p">)</span><span class="w">

</span><span class="n">writeLines</span><span class="p">(</span><span class="n">tab3</span><span class="p">,</span><span class="w"> </span><span class="s2">"tab3.txt"</span><span class="p">)</span><span class="w">
</span><span class="n">noneur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">   </span><span class="n">read.table</span><span class="p">(</span><span class="s2">"tab3.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">nrows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">noneur</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">eur</span><span class="p">)</span><span class="w">

</span><span class="c1"># clean up:
</span><span class="n">unlink</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"tab1.txt"</span><span class="p">,</span><span class="w"> </span><span class="s2">"tab2.txt"</span><span class="p">,</span><span class="w"> </span><span class="s2">"tab3.txt"</span><span class="p">))</span></code></pre></figure>

<h2 id="analysis">Analysis</h2>

<p>Once the data are available in the same shape (in the three data frames <code class="highlighter-rouge">eur</code>, <code class="highlighter-rouge">noneu</code> and <code class="highlighter-rouge">noneur</code>), combining and tidying up for analysis is straightforward.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#======set up data for analysis=======
# create long, tidy version of the basic data
</span><span class="n">shadow</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">eur</span><span class="p">,</span><span class="w"> </span><span class="n">noneu</span><span class="p">,</span><span class="w"> </span><span class="n">noneur</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">classification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"European Union (EU)"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Non-EU European"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Non-European"</span><span class="p">),</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w"> </span><span class="n">country</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">gather</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">classification</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
          </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">year</span><span class="p">))</span><span class="w">

</span><span class="c1"># totals, latest, average - summary version, use for ordering factors in the graphic
</span><span class="n">totals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">ave</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w">
             </span><span class="n">latest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="nf">length</span><span class="p">(</span><span class="n">value</span><span class="p">)])</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">latest</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">),</span><span class="w"> </span><span class="s2">"%"</span><span class="p">))</span><span class="w">
   </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">ave</span><span class="p">))</span><span class="w">

</span><span class="c1"># create factors with ordered levels for using in the graphic
</span><span class="n">shadow</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">shadow</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">totals</span><span class="o">$</span><span class="n">country</span><span class="p">),</span><span class="w">
          </span><span class="n">countrylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">country</span><span class="p">),</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">totals</span><span class="o">$</span><span class="n">label</span><span class="p">))</span><span class="w">

</span><span class="c1">#=================analysis=================
</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">shadow</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">classification</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">countrylab</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2005</span><span class="p">,</span><span class="w"> </span><span class="m">2010</span><span class="p">,</span><span class="w"> </span><span class="m">2015</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_colour_brewer</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Set2"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Slowly decreasing shadow economy over time"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"31 European and five non-European countries.   The percentage in each title is the value in 2015."</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Estimated shadow economy as percent of official GDP"</span><span class="p">,</span><span class="w">
        </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Schneider 2015\nhttp://www.econ.jku.at/members/schneider/files/publications/2015/shadeceurope31.pdf"</span><span class="p">)</span><span class="w">
		
</span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">countrylab</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free_y"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Shadow economy spike in 2008-2009"</span><span class="p">,</span><span class="w">   
           </span><span class="s2">"31 European and five non-European countries.   The percentage in each title is the value in 2015."</span><span class="p">)</span><span class="w">

</span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">)</span><span class="w">		   
</span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="m">2</span><span class="p">)</span></code></pre></figure>



</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2016/12/26/shadow-economy">
        <p>&larr; Older</p>
        <p>Extracting data on shadow economy from PDF tables</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
			
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

			<div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="true" data-share="false"></div>
			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			
			

			</footer>
    </div>



  
</body>
</html>
   




         
