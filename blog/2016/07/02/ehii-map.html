      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Animated world inequality map</title>
      	
         
         
            <meta name ="description" content ="Animated over time choropleth map of intra-country inequality, where data exist, using University of Texas Inequality Project data.">
            <meta property="og:description" content ="Animated over time choropleth map of intra-country inequality, where data exist, using University of Texas Inequality Project data.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Animated world inequality map" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0048-ehii.gif" />
         
		 
			<meta property="og:url" content="http://freerangestats.info/blog/2016/07/02/ehii-map.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
				  <li><a href = /blog/2020/05/30/implausible-health-data-firm>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">election forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href = "/elections/oz/index.html">Australia federal 2019</a></li>
				  <li><a href = "/elections/combined.html">NZ 2016</a></li>
                  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Animated world inequality map</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>Animated over time choropleth map of intra-country inequality, where data exist, using University of Texas Inequality Project data.</p>
	   <p class="meta">02 Jul 2016</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <p>In my <a href="/blog/2016/06/30/ehii">last post</a> I had a first look (for me) at <a href="http://utip.lbj.utexas.edu/data.html">Estimated Household Income Inequality data</a> from the University of Texas Inequality Project.   These data came to my attention when Professor James K. Galbraith used them in his keynote presentation to the 2016 New Zealand Association of Economists conference.  Some of the slides associated with these data include world choropleth maps at five year intervals.  I set out to re-create versions of those images, and upgrade to an animated image showing a rolling five year window using the average of any data available for each country in that five year window.  Here’s the result:</p>

<p><a href="/img/0048-ehii.gif">
	<img src="/img/0048-ehii.gif" style="width:800px;" />
	<i>Click for larger image.</i>
</a></p>

<p><a href="https://en.wikipedia.org/wiki/Gini_coefficient">Gini coefficient</a> is a measure of inequality. On the scale used in this dataset, 100 represents perfect inequality, with one household (in this case) earning all the country’s income.  0 represents perfect equality, with all households on equal incomes.  On the map above, blue indicates countries with relatively lower inequality, yellow and red relatively higher.  Countries marked grey have no data in the indicated five year period.</p>

<p>The first thing I notice from this graphic is that for large chunks of time big parts of the world are lacking data in this particular collection, with the old USSR, twentieth century China, pre 1990 South America and central Africa standing out in particular.  Secondarily, it’s sort of hypnotising to pick a country and see if you can pick the change in inequality over time.  The most obvious contrast generally comes at the break point of the repeating cycle, when it moves from 2008 to 1963, and you’re suddenly reminded how much things subtly changed over that time.  How good this map is as an analytical tool I’m unsure (we know from Cleveland’s experiments decades ago that people are bad at judging quantity from colour density), but it’s got some degree of communication content.</p>

<p>There are a few complications here arising from what in the data modelling business are referred to as “slowly changing dimensions”, in this case national boundaries.  At one point I thought I would want a different set of national boundaries for each year - or at least for the years on either side of the big changes in 1989 and 1990.  But there is very little data in the UTIP dataset for pre-1990 countries, with East Germany the standout exception.  In contrast, the project team have obtained data on several “countries” well before they were officially recognised as countries - like Eritrea and Papua New Guinea prior to their independence.  Using a map in the 1980s that showed East Germany would remove Eritrea from the image.</p>

<p>In the end, I opted to use 1995 borders all the way through.  This drops East Germany from the dataset but keeps Eritrea.  Macao, Hong Kong and Puerto Rico are also casualties of the combination of changing sovereignty and statistical practice, but this has little visual impact due to their small geographical size.</p>

<p>The luxury to explore the changing boundaries was made possible by <a href="http://nils.weidmann.ws/projects/cshapes.html">Nils Weidmann’s wonderful CShapes project</a>, which makes available  country boundaries and capitals back to the end of World War II.  The formats available are standard GIS shapefiles and an R package.</p>

<p>Here’s the R code behind that animation:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">cshapes</span><span class="p">)</span><span class="w">      </span><span class="c1"># for historic country boundaries.  Load this early as it calls plyr which clashes with dplyr
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span><span class="w"> </span><span class="c1"># for brewer.pal(...)
</span><span class="n">library</span><span class="p">(</span><span class="n">openxlsx</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">countrycode</span><span class="p">)</span><span class="w">  </span><span class="c1"># for ISO country codes
</span><span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span><span class="w">     </span><span class="c1"># for theme_map
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">        </span><span class="c1"># for reshaping the UTIP EHII data
</span><span class="w">
</span><span class="c1"># if we didn't already download it some previous day, download the UTIP EHII data:
</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file.exists</span><span class="p">(</span><span class="s2">"ehii.xlsx"</span><span class="p">)){</span><span class="w">
   </span><span class="n">download.file</span><span class="p">(</span><span class="s2">"http://utip.lbj.utexas.edu/data/EHII-UPDATED-10-30-2013.xlsx"</span><span class="p">,</span><span class="w">
              </span><span class="n">destfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ehii.xlsx"</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wb"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">ehii</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.xlsx</span><span class="p">(</span><span class="s2">"ehii.xlsx"</span><span class="p">)[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="c1"># don't need the first column
</span><span class="w">
</span><span class="n">ehii_tidy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ehii</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">gather</span><span class="p">(</span><span class="n">Year</span><span class="p">,</span><span class="w"> </span><span class="n">Gini</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Country</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Code</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">Year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">Year</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">Code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"GER"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DEU"</span><span class="p">,</span><span class="w"> </span><span class="n">Code</span><span class="p">),</span><span class="w">
          </span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">Code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"YUG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SCG"</span><span class="p">,</span><span class="w"> </span><span class="n">iso3c</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">countrycode_data</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"iso3c"</span><span class="p">,</span><span class="w"> </span><span class="s2">"iso2c"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">)</span><span class="w">
</span><span class="c1"># Germany after unification had the wrong code; change to DEU
# YUG has data 1994 to 1998 and had dubious status. Recode as SCG (Serbia and Montenegro)
</span><span class="w">

</span><span class="c1"># set the global historical limits of the Gini coefficients
</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">ehii_tidy</span><span class="o">$</span><span class="n">Gini</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> 
           </span><span class="nf">max</span><span class="p">(</span><span class="n">ehii_tidy</span><span class="o">$</span><span class="n">Gini</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">



</span><span class="c1">#=======loop drawing the individual frames of the animation starts here=========
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">ehii_tidy</span><span class="o">$</span><span class="n">Year</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="o">:</span><span class="nf">max</span><span class="p">(</span><span class="n">ehii_tidy</span><span class="o">$</span><span class="n">Year</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="p">)){</span><span class="w">

   </span><span class="c1"># thanks to cshapes project for historical countries: http://nils.weidmann.ws/projects/cshapes.html
</span><span class="w">   
   
   </span><span class="c1"># Download a shapefile of country boundaries.
</span><span class="w">   </span><span class="c1"># This was first set up to use 1988 boundaries for some maps, 1995 for others;
</span><span class="w">   </span><span class="c1"># but it turns out that if we use 1995 boundaries all the time the only
</span><span class="w">   </span><span class="c1"># old country we miss out on is East Germany, and we gain PNG and Eritrea
</span><span class="w">   </span><span class="c1"># Also note that Hong Kong, Macau and Puerto Rico have data that can't be
</span><span class="w">   </span><span class="c1"># shown with formal country boundaries in any cshapes maps.  I've left this
</span><span class="w">   </span><span class="c1"># so it is easy to change to use 1988 boundaries sometimes, but at the moment
</span><span class="w">   </span><span class="c1"># it will only do this when the year is earlier than 1960 (never, with current
</span><span class="w">   </span><span class="c1"># inequality data from UTIP)
</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1960</span><span class="p">){</span><span class="w">
      </span><span class="n">world</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cshp</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="m">1988</span><span class="p">,</span><span class="w"> </span><span class="s2">"-06-01"</span><span class="p">)))</span><span class="w">      
   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">world</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cshp</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="m">1995</span><span class="p">,</span><span class="w"> </span><span class="s2">"-06-01"</span><span class="p">)))</span><span class="w">      
   </span><span class="p">}</span><span class="w">

   </span><span class="c1"># Some manual tweaks to the shapefile to make an ISO3 country code variable
</span><span class="w">   </span><span class="c1"># compatible with that in the UTIP inequality data.
</span><span class="w">   </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">CNTRY_NAME</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Pakistan"</span><span class="p">,</span><span class="w">
                              </span><span class="s2">"PAK"</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">ISO1AL3</span><span class="p">))</span><span class="w">
   </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">CNTRY_NAME</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Libya"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LBY"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">)</span><span class="w">
   </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"zech"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">CNTRY_NAME</span><span class="p">),</span><span class="w"> </span><span class="s2">"CZE"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">)</span><span class="w">
   </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"Angola"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">CNTRY_NAME</span><span class="p">),</span><span class="w"> </span><span class="s2">"AGO"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">)</span><span class="w">
   </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"Bangladesh"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">CNTRY_NAME</span><span class="p">),</span><span class="w"> </span><span class="s2">"BGD"</span><span class="p">,</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">)</span><span class="w">
   
   </span><span class="c1"># convert the shapefile into a data frame for use with ggplot2,
</span><span class="w">   </span><span class="c1"># and join it to the ISO3 country codes for later use:
</span><span class="w">   </span><span class="n">world_map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fortify</span><span class="p">(</span><span class="n">world</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">left_join</span><span class="p">(</span><span class="n">data_frame</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">))</span><span class="w"> 
   
   </span><span class="c1"># set the five year window for which we want the moving average
</span><span class="w">   </span><span class="n">years</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
   
   </span><span class="c1"># filter the data to those five years and take the average
</span><span class="w">   </span><span class="c1"># of any years of data we have for each country in those 
</span><span class="w">   </span><span class="c1"># years:
</span><span class="w">   </span><span class="n">the_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ehii_tidy</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">Year</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">years</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">group_by</span><span class="p">(</span><span class="n">iso3c</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">dplyr</span><span class="o">::</span><span class="n">summarise</span><span class="p">(</span><span class="n">Gini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">Gini</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Gini</span><span class="p">))</span><span class="w">
   
   </span><span class="c1"># these next messages and printing are checks to see which
</span><span class="w">   </span><span class="c1"># if any countries we are missing out on drawing due to
</span><span class="w">   </span><span class="c1"># data mismatches:
</span><span class="w">      </span><span class="n">all_gini_countries</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">the_data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">)</span><span class="w">
      </span><span class="n">all_map_countries</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">world_map</span><span class="o">$</span><span class="n">iso3c</span><span class="p">)</span><span class="w">
      
      </span><span class="n">missed1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="o">!</span><span class="n">all_map_countries</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">all_gini_countries</span><span class="p">)</span><span class="w">
      </span><span class="n">missed2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="o">!</span><span class="n">all_gini_countries</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">all_map_countries</span><span class="p">)</span><span class="w">
      </span><span class="n">missed3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">iso3c</span><span class="p">))</span><span class="w">
      </span><span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">missed1</span><span class="p">,</span><span class="w"> </span><span class="s2">"countries in map but no Gini"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w">
      </span><span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">missed2</span><span class="p">,</span><span class="w"> </span><span class="s2">"countries have a Gini but no map in "</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w">
      </span><span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">missed3</span><span class="p">,</span><span class="w"> </span><span class="s2">"countries have no iso3c code in"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w">
      
      </span><span class="c1"># print the countries that had data which wasn't mapped
</span><span class="w">      </span><span class="n">print</span><span class="p">(</span><span class="n">all_gini_countries</span><span class="p">[</span><span class="o">!</span><span class="n">all_gini_countries</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">all_map_countries</span><span class="p">])</span><span class="w">
   
      </span><span class="c1"># Puerto Rico, Macau and Hong Kong often are missing from the map
</span><span class="w">      </span><span class="c1"># DDR has data 1970 to 1988 and won't be shown
</span><span class="w">      </span><span class="c1"># ERI has data from 1963 despite not really being a country until 1993
</span><span class="w">      </span><span class="c1">#     If we use 1995 maps it will show up but we have to drop DDR.
</span><span class="w">      </span><span class="c1"># PNG has data pre its independence in 1975; need a map from later than
</span><span class="w">      </span><span class="c1">#     1975 for its borders to show up.
</span><span class="w">
   </span><span class="c1"># Back to the main routine needed for drawing the map.         
</span><span class="w">   </span><span class="c1"># Merge the Gini coefficient data with the world map
</span><span class="w">   </span><span class="n">the_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">right_join</span><span class="p">(</span><span class="n">the_data</span><span class="p">,</span><span class="w"> </span><span class="n">world_map</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">)</span><span class="w">
   
   </span><span class="c1"># Draw the map
</span><span class="w">   </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">the_data</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gini</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey60"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">theme_map</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">23</span><span class="p">,</span><span class="w"> </span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">coord_equal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">scale_fill_gradientn</span><span class="p">(</span><span class="n">colours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brewer.pal</span><span class="p">(</span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="s2">"RdYlBu"</span><span class="p">)[</span><span class="m">9</span><span class="o">:</span><span class="m">1</span><span class="p">],</span><span class="w"> 
                           </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">limits</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-48</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">" to "</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w">
               </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey30"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-137</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-50</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Red = more inequality"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkred"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-137</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-54</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Blue = less inequality"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">labs</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Mean Gini\ncoefficient"</span><span class="p">,</span><span class="w">
           </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Map by http://ellisp.github.io/\nData from University of Texas Inequality Project 'Estimated Household Income Inequality'"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Changing inequality estimates over time"</span><span class="p">,</span><span class="w">
              </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Full animation shows 1963 to 2008, five years at once"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title.align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w">
      
   </span><span class="c1"># save the frame as an image
</span><span class="w">   </span><span class="n">png</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s2">".png"</span><span class="p">),</span><span class="w"> </span><span class="m">1800</span><span class="p">,</span><span class="w"> </span><span class="m">950</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">
      </span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
   </span><span class="n">dev.off</span><span class="p">()</span><span class="w">
       
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Combine all the frames into a single animated GIF, using ImageMagick
# note since upgrade to v7 ImageMagick uses magick not convert, which makes
# things much easier for Windows users (no conflict with Windows convert, which
# does something completely different)
</span><span class="n">system</span><span class="p">(</span><span class="s1">'magick -loop 0 -delay 80 *.png "0048-ehii.gif"'</span><span class="p">)</span></code></pre></figure>



		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2016/06/30/ehii">International Household Income Inequality data</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2016/07/14/nzelect-cran">nzelect 0.2.0 on CRAN</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics
http://Http://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>