      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Elastic net regularization of a model of burned calories</title>
      	
         
         
            <meta name ="description" content ="Elastic net regularization of estimates is a good way of dealing with collinearity and feature selection; this is illustrated with a simple dataset of 30 daily observations from a fitbit tracker.">
            <meta property="og:description" content ="Elastic net regularization of estimates is a good way of dealing with collinearity and feature selection; this is illustrated with a simple dataset of 30 daily observations from a fitbit tracker.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Elastic net regularization of a model of burned calories" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0050-pairs.png" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2016/08/13/dualaxes/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">     
		<link href="/css/syntax.css" rel ="stylesheet">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2016/08/13/dualaxes>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
              <li><a href="/presentations/index.html">Presentations</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Elastic net regularization of a model of burned calories</h1>
         <p class="meta">13 Aug 2016</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>TL;DR Summary:</h2>
   Elastic net regularization of estimates is a good way of dealing with collinearity and feature selection; this is illustrated with a simple dataset of 30 daily observations from a fitbit tracker.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="deal-with-feature-selection-and-collinearity">Deal with feature selection and collinearity</h2>

<p>Recently I’ve been making more use of <a href="https://en.wikipedia.org/wiki/Elastic_net_regularization">elastic net regularization</a> as a way of fitting linear models to data when I have more candidate explanatory variables than I know what to do with and some of them are collinear ie their information doubles up on what is in other variables.</p>

<p>Elastic net regularization is a more general form of the ridge regression and lasso methods.  Ridge regression was primarily a method to deal with the instability of estimates of the coefficients of linear models when they are collinear; the lasso a method of feature selection that forces coefficients for some/many explanatory variables to be zero and provides good estimates of the coefficients of the remaining features.  Both are preferable to stepwise selection which provides estimates of effect sizes biased upwards in absolute magnitude.  I deliberately use the term “was” for ridge regression because I don’t see any reason for using either of these methods any more; they are superseded by the more general elastic net.  A hyperparameter <code class="highlighter-rouge">alpha</code> means the method is equivalent to lasso when <code class="highlighter-rouge">alpha == 1</code> and to ridge regression when <code class="highlighter-rouge">alpha == 0</code>.  We can use cross-validation assessing the fit of the best models with different values of <code class="highlighter-rouge">alpha</code> to work out the best value of <code class="highlighter-rouge">alpha</code>.</p>

<p>The method works as an extension of ordinary least squares (OLS), the most common and basic (ie Stats 101) method of estimating the coefficients in a linear model.  Instead of minimising the sum of the squares of the differences between predicted and actual values of the response variables (the OLS method), the elastic net regularization estimation process minimises that sum of those squares <em>and</em> a penalty based on the size of the estimated coefficients (on a standardised scale) in the model.  I like to think of the impact of this as to create an increased burden of proof on the data for including a variable’s effect in the model; the estimation process drags coefficients towards zero in a spirit of conservatism.  The <code class="highlighter-rouge">alpha</code> hyperparameter controls the <em>balance</em> between the different penalty methods of ridge and lasso.  A second hyperparameter, <code class="highlighter-rouge">lambda</code> sets the total <em>weight</em> of the penalty, and can also be set at the most effective level by trying different values with cross validation.</p>

<p>While ridge regression has been around for decades and the <a href="http://www.jstor.org/stable/2346178">lasso since the 1990s</a>, the generalisation to elastic net regularations was only <a href="https://web.stanford.edu/~hastie/Papers/B67.2%20(2005)%20301-320%20Zou%20&amp;%20Hastie.pdf">properly elaborated in 2005</a> and software to implement it is fairly new.  The <a href="https://cran.r-project.org/web/packages/glmnet/index.html"><code class="highlighter-rouge">glmnet</code> package in R</a> gives very fast estimation and good cross-validation methods, and scales up well to large and wide datasets.</p>

<h2 id="a-modest-sized-dataset-with-collinearity">A modest sized dataset with collinearity</h2>

<p>To build more familiarity with this tool I grabbed a small dataset of 30 observations from my fitbit tracker.  I originally downloaded the data from the web browser interface in accordance with the <a href="https://help.fitbit.com/articles/en_US/Help_article/1133">fitbit instructions</a>.  For reproducibility I’ve made it <a href="https://raw.githubusercontent.com/ellisp/ellisp.github.io/source/data/fitbit_export_20160806.csv">available to others</a> on the web.</p>

<p>My aim with this data is to reverse engineer the way fitbit estimates calories burned in a day.  I know from <a href="https://help.fitbit.com/articles/en_US/Help_article/1381">their website</a> that this is done based on an estimate of my basal metabolic rate and the activities my tracker records (plus any activities manually logged by me, which is none in my case).</p>

<p>Basal metabolic rate is dependent on my gender, age, height and weight, none of which changed in this thirty day period, so I would expect that component of the calories burnt to be constant over time.  As well as the calories burned per day, the information the fitbit provides on my activities is available in these variables:</p>

<ul>
  <li>steps</li>
  <li>distance (estimated from steps)</li>
  <li>floors (ie of stairs and stair-like equivalents - some of this period I walked up hills in Western Australia’s Stirling Ranges)</li>
  <li>sedentary minutes</li>
  <li>lightly active minutes</li>
  <li>fairly active minutes</li>
  <li>very active minutes</li>
</ul>

<p>Here’s how those seven candidate explanatory variables relate to eachother:</p>

<p><img src="/img/0050-pairs.svg" alt="pairs" /></p>

<p>From this chart we see a few things of interest:</p>

<ul>
  <li><code class="highlighter-rouge">Distance</code> can be calculated almost exactly directly from <code class="highlighter-rouge">Steps</code></li>
  <li>The number of sedentary minutes in a day is inversely related to the other minutes measured - lightly active, fairly active, and very active</li>
</ul>

<p>I wondered if the four minutes measures would be perfectly collinear - there’s a set number of minutes each day after all, so if I know how long I’ve been lightly active, fairly active and very active couldn’t I precisely say that the remaining minutes were sedentary?  A bit of exploration shows that the four “minutes” measures tend to add up to 15 or 16 hours a day, suggesting that sedentary minutes actually means “sedentary but awake minutes”.  So they are not completely collinear because the amount I sleep varies from day to day.</p>

<p>For those who want to follow along in R, here’s how I did that chart with the correlation coefficients in the lower triangle of panels.  This adapts an example from the helpfile for the <code class="highlighter-rouge">pairs()</code> function in base graphics.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">glmnet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">boot</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span><span class="w">

</span><span class="n">fitbit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/ellisp/ellisp.github.io/source/data/fitbit_export_20160806.csv"</span><span class="p">,</span><span class="w"> 
                   </span><span class="n">skip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="w">
      </span><span class="n">Calories.Burned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">Calories.Burned</span><span class="p">)),</span><span class="w">
      </span><span class="n">Steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">Steps</span><span class="p">)),</span><span class="w">
      </span><span class="n">Activity.Calories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">Activity.Calories</span><span class="p">)),</span><span class="w">
      </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%d/%m/%Y"</span><span class="p">)</span><span class="w">
   </span><span class="p">)</span><span class="w">

</span><span class="n">fitbit2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fitbit</span><span class="w">
</span><span class="n">fitbit2</span><span class="o">$</span><span class="n">Activity.Calories</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">fitbit2</span><span class="o">$</span><span class="n">Date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">fitbit2</span><span class="o">$</span><span class="n">Steps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fitbit2</span><span class="o">$</span><span class="n">Steps</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="c1"># so coefficients will be calories per thousand steps, easier to describe
</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w">
</span><span class="c1"># let's look at all the candidate variables
</span><span class="n">panel.cor</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">cex.cor</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p">){</span><span class="w">
  </span><span class="c1"># function for calculating correlation coefficients and using
</span><span class="w">  </span><span class="c1"># as panels in pairs() function.  Taken from ?pairs
</span><span class="w">  </span><span class="n">usr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">par</span><span class="p">(</span><span class="s2">"usr"</span><span class="p">);</span><span class="w"> </span><span class="nf">on.exit</span><span class="p">(</span><span class="n">par</span><span class="p">(</span><span class="n">usr</span><span class="p">))</span><span class="w">
  </span><span class="n">par</span><span class="p">(</span><span class="n">usr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
  </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">cor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w">
  </span><span class="n">txt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="m">0.123456789</span><span class="p">),</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digits</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w">
  </span><span class="n">txt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">txt</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">missing</span><span class="p">(</span><span class="n">cex.cor</span><span class="p">))</span><span class="w"> </span><span class="n">cex.cor</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.8</span><span class="o">/</span><span class="n">strwidth</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span><span class="w">
  </span><span class="n">text</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">txt</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cex.cor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">pairs</span><span class="p">(</span><span class="n">fitbit2</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">],</span><span class="w"> </span><span class="n">lower.panel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">panel.cor</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Pairwise relationships of Fitbit's measured activities"</span><span class="p">)</span></code></pre></figure>

<p>The close relationship between steps and distance (correlation coefficient of 1.00, which means that knowing one you can almost exactly predict the other) isn’t surprising to me because fitbit’s website makes clear it estimates distance based on steps and stride length.  It applies one stride length to convert from steps to distance for walking, and one for running (which it can detect, presumably, from the pace and violence of motion), but I know that I did virtually no running in this period so it’s only converting from steps to walking.  Here’s the distribution of fitbit’s estimated distance divided by steps:</p>

<p><img src="/img/0050-stridelenth.svg" alt="stride" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggplot</span><span class="p">(</span><span class="n">fitbit2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Steps</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
   </span><span class="n">geom_rug</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
   </span><span class="n">geom_density</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Stride length reverse-engineered from Fitbit data"</span><span class="p">,</span><span class="w">
             </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Not all strides identical, due to rounding or other jitter"</span><span class="p">)</span></code></pre></figure>

<h2 id="calories-per-1000-steps-on-average">69 calories per 1,000 steps on average</h2>

<p>To get a sense of the data I was interested in a super-simple model with a single explanatory variable.  “What’s the relationship between the number of steps walked and calories burned, ignoring height gains and intensity of heart rate”, I asked myself?  Judging from various sites like <a href="http://www.livestrong.com/article/320124-how-many-calories-does-the-average-person-use-per-step/">this</a> and <a href="http://www.livestrong.com/article/238020-how-to-convert-pedometer-steps-to-calories/">this</a> the answer might be about 40-50 calories per thousand steps for walking.  Fitbit would use a more sophisticated model than this and take into account the fact that some of my walking was on tougher terrain and/or up stairs or slopes which would reflect in increased heart rate, so it will be interesting to see its estimates of calories per thousand steps compared to the simple website estimates.</p>

<p>The way to do this is just an ordinary least squares estimation of a model with steps as the sole explanatory variable and calories burned as the response variable.  This returns the estimate of my base daily rate of 1,926 calories per day, and 69 additional calories burned per thousand steps.  This figure of 69 is more than the “moderate walking” rates on various websites, presumably because of the terrain and slope issues mentioned above.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">mod0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">Calories.Burned</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Steps</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fitbit2</span><span class="p">)</span><span class="w">
</span><span class="nf">round</span><span class="p">(</span><span class="n">coef</span><span class="p">(</span><span class="n">mod0</span><span class="p">))</span><span class="w">
</span><span class="c1">## (Intercept)       Steps 
</span><span class="err">##</span><span class="w">       </span><span class="m">1926</span><span class="w">          </span><span class="m">69</span><span class="w"> </span></code></pre></figure>

<p>That figure of 1,926 per day as my “no steps” base calory burn is also somewhat more than the 1,629 that <a href="http://www.bodybuilding.com/fun/bmr_calculator.htm">this website</a> says should be my basal metabolic rate based on the Harris-Benedict equation.  I’m not sure what’s going on here - either fitbit uses a different calculation, or perhaps it’s judging various activities from me from my heart rate that don’t feature in steps, or something else.  Fitbit doesn’t know my real calory burn rates, so it can’t be something mysterious to do with my metabolism as it has no way of knowing, it just estimates based on steps, heart rate, weight, height, etc.  Anyway, the simple model above isn’t too bad an estimate of how many calories fitbit <em>says</em> I use; for the record, here’s a comparison of the predicted calories compared to residuals from that model:</p>

<p><img src="/img/0050-1var-resid.svg" alt="residuals" /></p>

<p>And just to put one issue to rest, here’s the partial autocorrelation function of the residuals, showing that there’s no particular pattern over time not captured in the model.  This is not a particularly interesting chart but I’m including it because it should be standard practice to check for such patterns (which would be shown by one of the vertical bars crossing the horizontal blue lines) when working with data that was captured over a time period.</p>

<p><img src="/img/0050-1var-resid-pacf.svg" alt="pacf" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># check residuals v. fit
</span><span class="n">plot</span><span class="p">(</span><span class="n">mod0</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">bty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">);</span><span class="w"> </span><span class="n">grid</span><span class="p">()</span><span class="w">

</span><span class="c1"># check autocorrelation:
</span><span class="n">pacf</span><span class="p">(</span><span class="n">resid</span><span class="p">(</span><span class="n">mod0</span><span class="p">),</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Partial autocorrelation of residuals from single variable regression"</span><span class="p">)</span></code></pre></figure>

<h2 id="choose-alpha-by-cross-validation-over-a-grid-of-candidate-values">Choose alpha by cross-validation over a grid of candidate values</h2>

<p>Now I’m ready to move to my full model, predicting daily calories based on all the seven explanatory variables available.</p>

<p>The first step is choosing an appropriate alpha - the balance between the extremes of ridge regression and lasso estimation.  I choose repeated cross-validation to do this.  Basically this means fitting the model to slightly different re-samples many times at different values of alpha, using the fit model to predict the “out of bag” points from the original sample that weren’t in the re-sample.  The results show only a weak impact of the choice of alpha:</p>

<p><img src="/img/0050-cv-alpha.svg" alt="alphas" /></p>

<p>Here’s the code that did this.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># create X matrix and Y vector for use with glmnet, which doesn't take Rmodel formulae
# First column of fitbit2 is the response variable "Calories burned" so we exclude from X:
</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">fitbit2</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">])</span><span class="w"> </span><span class="c1"># standardisation happens as part of glmnet
</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fitbit2</span><span class="o">$</span><span class="n">Calories.Burned</span><span class="w">

</span><span class="n">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span><span class="w">
</span><span class="n">alphas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">alphas</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="c1"># five columns for results - five repeats of each CV run
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">alphas</span><span class="p">)){</span><span class="w">
   </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span><span class="o">:</span><span class="m">6</span><span class="p">){</span><span class="w">
      </span><span class="n">cvmod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cv.glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
      </span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">cvmod</span><span class="o">$</span><span class="n">cvm</span><span class="p">)))</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w">
</span><span class="n">res</span><span class="o">$</span><span class="n">average_rmse</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="o">:</span><span class="m">6</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w">
</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">res</span><span class="o">$</span><span class="n">average_rmse</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"alpha"</span><span class="w">

</span><span class="n">res</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">average_rmse</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">gather</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span><span class="w"> </span><span class="n">rmse</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rmse</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Root mean square error"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Cross validation best RMSE for differing values of alpha"</span><span class="p">)</span><span class="w">

</span><span class="c1"># best alpha varies according to the random seed set earlier but with seed 123 it is 0.667
</span><span class="n">bestalpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span></code></pre></figure>

<h2 id="elastic-net-gives-more-sensible-results-in-presence-of-collinearity">Elastic net gives more sensible results in presence of collinearity</h2>

<p>Now that I have a preferred value of alpha I can use the elastic net to get estimated values of the eight coefficients (seven explanatory variables plus an intercept), and compare them to the ordinary least squares equivalents.  Remember that there’s a second hyper-parameter, <code class="highlighter-rouge">lambda</code> to estimate too - again I choose this from cross-validation with the chosen value of <code class="highlighter-rouge">alpha</code>, and following the implied suggesting on the <code class="highlighter-rouge">glmnet</code> package I try two versions of <code class="highlighter-rouge">lambda</code> - the level of shrinkage that gives the smallest errors in cross validation, and the higher level of shrinkage that gets acceptable close (within one standard deviation in the cross validation process) to that smallest error.  This practice is predicated on the idea that a model with a higher degree of shrinkage may be cheaper (in data management or interpretation) than a lower, so it is worth taking a small hit of accuracy for it.</p>

<p>Here are the results from the three estimation methods:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="w">                       </span><span class="n">original</span><span class="w">   </span><span class="n">shrunk</span><span class="w"> </span><span class="n">very.shrunk</span><span class="w">
</span><span class="p">(</span><span class="n">Intercept</span><span class="p">)</span><span class="w">            </span><span class="m">1941.189</span><span class="w"> </span><span class="m">1971.199</span><span class="w">    </span><span class="m">2157.172</span><span class="w">
</span><span class="n">Steps</span><span class="w">                   </span><span class="m">-66.827</span><span class="w">    </span><span class="m">9.176</span><span class="w">      </span><span class="m">15.703</span><span class="w">
</span><span class="n">Distance</span><span class="w">                </span><span class="m">116.077</span><span class="w">   </span><span class="m">15.045</span><span class="w">      </span><span class="m">21.835</span><span class="w">
</span><span class="n">Floors</span><span class="w">                    </span><span class="m">0.027</span><span class="w">    </span><span class="m">0.000</span><span class="w">       </span><span class="m">0.000</span><span class="w">
</span><span class="n">Minutes.Sedentary</span><span class="w">        </span><span class="m">-0.246</span><span class="w">   </span><span class="m">-0.236</span><span class="w">      </span><span class="m">-0.187</span><span class="w">
</span><span class="n">Minutes.Lightly.Active</span><span class="w">    </span><span class="m">2.247</span><span class="w">    </span><span class="m">1.985</span><span class="w">       </span><span class="m">0.888</span><span class="w">
</span><span class="n">Minutes.Fairly.Active</span><span class="w">     </span><span class="m">4.402</span><span class="w">    </span><span class="m">4.384</span><span class="w">       </span><span class="m">3.842</span><span class="w">
</span><span class="n">Minutes.Very.Active</span><span class="w">       </span><span class="m">3.895</span><span class="w">    </span><span class="m">3.295</span><span class="w">       </span><span class="m">1.019</span></code></pre></figure>

<p>As experienced modellers would have expected, the “original” (ie ordinary least squares) method gives non-sensible estimates of the coefficients of the two highly collinear variabls, <code class="highlighter-rouge">Steps</code> and <code class="highlighter-rouge">Distance</code>.  it clearly makes no sense to say that my calories consumed go <em>down</em> by 67 for each additional 1,000 steps but <em>up</em> by 116 for each kilometre.  The elastic net method also struggles with these two, but returns values that are better for interpretation.</p>

<p>Here’s the code for obtaining those coefficient estimates:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Cross-validated version to determine lambda at best value of alpha, for use later
</span><span class="n">cvmod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cv.glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestalpha</span><span class="p">)</span><span class="w">

</span><span class="c1"># the model itself
</span><span class="n">mod1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestalpha</span><span class="p">)</span><span class="w">

</span><span class="c1"># the OLS model
</span><span class="n">mod2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">Calories.Burned</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fitbit2</span><span class="p">)</span><span class="w">

</span><span class="n">coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">mod2</span><span class="p">),</span><span class="w"> 
                  </span><span class="n">shrunk</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">as.vector</span><span class="p">(</span><span class="n">coef</span><span class="p">(</span><span class="n">mod1</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvmod</span><span class="o">$</span><span class="n">lambda.min</span><span class="p">)),</span><span class="w">
                  </span><span class="n">very.shrunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.vector</span><span class="p">(</span><span class="n">coef</span><span class="p">(</span><span class="n">mod1</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvmod</span><span class="o">$</span><span class="n">lambda.1se</span><span class="p">)))</span><span class="w">

</span><span class="nf">round</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span></code></pre></figure>

<h2 id="even-with-lambda0-elastic-net-gives-different-result-to-ols-due-to-numerical-calculation-issues">Even with <code class="highlighter-rouge">lambda=0</code>, elastic net gives different result to OLS due to numerical calculation issues</h2>

<p>I thought I would check what happens if lambda is set to zero so there is no penalty for the total size of coefficients.  In theory, the result should be the same as the ordinary least squares estimate, but in the presence of severe collinearity like we have here (between <code class="highlighter-rouge">Steps</code> and <code class="highlighter-rouge">Distance</code>) this turns out not to be the case.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="n">mod3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="s2">"elastic, lambda = 0"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.vector</span><span class="p">(</span><span class="n">coef</span><span class="p">(</span><span class="n">mod3</span><span class="p">)),</span><span class="w"> </span><span class="s2">"lm"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">mod2</span><span class="p">),</span><span class="w"> </span><span class="n">check.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">),</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
                       </span><span class="n">elastic</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">       </span><span class="n">lm</span><span class="w">
</span><span class="p">(</span><span class="n">Intercept</span><span class="p">)</span><span class="w">                       </span><span class="m">1937.924</span><span class="w"> </span><span class="m">1941.189</span><span class="w">
</span><span class="n">Steps</span><span class="w">                               </span><span class="m">15.455</span><span class="w">  </span><span class="m">-66.827</span><span class="w">
</span><span class="n">Distance</span><span class="w">                             </span><span class="m">0.653</span><span class="w">  </span><span class="m">116.077</span><span class="w">
</span><span class="n">Floors</span><span class="w">                               </span><span class="m">0.011</span><span class="w">    </span><span class="m">0.027</span><span class="w">
</span><span class="n">Minutes.Sedentary</span><span class="w">                   </span><span class="m">-0.241</span><span class="w">   </span><span class="m">-0.246</span><span class="w">
</span><span class="n">Minutes.Lightly.Active</span><span class="w">               </span><span class="m">2.236</span><span class="w">    </span><span class="m">2.247</span><span class="w">
</span><span class="n">Minutes.Fairly.Active</span><span class="w">                </span><span class="m">4.415</span><span class="w">    </span><span class="m">4.402</span><span class="w">
</span><span class="n">Minutes.Very.Active</span><span class="w">                  </span><span class="m">3.894</span><span class="w">    </span><span class="m">3.895</span></code></pre></figure>

<p>This comes about from numerical issues to do with the estimation method under the hood in <code class="highlighter-rouge">glmnet</code> and I won’t try to understand or explain exactly why.  If we remove the severe collinearity (which, in a real life situation, I would have done as the very first step when I realised <code class="highlighter-rouge">Distance</code> contains no real information additional to <code class="highlighter-rouge">Steps</code>) the estimated coefficients are almost identical, as they should be:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="c1"># what about a simpler case with less numerical instability - 
</span><span class="o">&gt;</span><span class="w"> </span><span class="c1"># drop "distance" (which is the second column)
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mod4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-2</span><span class="p">],</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mod5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">Y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-2</span><span class="p">])</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="s2">"elastic, lambda = 0"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.vector</span><span class="p">(</span><span class="n">coef</span><span class="p">(</span><span class="n">mod4</span><span class="p">)),</span><span class="w"> </span><span class="s2">"lm"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">mod5</span><span class="p">),</span><span class="w"> </span><span class="n">check.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">),</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
                       </span><span class="n">elastic</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w">       </span><span class="n">lm</span><span class="w">
</span><span class="p">(</span><span class="n">Intercept</span><span class="p">)</span><span class="w">                       </span><span class="m">1938.103</span><span class="w"> </span><span class="m">1938.129</span><span class="w">
</span><span class="n">Steps</span><span class="w">                               </span><span class="m">15.885</span><span class="w">   </span><span class="m">15.798</span><span class="w">
</span><span class="n">Floors</span><span class="w">                               </span><span class="m">0.011</span><span class="w">    </span><span class="m">0.010</span><span class="w">
</span><span class="n">Minutes.Sedentary</span><span class="w">                   </span><span class="m">-0.241</span><span class="w">   </span><span class="m">-0.241</span><span class="w">
</span><span class="n">Minutes.Lightly.Active</span><span class="w">               </span><span class="m">2.236</span><span class="w">    </span><span class="m">2.239</span><span class="w">
</span><span class="n">Minutes.Fairly.Active</span><span class="w">                </span><span class="m">4.415</span><span class="w">    </span><span class="m">4.413</span><span class="w">
</span><span class="n">Minutes.Very.Active</span><span class="w">                  </span><span class="m">3.897</span><span class="w">    </span><span class="m">3.906</span></code></pre></figure>

<h2 id="in-this-particular-dataset-predictive-power-is-similar-in-ols-and-after-elastic-net-regularisation">In this particular dataset, predictive power is similar in OLS and after elastic net regularisation</h2>

<p>To compare the predictive strength of these different models I used the simple bootstrap, where the modelling approach is applied to bootstrap resamples of the data and the estimated model then used to predict the full original dataset.  The elastic net regularized model slightly out-performs the ordinary least squares model with all variables; both significantly out-perform the super-simple one variable model with only <code class="highlighter-rouge">Steps</code> in the explanatory side of the formula.  Here are the root mean square errors of the three different estimation methods:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="w">  </span><span class="n">elastic</span><span class="w"> </span><span class="n">lm_allvar</span><span class="w">   </span><span class="n">lm_1var</span><span class="w"> 
     </span><span class="m">95.7</span><span class="w">      </span><span class="m">99.5</span><span class="w">     </span><span class="m">165.0</span><span class="w"> </span></code></pre></figure>

<p>Code for the validation process:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#----------------validation--------
# function to feed to boot that does elastic modelling
</span><span class="n">mod1f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">){</span><span class="w">
   </span><span class="n">X</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">])</span><span class="w">
   </span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w">
   </span><span class="n">cvmod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cv.glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nfolds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w">
   </span><span class="n">mod1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
   </span><span class="n">RMSE</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">mod1</span><span class="p">,</span><span class="w"> </span><span class="n">newx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">]),</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvmod</span><span class="o">$</span><span class="n">lambda.min</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">elastic_boot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">boot</span><span class="p">(</span><span class="n">fitbit2</span><span class="p">,</span><span class="w"> </span><span class="n">statistic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod1f</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">99</span><span class="p">)</span><span class="w">


</span><span class="c1"># function to feed to boot that does OLS modelling
</span><span class="n">mod2f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">){</span><span class="w">
   </span><span class="n">mod2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">Calories.Burned</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w">
   </span><span class="n">RMSE</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">mod2</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">lm_boot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">boot</span><span class="p">(</span><span class="n">fitbit2</span><span class="p">,</span><span class="w"> </span><span class="n">statistic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod2f</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">99</span><span class="p">)</span><span class="w">

</span><span class="c1"># for boot with OLS modelling, only one explanatory variable
</span><span class="n">mod0f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">){</span><span class="w">
   </span><span class="n">mod0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">Calories.Burned</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Steps</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w">
   </span><span class="n">RMSE</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">mod0</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">lm0_boot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">boot</span><span class="p">(</span><span class="n">fitbit2</span><span class="p">,</span><span class="w"> </span><span class="n">statistic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod0f</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">99</span><span class="p">)</span><span class="w">

</span><span class="nf">round</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"elastic"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">elastic_boot</span><span class="o">$</span><span class="n">t</span><span class="p">),</span><span class="w"> 
        </span><span class="s2">"lm_allvar"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">lm_boot</span><span class="o">$</span><span class="n">t</span><span class="p">),</span><span class="w">
        </span><span class="s2">"lm_1var"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">lm0_boot</span><span class="o">$</span><span class="n">t</span><span class="p">)),</span><span class="w"> </span><span class="m">1</span><span class="p">)</span></code></pre></figure>

<h2 id="floors-not-needed-for-a-good-prediction-of-calories">“Floors” not needed for a good prediction of calories</h2>

<p>One substantive issue of interest to me that I haven’t mentioned was the relationship of “floors climbed” to total calories.  This is of interest because it’s the sort of thing that it’s easy to set a personal target for (“steps” is similar).  However, none of the estimation methods showed significant evidence of <code class="highlighter-rouge">Floors</code> as an explanatory variable.  Basically, the “minutes active” variables (at various levels of intensity) contains all the information needed by fitbit to make its estimates of calories.  Walking up stairs contributes to more active minutes as shown by heart rate but other than through that is not directly informative itself.</p>

<p>This can be illustrated by what has become one of the standard plots for this sort of estimation method - a graphic illustration of how the size of coefficients for different variables increase as the penalty against coefficients is relaxed:</p>

<p><img src="/img/0050-elastic-coefs.svg" alt="variables" /></p>

<p>We see from this that even the fullest model leaves a zero coefficient for variable #3, <code class="highlighter-rouge">Floors</code> - the horizontal green line.  <code class="highlighter-rouge">Minutes.Very.Active</code> is the second last variable to be allowed to increase from zero - it contains relatively little information after all the other “minutes” variables are included.</p>

<p>Code for that graphic:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># refit the model with scaled variables just for the graphic.
# working with scaled variables just for visual distinguishing
# shouldn't make a difference as under the hood glmnet does it anyway
# in the models fit earlier.
</span><span class="n">mod1s</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glmnet</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bestalpha</span><span class="p">)</span><span class="w">

</span><span class="c1"># set a palette
</span><span class="n">thepal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">brewer.pal</span><span class="p">(</span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="s2">"Set1"</span><span class="p">)</span><span class="w">

</span><span class="c1"># set the ordering for ease of reading on graphic
</span><span class="n">ordering</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">7</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">)</span><span class="w">

</span><span class="n">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5.1</span><span class="p">,</span><span class="w"> </span><span class="m">4.1</span><span class="p">,</span><span class="w"> </span><span class="m">6.5</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey90"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">mod1s</span><span class="p">,</span><span class="w"> </span><span class="n">xvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dev"</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thepal</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> 
        </span><span class="s2">"Increasing contribution of different explanatory variables\nas penalty for including them is relaxed"</span><span class="p">)</span><span class="w">

</span><span class="n">legend</span><span class="p">(</span><span class="s2">"topleft"</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="n">ordering</span><span class="p">],</span><span class="w"> </span><span class="n">text.col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thepal</span><span class="p">[</span><span class="n">ordering</span><span class="p">],</span><span class="w"> 
       </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">bty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"n"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thepal</span><span class="p">[</span><span class="n">ordering</span><span class="p">])</span></code></pre></figure>



</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2016/08/13/fitbit-lasso">
        <p>&larr; Older</p>
        <p>Elastic net regularization of a model of burned calories</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
			
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

			<div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="true" data-share="false"></div>
			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			
			

			</footer>
    </div>



  
</body>
</html>
   




         
