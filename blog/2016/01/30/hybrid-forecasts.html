      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Better prediction intervals for time series forecasts</title>
      	
         
         
            <meta name ="description" content ="Hybrid forecasts - averages of single-model forecasts - are commonly used to produce point estimates that are better than any of the contributing forecast models.  I show how prediction intervals can be constructed for a hybrid forecast that have more accurate coverage than most commonly used prediction intervals (ie 80% of actual observations do indeed turn out to be within the 80% confidence interval), tested on the 3,003 M3 forecasting competition datasets.">
            <meta property="og:description" content ="Hybrid forecasts - averages of single-model forecasts - are commonly used to produce point estimates that are better than any of the contributing forecast models.  I show how prediction intervals can be constructed for a hybrid forecast that have more accurate coverage than most commonly used prediction intervals (ie 80% of actual observations do indeed turn out to be within the 80% confidence interval), tested on the 3,003 M3 forecasting competition datasets.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Better prediction intervals for time series forecasts" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0028-USAccDeaths.png" />
         
		 
			<meta property="og:url" content="http://ellisp.github.io/blog/2016/01/30/hybrid-forecasts.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">     
		<link href="/css/syntax.css" rel ="stylesheet">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2017/06/17/microdata-access>Most recent post</a></li>
				  <li><a href="/blog/nz.html">All blog posts with data about New Zealand</a></li>
				  <li><a href="/blog/voting.html">All blog posts on voting behaviour</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
              <li><a href="/presentations/index.html">Presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">NZ Election forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/elections/elections.html">Forecasts summary</a></li>
				  <li><a href="https://ellisp.shinyapps.io/nz-election-2017/">Explore coalitions and assumptions</a></li>
                  <li><a href="/elections/changelog.html">Log of changes to forecasts</a></li>
				  <li><a href="/blog/voting.html">All blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Better prediction intervals for time series forecasts</h1>
         <p class="meta">30 Jan 2016</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>At a glance:</h2>
   Hybrid forecasts - averages of single-model forecasts - are commonly used to produce point estimates that are better than any of the contributing forecast models.  I show how prediction intervals can be constructed for a hybrid forecast that have more accurate coverage than most commonly used prediction intervals (ie 80% of actual observations do indeed turn out to be within the 80% confidence interval), tested on the 3,003 M3 forecasting competition datasets.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="forecast-combination">Forecast Combination</h2>
<p>I’ve referred several times to <a href="http://robjhyndman.com/hyndsight/show-me-the-evidence/">this blog post by Rob Hyndman</a> in which he shows that a simple averaging of the <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code> functions in his <code class="highlighter-rouge">forecast</code> R package not only out-performs <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code> individually (in the long run, not every time), they outperform nearly every method that was entered in the <a href="https://forecasters.org/resources/time-series-data/m3-competition/">M3 competition</a> in the year 2000.  This is a good example of a well known part of the forecasting craft, that a “Forecast Combination” of models will produce results closer to reality than its individual component models do.</p>

<p>In an <a href="/blog/2015/12/21/m3-and-x13.html">earlier post</a>, I showed that adding X13-SEATS to the combination further improves the forecast, reaching a point where the Mean Absolute Scaled Error (compared to the actual observations once made available) for the ets-auto.arima-SEATS combination is lower even than the competition’s top ranking Theta method.</p>

<h2 id="prediction-intervals">Prediction intervals</h2>
<p>A question for the forecaster is what prediction interval to use in a forecast combination.  A prediction interval is a similar but not identical concept to a confidence interval.  A prediction interval is an estimate of a value (or rather, the range of likely values) that isn’t yet known but is going to be observed at some point in the future.  Whereas a confidence interval is an estimate of the likely range of values for a fundamentally unobserveable parameter.  A prediction interval needs to take into account uncertainty in the model, uncertain estimates of the parameters in a model (ie the confidence intervals for those parameters), and also the individual randomness associated with the particular point or points being predicted.</p>

<p>Prediction intervals for forecasts are well known to be <a href="http://robjhyndman.com/hyndsight/narrow-pi/">usually too narrow</a>.  For example, one study found prediction intervals calculated to include the true results 95% of the time only get it right between 71% and 87% of the time (thanks to Hyndman again for making that result easily available on his blog).  There are a number of contributing reasons but the main one is that the uncertainty in the model building and selection process is not adequately taken into account.  Most methods of developing prediction intervals are in effect estimating a range of values conditional on the model being correct in the first place.  As our models are only simplifications of reality we fail more often than we would if the model were exactly right.</p>

<p>On a cursory glance, I couldn’t find much discussion of how to produce a prediction interval from a forecast combination.  Hyndman avoids referring the issue in the first post linked to above by making claims only about point estimates “If you only want point forecasts, that (average of <code class="highlighter-rouge">ets</code> and <code class="highlighter-rouge">auto.arima</code>) is the best approach available in the <code class="highlighter-rouge">forecast</code> package.”  <a href="http://repository.upenn.edu/cgi/viewcontent.cgi?article=1005&amp;context=marketing_papers">One paper I found</a> makes the common sense suggestion of taking averages of the prediction intervals from the component models.  But if the original prediction intervals are too narrow, is averaging them going to help?</p>

<p>Forecasting makes me nervous, and in my day job when the reality is noticeably different from the forecast points it causes problems.  I’d like there to be much more focus on the range of prediction intervals in communicating forecasts, and I’d like that range to be accurate or if anything slightly conservative (eg I’d be happier for 83% of observations to come inside my 80% prediction interval than for 77%).</p>

<h2 id="introducing-hybridf">Introducing hybridf()</h2>
<p>I like combining <code class="highlighter-rouge">auto.arima()</code> and <code class="highlighter-rouge">ets()</code> for a quick, effective hybrid forecast that is probably as good as can be hoped for with a univariate series.  In fact, it’s the sort of thing that could easily be done thousands of times in a day so to make it more convenient I created a function <code class="highlighter-rouge">hybridf()</code> that does this for me in R and produces an object of class <code class="highlighter-rouge">forecast</code>.  This means that I can fit a forecast with one line of code and that other functionality Hyndman developed for that class, like the standard forecast plot, can be used on the resulting object.  Here it is in action with the monthly time series of accidental deaths in the USA from 1973 to 1978, used in Brockwell and Davis’ 1991 <i>Time Series: Theory and Methods</i> and one of R’s in-built datasets.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">devtools</span><span class="p">)</span><span class="w">
</span><span class="n">install_github</span><span class="p">(</span><span class="s2">"robjhyndman/forecast"</span><span class="p">)</span><span class="w"> </span><span class="c1"># development version needed sorry
</span><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">

</span><span class="n">source</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/ellisp/forecast/dev/R/hybridf.R"</span><span class="p">)</span><span class="w">

</span><span class="n">fc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">hybridf</span><span class="p">(</span><span class="n">USAccDeaths</span><span class="p">)</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">bty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">fc</span><span class="o">$</span><span class="n">fc_ets</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">fc</span><span class="o">$</span><span class="n">fc_aa</span><span class="p">)</span></code></pre></figure>

<p><img src="/img/0028-USAccDeaths.svg" alt="USAccDeaths" /></p>

<p>The dark grey areas are 80% prediction intervals and the light grey the 95% prediction interval.  The top panel shows the hybrid forecast.  The dark blue line is just the average of the point forecasts of the other two methods, and the prediction interval takes the conservative view of showing the widest range of values of combining the two.  So the hybrid prediction interval will be wider than the prediction intervals for either of the contributing models.</p>

<h2 id="testing-against-the-m3-competition-series">Testing against the M3 competition series</h2>
<p>In these days of easy access to computers and to data, we don’t have to just theorise about the success rates of different prediction intervals, we can test methods against actual data.  I used the 3,003 <a href="https://forecasters.org/resources/time-series-data/m3-competition/">M3 competition datasets</a> to compare the 80% and 95% prediction intervals generated by <code class="highlighter-rouge">ets()</code>, <code class="highlighter-rouge">auto.arima()</code>, and my <code class="highlighter-rouge">hybridf()</code>.  After fitting the models on the given historical data and producing forecasts of the desired length, I counted how many of the actual results were in the prediction intervals.  Here’s the results:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">variable</th>
      <th style="text-align: right">Success</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ets_p80</td>
      <td style="text-align: right">0.75</td>
    </tr>
    <tr>
      <td style="text-align: left">ets_p95</td>
      <td style="text-align: right">0.90</td>
    </tr>
    <tr>
      <td style="text-align: left">auto.arima_p80</td>
      <td style="text-align: right">0.74</td>
    </tr>
    <tr>
      <td style="text-align: left">auto.arima_p95</td>
      <td style="text-align: right">0.88</td>
    </tr>
    <tr>
      <td style="text-align: left">hybrid_p80</td>
      <td style="text-align: right">0.83</td>
    </tr>
    <tr>
      <td style="text-align: left">hybrid_p95</td>
      <td style="text-align: right">0.94</td>
    </tr>
  </tbody>
</table>

<p>My hybrid method has prediction intervals that succeed at close to the advertised rates, whereas both <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code> are less successful.  For example, the hybrid 80% prediction interval contains the actual results 83% of the time, and the 95% prediction interval has the actual result 94% of the time; whereas for auto.arima the success rates are 74% and 88% respectively.</p>

<p>Here’s how I tested that on the M3 data.  I build a little function <code class="highlighter-rouge">pi_accuracy()</code> to help, which makes use of the fact that objects of class forecast return a matrix called “lower” and another called “upper”, with a column for each prediction interval level.  As this is only a temporary function for this blog, I leave it so it only works with the default values of forecast objects producing 80% and 95% intervals:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#------------------setup------------------------
</span><span class="n">library</span><span class="p">(</span><span class="n">showtext</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">Mcomp</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">

</span><span class="n">source</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/ellisp/forecast/dev/R/hybridf.R"</span><span class="p">)</span><span class="w">

</span><span class="n">font.add.google</span><span class="p">(</span><span class="s2">"Poppins"</span><span class="p">,</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w">
</span><span class="n">showtext.auto</span><span class="p">()</span><span class="w">
</span><span class="n">theme_set</span><span class="p">(</span><span class="n">theme_light</span><span class="p">(</span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">))</span><span class="w">

</span><span class="n">pi_accuracy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="w"> </span><span class="n">yobs</span><span class="p">){</span><span class="w">
   </span><span class="c1"># checks the success of prediction intervals of an object of class 
</span><span class="w">   </span><span class="c1"># forecast with actual values
</span><span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">yobs</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">fc</span><span class="o">$</span><span class="n">mean</span><span class="p">)){</span><span class="w">
      </span><span class="n">stop</span><span class="p">(</span><span class="s2">"yobs needs to be the same length as the forecast period."</span><span class="p">)</span><span class="w">
   </span><span class="p">}</span><span class="w">
   </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">yobs</span><span class="p">)</span><span class="w">
   </span><span class="n">yobsm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">yobs</span><span class="p">,</span><span class="w"> </span><span class="n">yobs</span><span class="p">)</span><span class="w">
   </span><span class="n">In</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">yobsm</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">fc</span><span class="o">$</span><span class="n">lower</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">yobsm</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fc</span><span class="o">$</span><span class="n">upper</span><span class="p">)</span><span class="w"> 
   </span><span class="n">colnames</span><span class="p">(</span><span class="n">In</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Series 1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Series 2"</span><span class="p">)</span><span class="w">
   </span><span class="n">Success</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colMeans</span><span class="p">(</span><span class="n">In</span><span class="p">)</span><span class="w">
   </span><span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">In</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">In</span><span class="p">,</span><span class="w"> </span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Success</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w">
 </span><span class="p">}</span></code></pre></figure>

<p>Actually fitting all the forecasts is relatively straightforward.  It took about an hour on my laptop.  As the <code class="highlighter-rouge">hybridf()</code> function returns an object that provides the underlying <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code> objects, they don’t need to be refitted and there’s some modest efficiency.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#============forecasting with default values===============
</span><span class="n">num_series</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">M</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="c1"># ie 3003
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_series</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">)</span><span class="w">

</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">num_series</span><span class="p">){</span><span class="w">
   </span><span class="n">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">)</span><span class="w">        </span><span class="c1"># let me know how it's going as it loops through...
</span><span class="w">   </span><span class="n">series</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">M</span><span class="m">3</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w">
   </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">series</span><span class="o">$</span><span class="n">x</span><span class="w">      </span><span class="c1"># ie the data to be fitted
</span><span class="w">   </span><span class="n">xx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">series</span><span class="o">$</span><span class="n">xx</span><span class="w">    </span><span class="c1"># ie the true, actual values of the forecast period
</span><span class="w">   </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="w">    </span><span class="c1"># ie the length of the forecast period
</span><span class="w">   
   </span><span class="n">fc3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">hybridf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w">
   </span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pi_accuracy</span><span class="p">(</span><span class="n">fc3</span><span class="p">,</span><span class="w"> </span><span class="n">xx</span><span class="p">)</span><span class="o">$</span><span class="n">Success</span><span class="w">
   
   </span><span class="n">fc1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fc3</span><span class="o">$</span><span class="n">fc_ets</span><span class="w">
   </span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pi_accuracy</span><span class="p">(</span><span class="n">fc1</span><span class="p">,</span><span class="w"> </span><span class="n">xx</span><span class="p">)</span><span class="o">$</span><span class="n">Success</span><span class="w">
   
   </span><span class="n">fc2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fc3</span><span class="o">$</span><span class="n">fc_aa</span><span class="w">
   </span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="o">:</span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pi_accuracy</span><span class="p">(</span><span class="n">fc2</span><span class="p">,</span><span class="w"> </span><span class="n">xx</span><span class="p">)</span><span class="o">$</span><span class="n">Success</span><span class="w">
   
   </span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="w">

</span><span class="nf">names</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ets_p80"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ets_p95"</span><span class="p">,</span><span class="w"> </span><span class="s2">"auto.arima_p80"</span><span class="p">,</span><span class="w"> </span><span class="s2">"auto.arima_p95"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"hybrid_p80"</span><span class="p">,</span><span class="w"> </span><span class="s2">"hybrid_p95"</span><span class="p">,</span><span class="w"> </span><span class="s2">"h"</span><span class="p">)</span><span class="w">

</span><span class="c1"># The results are saved as percentages that were in the intervals,
# and the forecast lengths are different, so we need to weight by
# forecast length (h) to get the actual total percentage of observations
# that were within prediction interval.  This code produces the table
# reproduced in the blog post above:                    
</span><span class="n">results</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
   </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">weighted_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">weighted_value</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">

</span><span class="n">results</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">Level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"p80"</span><span class="p">,</span><span class="w"> </span><span class="n">variable</span><span class="p">),</span><span class="w"> </span><span class="s2">"80%"</span><span class="p">,</span><span class="w"> </span><span class="s2">"95%"</span><span class="p">),</span><span class="w">
          </span><span class="n">Level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">Level</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"95%"</span><span class="p">,</span><span class="w"> </span><span class="s2">"80%"</span><span class="p">)),</span><span class="w">
          </span><span class="n">variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"_p[0-9]."</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">variable</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Level</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">Level</span><span class="o">~</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Percentage of actual results within forecast prediction interval\n"</span><span class="p">,</span><span class="w">
                      </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">.25</span><span class="p">,</span><span class="w"> </span><span class="m">.5</span><span class="p">,</span><span class="w"> </span><span class="m">.75</span><span class="p">,</span><span class="w"> </span><span class="m">.8</span><span class="p">,</span><span class="w"> </span><span class="m">.95</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Forecast period"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Desired level"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Prediction interval success for three forecasting methods on 3003 M3 timeseries"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_jitter</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.3</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lm"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span></code></pre></figure>

<p><img src="/img/0028-indiv-error.svg" alt="image" /></p>

<p>An interesting pattern emerges when we look at the success rates of individual forecasts, as in the image above.  A small collection of unfortunates have 0% of the actual data within the prediction interval - things went wrong and stayed wrong.  Generally, the longer the forecast period, the higher the accuracy rate of the prediction intervals.  Prediction intervals get wider as they forecast further periods out; and the randomness that is explicitly included in the intervals this way starts to dominate over the sunk cost inaccuracy of having a wrong model in the first place.  For longer forecast periods, the standard prediction intervals tend towards performing as advertised, whereas for shorter forecast periods they are over-optimistic.</p>

<h2 id="bootstrapping">Bootstrapping</h2>
<p>The forecast methods for both <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code> have the option to estimate prediction intervals by simulation and bootstrapping residuals rather than analytically, and those methods are inherited by my <code class="highlighter-rouge">hybridf()</code>.  I checked the value of these prediction intervals too.  The results are very similar to the non-bootstrap results; if anything, the prediction intervals based on bootstrap and simulation are slightly less accurate, but the difference is nothing to write home about.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">variable</th>
      <th style="text-align: right">Success</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ets_p80</td>
      <td style="text-align: right">0.72</td>
    </tr>
    <tr>
      <td style="text-align: left">ets_p95</td>
      <td style="text-align: right">0.88</td>
    </tr>
    <tr>
      <td style="text-align: left">auto.arima_p80</td>
      <td style="text-align: right">0.70</td>
    </tr>
    <tr>
      <td style="text-align: left">auto.arima_p95</td>
      <td style="text-align: right">0.86</td>
    </tr>
    <tr>
      <td style="text-align: left">hybrid_p80</td>
      <td style="text-align: right">0.80</td>
    </tr>
    <tr>
      <td style="text-align: left">hybrid_p95</td>
      <td style="text-align: right">0.92</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#=====with bootstrapping instead of formulae for the prediction intervals=============
</span><span class="w">
</span><span class="n">num_series</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">M</span><span class="m">3</span><span class="p">)</span><span class="w">
</span><span class="n">resultsb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_series</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">)</span><span class="w">

</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">num_series</span><span class="p">){</span><span class="w">
   </span><span class="n">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">)</span><span class="w">
   </span><span class="n">series</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">M</span><span class="m">3</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w">
   </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">series</span><span class="o">$</span><span class="n">x</span><span class="w">
   </span><span class="n">xx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">series</span><span class="o">$</span><span class="n">xx</span><span class="w">
   </span><span class="n">h</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="w">
   
   </span><span class="n">fc3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">hybridf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">simulate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">bootstrap.ets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">bootstrap.aa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
   </span><span class="n">resultsb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pi_accuracy</span><span class="p">(</span><span class="n">fc3</span><span class="p">,</span><span class="w"> </span><span class="n">xx</span><span class="p">)</span><span class="o">$</span><span class="n">Success</span><span class="w">
   
   </span><span class="n">fc1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fc3</span><span class="o">$</span><span class="n">fc_ets</span><span class="w">
   </span><span class="n">resultsb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pi_accuracy</span><span class="p">(</span><span class="n">fc1</span><span class="p">,</span><span class="w"> </span><span class="n">xx</span><span class="p">)</span><span class="o">$</span><span class="n">Success</span><span class="w">
   
   </span><span class="n">fc2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fc3</span><span class="o">$</span><span class="n">fc_aa</span><span class="w">
   </span><span class="n">resultsb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="o">:</span><span class="m">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pi_accuracy</span><span class="p">(</span><span class="n">fc2</span><span class="p">,</span><span class="w"> </span><span class="n">xx</span><span class="p">)</span><span class="o">$</span><span class="n">Success</span><span class="w">
   
   </span><span class="n">resultsb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">resultsb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">resultsb</span><span class="p">)</span><span class="w">

</span><span class="nf">names</span><span class="p">(</span><span class="n">resultsb</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ets_p80"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ets_p95"</span><span class="p">,</span><span class="w"> </span><span class="s2">"auto.arima_p80"</span><span class="p">,</span><span class="w"> </span><span class="s2">"auto.arima_p95"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"hybrid_p80"</span><span class="p">,</span><span class="w"> </span><span class="s2">"hybrid_p95"</span><span class="p">,</span><span class="w"> </span><span class="s2">"h"</span><span class="p">)</span><span class="w">

</span><span class="n">resultsb</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
   </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">weighted_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">Success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">weighted_value</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="p">))</span></code></pre></figure>

<h2 id="conclusions">Conclusions</h2>

<ul>
  <li>The <code class="highlighter-rouge">hybridf()</code> function at <a href="https://raw.githubusercontent.com/ellisp/forecast/dev/R/hybridf.R">https://raw.githubusercontent.com/ellisp/forecast/dev/R/hybridf.R</a> provides a convenient and easy way of performing a forecast combination of <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code>, which gives high performing point estimates and an easily-managed object of class forecast.</li>
  <li>Tested against the M3 competition data, the prediction intervals from <code class="highlighter-rouge">hybridf()</code>, formed by combining the prediction intervals of <code class="highlighter-rouge">ets()</code> and <code class="highlighter-rouge">auto.arima()</code> in a conservative manner (“take the widest range covered by superimposing the two source intervals”) performs true to the desired level ie the 80% prediction interval contains the true value just over 80% of the time, and the 95% prediction interval contains the true value just under 95% of the time.</li>
</ul>


</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2016/01/23/nzis-estimates">
        <p>&larr; Older</p>
        <p>Filling in the gaps - highly granular estimates of income and population for New Zealand from survey data</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
     
        <a rel="next" href="/blog/2016/02/06/world-health-organization">
        <p>Newer &rarr;</p>
        <p>Data from the World Health Organization API</p>
        
        </a>
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		<gcse:search></gcse:search>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
			
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

			<div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="true" data-share="false"></div>
			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			

			</footer>
    </div>



  
</body>
</html>
   




         
