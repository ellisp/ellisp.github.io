      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Lewis Carroll's proposed rules for tennis tournaments</title>
      	
         
         
            <meta name ="description" content ="I put to the test a method of running a tennis tournament suggested by Lewis Carroll. It performs ok in allocating prizes fairly, although it takes about twice as many matches as a standard modern single-elimination. When there is realistic randomness in results it doesn't perform as well as Carroll argued it would on the unrealistic basis of deterministic match outcomes.">
            <meta property="og:description" content ="I put to the test a method of running a tennis tournament suggested by Lewis Carroll. It performs ok in allocating prizes fairly, although it takes about twice as many matches as a standard modern single-elimination. When there is realistic randomness in results it doesn't perform as well as Carroll argued it would on the unrealistic basis of deterministic match outcomes.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Lewis Carroll's proposed rules for tennis tournaments" />
         
            <meta property="og:image" content="http://freerangestats.info/img/0163-tea-party.png" />
         
		 
			<meta property="og:url" content="http://freerangestats.info/blog/2020/02/01/tennis-carroll.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                  <li><a href="/blog/surveys.html">all posts on surveys</a></li> 
				  <li><a href = /blog/2020/12/05/wwi-ships>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
				  <li><a href = "/covid-tracking/index.html">Covid-19 in Australia</a></li>
                  <li><a href = "/elections/nz-2020/index.html">NZ election 2020</a></li>
                  <li><a href = "/elections/oz-2019/index.html">Australia federal election 2019</a></li>
				  <li><a href = "/elections/nz-2017/combined.html">NZ election 2017</a></li>
                  <li><a href="/blog/voting.html">all blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Lewis Carroll's proposed rules for tennis tournaments</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>I put to the test a method of running a tennis tournament suggested by Lewis Carroll. It performs ok in allocating prizes fairly, although it takes about twice as many matches as a standard modern single-elimination. When there is realistic randomness in results it doesn't perform as well as Carroll argued it would on the unrealistic basis of deterministic match outcomes.</p>
	   <p class="meta">01 Feb 2020</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <p>Last week I wrote about <a href="/blog/2020/01/26/tennis-seeding">the impact of seeding the draw in a tennis tournament</a>. Seeding is one way to increase the chance of the top players making it to the final rounds of a single elimination tournament, leading to fairer outcomes and to a higher chance of the best matchups happening in the finals. Basically it’s to overcome this problem:</p>

<blockquote>
  <p>“At a Lawn Tennis Tournament, where I chanced, some while ago, to be a spectator, the present method of assigning prizes was brought to my notice by the lamentations of one of the Players, who had been beaten (and had thus lost all chance of a prize) early in the contest, and who had had the mortification of seeing the 2nd prize carried off by a Player whom he knew to be quite inferior to himself.”</p>
</blockquote>

<p><em>Charles Dodgson (Lewis Carroll)</em></p>

<p>The incident related above led nineteenth century Oxford University mathematician <a href="https://en.wikipedia.org/wiki/Lewis_Carroll">Charles Dodgson</a> to propose an alternative to the unseeded single elimination tournament that was standard at the time. His monograph on the subject, <em>LAWN TENNIS TOURNAMENTS: The True Method of Assigning Prizes with a Proof of the Fallacy of the Present Method</em>, can be found from page 1,082 of his <a href="http://www.gasl.org/refbib/Carroll__Works.pdf">complete works</a>. Of course, Dodgson’s side hustle was as part time children’s author Lewis Carroll, of works including the astonishingly good <em>Alice’s Adventures in Wonderland</em>, <em>Through the Looking Glass</em> and <em>The Hunting of the Snark</em>; and the deservedly forgotton <a href="https://www.tor.com/2014/04/24/how-not-to-write-for-both-children-and-adults-sylvie-and-bruno/"><em>Sylvie and Bruno</em></a>.</p>

<p><img src="/img/0163-alice-flamingo.png" align="right" width="250px" /></p>

<p>Here are the basic elements of Dodgson’s proposed system, which he describes for a tournament of 32 male players:</p>

<ul>
  <li>“A list is kept, and against each name is entered, at the end of each contest, the name of any one who has been superior to him - whether by actually beating him, or by beating some one who has done so (thus, if A beats B, and B beats C, A and B are both ‘superiors’ of C). So soon as any name has 3 ‘superiors’ entered against it, it is struck out of the list”</li>
  <li>“only one contest that (first) day - the 32 Players being arranged in 16 pairs”</li>
  <li>“For the 2nd day … the 16 unbeaten men are paired together, and similarly the 16 with 1 superior (the Losers in these last-named pairs will now have 3 superiors each, and will therefore be struck off the list). In all other contests they are paired in the same way; first pairing the unbeaten, then those with 1 superior, and so on, and avoiding, as far as possible, pairing two Players who have a common superior.”</li>
  <li>“By the middle of the 3rd day the unbeaten are reduced to two… These two … have a whole-day match on the 4th day…”</li>
  <li>“By the end of the 4th day, the ‘First-prize-man’ is known (by the very same process of elimination used in the existing method): and the remaining Players are paired by the same rules as before, for the 2 contests on the 5th day.”</li>
</ul>

<p>The essence of the method is that no-one is knocked out until they are definitely not one of the three best players, as proven by having three or more “superiors” who have either beaten them in a match or beaten someone who beat them. By this method, the actual top three bubble to the top of the competition.</p>

<p>One interesting observation is that under Dodgson’s rules there is no requirement to have the number of players a power of two, as is the case in a standard single-elimination tournament if the organisers wish to avoid unbalanced byes.</p>

<p>Dodgson argues that his proposed method is guaranteed to allocate the first, second and third prizes accurately to the best three players in order. However, his monograph makes some key assumptions:</p>

<ul>
  <li>superiority is transitive eg if A is superior to B and B to C, then A is superior to C</li>
  <li>superiority is deterministic, consistent and persistent</li>
</ul>

<p>Obviously, the real world isn’t like this. How does his method stand up when we make the results of individual matches uncertain and inconsistent with eachother in line with the realistic Elo-based simulation  of results I used last week?</p>

<p>To check this out, I simulated Dodgson-style tournaments with the same 128 top women players from 1990 that I used last week with more conventional tournaments. I built the program to do this so the user had a choice in how individual matchups between players resulted - either deterministically (higher rated player is guaranteed to win, as per Dodgson’s own 32 player demonstration) or realistically probabilistically (chances are random but still depend on the Elo ratings of the two players).</p>

<h2 id="results">Results</h2>

<h3 id="if-winners-are-deterministic-things-work-out-as-dodgson-claimed">If winners are deterministic, things work out as Dodgson claimed</h3>

<p>Of course, Dodgson was a highly accomplished mathematician so no surprise that he is correct that his method correctly allocates prizes in a 32 player competition with deterministic match outcomes. I <em>was</em> curious to see if it would work in a larger competition. I found that his rules (with minimal modifications discussed later in this post) returned the top three players with the top three prizes, in correct order, 100 times out of 100 different runs.</p>

<p>A correctly seeded single-elimination tournament with deterministic match outcomes will also return the top 4 players accurately 100% of the time. I think that Dodgson assumed there was no reliable prior knowledge of players’ skill levels, ruling out the possibility of a seeded tournament; certainly he only compares his method to an unseeded draw.</p>

<p>Note that a Dodgson tournament will take around twice as many matches (varying according to the efficiency of the draw, but around 240 matches was normal in my experiment) as a single-elimination tournament (which needs 127 matches for 128 players).</p>

<h3 id="results-are-not-so-good-when-match-wins-are-realistically-probabilistic">Results are not so good when match wins are realistically probabilistic</h3>

<p>Dodgson’s method is not as good as he would hope when match outcomes are not deterministic, but happen by chance in accordance with the skill differential indicated by players different Elo ratings. Of course, this is the realistic model; even at the height of her powers, Steffi Graf (the top rated player in our 1990 collection) had non zero chance of losing to her top opponents in any given match, as we saw in the graphic from last week:</p>

<object type="image/svg+xml" data="/img/0165-playing-graf.svg" width="100%"><img src="/img/0165-playing-graf.png" /></object>

<p>The figure below shows the result of 1,000 simulated tournaments played out according to Dodgson’s rules, with realistic win and loss probabilities (ie not just 1 and 0). Some example conclusions from this chart include:</p>

<ul>
  <li>The top player wins the tournament 57% of the time</li>
  <li>The top two players are the top two prize recipients 36% of the time, and in the right 1-2 sequence 23% of the time.</li>
  <li>The top three players are awarded the top three prizes in the right sequence only 7% of the time</li>
</ul>

<p>For comparison, all those figures are 100% in the deterministic model Dodgson planned on.</p>

<object type="image/svg+xml" data="/img/0163-results.svg" width="100%"><img src="/img/0163-results.png" /></object>

<p>Under the probabilistic model, the outcomes of Dodgson’s tournament rules are similar to those from a seeded single elimination tournament as in my blog post last week. For example, in that seeded competition, top player Steffi Graf won 60% of tournaments; and the top two players were in the grand final 42% of the time. This is marginally better than the result under Dodgson’s rules with around half the number of matches, reflecting the effective use that the extra prior information on player ability is put to in the seeding.</p>

<h2 id="implementation">Implementation</h2>

<h3 id="approach">Approach</h3>

<p><img src="/img/0163-tea-party.png" align="right" width="250px" /></p>

<p>It was interesting and non-trivial to implement Dodgson’s rules in a way that would be robust to larger tournament sizes, random match outcomes, and inconsistent and non-transitive results. A few notable choices I had to make:</p>

<ul>
  <li>I allocated the initial pairs of players (and subsequent matchups) at random rather than alphabetically based on their names</li>
  <li>I drop the idea of a “round” and instead run a loop looking for the next individual match to play, matching where possible players with the same number of games played and losses as eachother. I made up a concept of the “awkward player” at any moment - a player who has played as few games as anyone, and has the least number of legitimate opponents available with the same number of losses, avoiding rematches, etc. Finding a match for that awkward player becomes the priority in each iteration of my loop.</li>
  <li>I had to allow, in some circumstances, matches between players who had played a different number of games to that point. There’s probably a solution that doesn’t require this but I couldn’t find it in my time budget.</li>
  <li>I also couldn’t think of a practical way to implement the requirement “avoiding, as far as possible, pairing two Players who have a common superior”. I did filter out re-matches except in unusual situations to avoid the algorithm getting stuck.</li>
  <li>With non-deterministic results and rematches allowed when unavoidable, a number of contradictions become possible and need to be carefully handled. For example, a player can become a superior of themselves (in the situation A is beaten by B; then B is beaten by A in a rematch - now future A is a ‘superior’ of past A, a situation that I ruled out by refusing to count).</li>
  <li>It’s possible for the four remaining players all to graduate to having 3 superiors each as a result of a single match late in the tournament, leaving no clear placings. In this situation I made them joint first place, but more realistic would of course be a semi- and grand final series.</li>
  <li>Similarly, it’s possible for players 2 and 3 (of three remaining) to be knocked out in one step. This means no grand final, but a play-off is needed for second place.</li>
</ul>

<p><img src="/img/0163-bookcover.jpg" align="right" width="250px" /></p>

<p>All up, this was a fun exercise. I’m glad this approach to running a tournament works fairly well, even at the cost of roughly twice as many matches needed as in a seeded single-elimination. And it stands up not too badly even with realistically uncertain and inconsistent match outcomes. But of course, it’s not as perfect as the ideal deterministic world described in Dodgson’s original monograph. Things can get pretty complicated, as the above list of decisions and challenges begins to show. There are some quite awkward edge cases that I didn’t stop to sort in detail.</p>

<p>I’m not aware Dodgson’s method has ever been used for a real life tournament schedule, although there have been a few simulation experiments similar to my own. I’m not sure how seriously he meant it to be taken; the same monograph proposing this method also suggests in passing tennis should get rid of sets altogether and replace them with a simpler method such as “he who first wins 14 games, or who gets 9 ahead, wins the match”. I doubt he seriously expected that proposal to be taken up. But it’s worth noting this monograph was published under his professional persona as recreational mathematics enthusiast Charles Dodgson, rather than as children’s author Lewis Carroll.</p>

<p>Let’s just say that, like most of his other work, it’s good he published this! But I would hesitate to recommend adopting it in toto.</p>

<h3 id="code">Code</h3>

<p>Here’s all the R code for these simulations in a single chunk. A <code class="highlighter-rouge">carroll_tournament()</code> function is the work horse, with a couple of helpers for very specific tasks such as <code class="highlighter-rouge">one_match()</code> which plays out a single match using either a deterministic or probabilistic method of allocating a winner.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">foreach</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">doParallel</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">kableExtra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">clipr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">deuce</span><span class="p">)</span><span class="w">



</span><span class="cd">#' Play out a single match between two players
#' 
#' @param p1_elo Elo rating of player 1
#' @param p2_elo Elo rating of player 2
#' @param method whether the winner is chosen at random (but with higher Elo rating meaning a higher
#' chance of winning) or deterministically (in which case the player with the higher Elo rating always wins)
#' @details draws are not supported. If method is deterministic and the Elo ratings are equal, player 1 wins.
#' @return a 2 if player 2 wins, and 1 if player 1 wins
</span><span class="n">one_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"probabilistic"</span><span class="p">,</span><span class="w"> </span><span class="s2">"deterministic"</span><span class="p">)){</span><span class="w">
  </span><span class="n">method</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">match.arg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"probabilistic"</span><span class="p">){</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbinom</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deuce</span><span class="o">::</span><span class="n">elo_prediction</span><span class="p">(</span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w">
  
</span><span class="p">}</span><span class="w">


</span><span class="cd">#' Play out a tournament along the lines of Lewis Carroll's preferred methold
#' 
#' @param players a data frame or tibble with columns for player_id and Elo
#' @param verbose Whether to print out the number of remaining players in each round
#' @param method Whether individual match results are probabilistic (realistic) or deterministic (player 
#' with higher rating always wins)
#' @details complete works of Lewis Carroll available at http://www.gasl.org/refbib/Carroll__Works.pdf
#' Description of a better lawn tennis tournament begins on page 1,082
</span><span class="n">carroll_tournament</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">players</span><span class="p">,</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> 
                               </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"probabilistic"</span><span class="p">,</span><span class="w"> </span><span class="s2">"deterministic"</span><span class="p">)){</span><span class="w">
  </span><span class="n">method</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">match.arg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="w">
  
  </span><span class="n">match_wins</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="w">
    </span><span class="n">winner_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">character</span><span class="p">(),</span><span class="w">
    </span><span class="n">loser_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">character</span><span class="p">(),</span><span class="w">
    </span><span class="n">combo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">character</span><span class="p">()</span><span class="w">
  </span><span class="p">)</span><span class="w">
  
  </span><span class="n">we_have_finalists</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
  
  </span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">we_have_finalists</span><span class="p">){</span><span class="w">
    </span><span class="n">match_counts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">match_wins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">gather</span><span class="p">(</span><span class="n">role</span><span class="p">,</span><span class="w"> </span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">combo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">group_by</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">summarise</span><span class="p">(</span><span class="n">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w">
    
    </span><span class="n">direct_losses</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">match_wins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">group_by</span><span class="p">(</span><span class="n">loser_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">summarise</span><span class="p">(</span><span class="n">losses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">winner_id</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">rename</span><span class="p">(</span><span class="n">player_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loser_id</span><span class="p">)</span><span class="w">
    
    </span><span class="n">indirect_losses</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">players</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">select</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">inner_join</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"loser_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">rename</span><span class="p">(</span><span class="n">first_round_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winner_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">combo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">inner_join</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"first_round_winner"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"loser_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">rename</span><span class="p">(</span><span class="n">indirect_superior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winner_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># remove people who are direct superiors so they don't get counted twice:
</span><span class="w">      </span><span class="n">anti_join</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"loser_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"indirect_superior"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"winner_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># you can't be an indirect superior to yourself (this happens if you beat someone who beat you before):
</span><span class="w">      </span><span class="n">filter</span><span class="p">(</span><span class="n">indirect_superior</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="c1"># you can't have someone you have beaten directly as an indirect superior:
</span><span class="w">      </span><span class="n">anti_join</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"winner_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"indirect_superior"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"loser_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">group_by</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">summarise</span><span class="p">(</span><span class="n">indirect_superiors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">indirect_superior</span><span class="p">)))</span><span class="w">
    
    </span><span class="n">superiors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">direct_losses</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">left_join</span><span class="p">(</span><span class="n">indirect_losses</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">indirect_superiors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replace_na</span><span class="p">(</span><span class="n">indirect_superiors</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w">
             </span><span class="n">superiors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">losses</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">indirect_superiors</span><span class="p">)</span><span class="w"> 
    
    </span><span class="n">all_players</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">players</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">left_join</span><span class="p">(</span><span class="n">superiors</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">left_join</span><span class="p">(</span><span class="n">match_counts</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">superiors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replace_na</span><span class="p">(</span><span class="n">superiors</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w">
             </span><span class="n">losses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replace_na</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w">
             </span><span class="n">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replace_na</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
    
    </span><span class="n">remaining_players</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">all_players</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">superiors</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">select</span><span class="p">(</span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="n">matches</span><span class="p">,</span><span class="w"> </span><span class="n">elo</span><span class="p">)</span><span class="w"> 
    
    </span><span class="n">left</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">remaining_players</span><span class="p">)</span><span class="w">
    
    </span><span class="k">if</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span><span class="p">){</span><span class="w">
      </span><span class="c1"># It's possible to get stuck with only two superiors at this point
</span><span class="w">      </span><span class="n">remaining_players</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">all_players</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">filter</span><span class="p">(</span><span class="n">superiors</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">select</span><span class="p">(</span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="n">matches</span><span class="p">,</span><span class="w"> </span><span class="n">elo</span><span class="p">)</span><span class="w"> 
      
      </span><span class="n">left</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">remaining_players</span><span class="p">)</span><span class="w">
      
    </span><span class="p">}</span><span class="w">
    
    </span><span class="k">if</span><span class="p">(</span><span class="n">verbose</span><span class="p">){</span><span class="n">print</span><span class="p">(</span><span class="n">left</span><span class="p">)}</span><span class="w">
    
    </span><span class="k">if</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">2</span><span class="p">){</span><span class="w">
      </span><span class="n">we_have_finalists</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">TRUE</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    
      </span><span class="n">candidate_players</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">remaining_players</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">filter</span><span class="p">(</span><span class="n">matches</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span><span class="w">
      
      </span><span class="k">if</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">candidate_players</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
        </span><span class="n">low_match_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pull</span><span class="p">(</span><span class="n">candidate_players</span><span class="p">,</span><span class="w"> </span><span class="n">player_id</span><span class="p">)</span><span class="w">
        </span><span class="n">candidate_players</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">remaining_players</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">filter</span><span class="p">(</span><span class="n">matches</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">low_match_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
      </span><span class="p">}</span><span class="w">
      
      </span><span class="c1"># player ids of remaining players who have played minimum matches and are a candidate for the next match:
</span><span class="w">      </span><span class="n">rpi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">candidate_players</span><span class="o">$</span><span class="n">player_id</span><span class="w">
      
      </span><span class="c1"># possible matches (ie excluding rematches) of the candidate players:
</span><span class="w">      </span><span class="n">possible_matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">expand_grid</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpi</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpi</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="c1"># limit to those with id 1 less than id 2 - just for sorting purposes
</span><span class="w">        </span><span class="n">filter</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">mutate</span><span class="p">(</span><span class="n">combo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="c1"># restrict to those who have lost the same number of games as eachother
</span><span class="w">        </span><span class="n">left_join</span><span class="p">(</span><span class="n">all_players</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"losses"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"p1"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">rename</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">losses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">left_join</span><span class="p">(</span><span class="n">all_players</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"losses"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"p2"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">rename</span><span class="p">(</span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">losses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">filter</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">losses</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="c1"># restrict to people who haven't played eachother:
</span><span class="w">        </span><span class="n">anti_join</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"combo"</span><span class="p">)</span><span class="w"> 
      
      </span><span class="n">get_awkward_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">possible_matches</span><span class="p">,</span><span class="w"> </span><span class="n">low_match_player</span><span class="p">){</span><span class="w">
        
        </span><span class="k">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">low_match_player</span><span class="p">)){</span><span class="w">
          </span><span class="c1"># find the player who has the least options for playing others
</span><span class="w">          </span><span class="n">awkward_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">possible_matches</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">gather</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">combo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">group_by</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">summarise</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">arrange</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">runif</span><span class="p">(</span><span class="n">n</span><span class="p">()))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">pull</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">awkward_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">low_match_player</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">awkward_player</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
      
      </span><span class="n">awkward_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_awkward_player</span><span class="p">(</span><span class="n">possible_matches</span><span class="p">,</span><span class="w"> </span><span class="n">low_match_player</span><span class="p">)</span><span class="w">
      
      </span><span class="c1"># find a match with that player
</span><span class="w">      </span><span class="n">the_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">possible_matches</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">filter</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">awkward_player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">awkward_player</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">sample_n</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> 
      
      
      </span><span class="k">if</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">the_match</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="w">
        </span><span class="c1"># need to let a rematch, or a matchhappen if there is no alternative:
</span><span class="w">        </span><span class="n">warning</span><span class="p">(</span><span class="s2">"Rematch or match of players with unequal number of losses"</span><span class="p">)</span><span class="w">
        </span><span class="n">possible_matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">expand_grid</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpi</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpi</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="c1"># limit to those with id 1 less than id 2 - just for sorting purposes
</span><span class="w">          </span><span class="n">filter</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">mutate</span><span class="p">(</span><span class="n">combo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">))</span><span class="w">
        
        </span><span class="n">awkward_player</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_awkward_player</span><span class="p">(</span><span class="n">possible_matches</span><span class="p">,</span><span class="w"> </span><span class="n">low_match_player</span><span class="p">)</span><span class="w">
        
        </span><span class="n">the_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">possible_matches</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">filter</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">awkward_player</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">awkward_player</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">sample_n</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> 
      </span><span class="p">}</span><span class="w">
      
      </span><span class="n">the_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">the_match</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">left_join</span><span class="p">(</span><span class="n">players</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"elo"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"p1"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">rename</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">left_join</span><span class="p">(</span><span class="n">players</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"player_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"elo"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"p2"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"player_id"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">rename</span><span class="p">(</span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elo</span><span class="p">)</span><span class="w">
      
      </span><span class="n">winner</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">one_match</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_match</span><span class="o">$</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_match</span><span class="o">$</span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">)</span><span class="w">
      
      </span><span class="k">if</span><span class="p">(</span><span class="n">winner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
        </span><span class="n">new_result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">the_match</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">combo</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">new_result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">the_match</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">combo</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
      </span><span class="nf">names</span><span class="p">(</span><span class="n">new_result</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"winner_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"loser_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"combo"</span><span class="p">)</span><span class="w">
      
      </span><span class="n">match_wins</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">new_result</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">){</span><span class="w">
    </span><span class="n">grand_final</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">one_match</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining_players</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">elo</span><span class="p">,</span><span class="w">
                             </span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remaining_players</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">elo</span><span class="p">,</span><span class="w">
                             </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">)</span><span class="w">
    
    </span><span class="n">first_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">remaining_players</span><span class="p">[</span><span class="n">grand_final</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">player_id</span><span class="w">
    </span><span class="n">second_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">remaining_players</span><span class="p">[</span><span class="o">-</span><span class="n">grand_final</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">player_id</span><span class="w">
   
    </span><span class="n">final_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="w">
      </span><span class="n">winner_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_place</span><span class="p">,</span><span class="w">
      </span><span class="n">loser_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">second_place</span><span class="p">,</span><span class="w">
      </span><span class="n">combo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">first_place</span><span class="p">,</span><span class="w"> </span><span class="n">second_place</span><span class="p">)),</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" "</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
    
    </span><span class="n">match_wins</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">match_wins</span><span class="p">,</span><span class="w"> </span><span class="n">final_match</span><span class="p">)</span><span class="w"> 
    
    </span><span class="p">}</span><span class="w"> 
  </span><span class="k">if</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="w">
    </span><span class="c1"># it's possible for the last 4 players to be knocked out simultaneously. left == 0 in this case
</span><span class="w">    </span><span class="n">warning</span><span class="p">(</span><span class="s2">"There was no grand final, the last four players were knocked out at once"</span><span class="p">)</span><span class="w">
    </span><span class="n">first_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">superiors</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">superiors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">superiors</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">losses</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">pull</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">paste</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" | "</span><span class="p">)</span><span class="w">
    
    </span><span class="n">second_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Not awarded"</span><span class="w">
    </span><span class="n">third_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Not awarded"</span><span class="w">
    
  </span><span class="p">}</span><span class="w">
  
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
      </span><span class="c1"># it's possible for players 2 and 3 to be knocked out simultaneously, in which case
</span><span class="w">      </span><span class="c1"># there is one remaining player and no grand final. left == 1 in this case
</span><span class="w">      </span><span class="n">warning</span><span class="p">(</span><span class="s2">"There was no grand final, a player won by default"</span><span class="p">)</span><span class="w">
      </span><span class="n">first_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">remaining_players</span><span class="o">$</span><span class="n">player_id</span><span class="w">
      
      </span><span class="n">second_place_possibles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">superiors</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="n">player_id</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">first_place</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">filter</span><span class="p">(</span><span class="n">superiors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">superiors</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="c1"># if there are people with the same number of superiors at this point, the place
</span><span class="w">        </span><span class="c1"># goes to the person with the less direct losses 
</span><span class="w">        </span><span class="n">filter</span><span class="p">(</span><span class="n">losses</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
        </span><span class="n">pull</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span><span class="w"> 
      
      </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">second_place_possibles</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">){</span><span class="w">
        </span><span class="n">warning</span><span class="p">(</span><span class="s2">"Needed a semi final play-off for second position"</span><span class="p">)</span><span class="w">
        </span><span class="n">semi_players</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">player_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">second_place_possibles</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">inner_join</span><span class="p">(</span><span class="n">players</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="s2">"player_id"</span><span class="p">)</span><span class="w">
        
        </span><span class="n">semi_final</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">one_match</span><span class="p">(</span><span class="n">p</span><span class="m">1</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semi_players</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">elo</span><span class="p">,</span><span class="w">
                                </span><span class="n">p</span><span class="m">2</span><span class="err">_</span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">semi_players</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">elo</span><span class="p">,</span><span class="w">
                                </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">)</span><span class="w">
        </span><span class="n">second_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">semi_players</span><span class="p">[</span><span class="n">semi_final</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">player_id</span><span class="w">
        </span><span class="n">third_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">semi_players</span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">semi_final</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">player_id</span><span class="w">
      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">second_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">second_place_possibles</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" | "</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
      
      </span><span class="k">if</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">" | "</span><span class="p">,</span><span class="w"> </span><span class="n">second_place</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)){</span><span class="w">
        </span><span class="c1"># if there were 3 second place possibles we give up at this point..
</span><span class="w">        </span><span class="n">third_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Not awarded"</span><span class="w">
      </span><span class="p">}</span><span class="w">
      
    </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">(</span><span class="s2">"third_place"</span><span class="p">)){</span><span class="w">
  
     </span><span class="n">third_place</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">superiors</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="n">player_id</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">first_place</span><span class="p">,</span><span class="w"> </span><span class="n">second_place</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">arrange</span><span class="p">(</span><span class="n">superiors</span><span class="p">,</span><span class="w"> </span><span class="n">losses</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">superiors</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">superiors</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">losses</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">pull</span><span class="p">(</span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">paste</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" | "</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="n">match_wins</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">match_wins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">match</span><span class="p">))</span><span class="w">
  
  </span><span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="w">
    </span><span class="n">match_wins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">match_wins</span><span class="p">,</span><span class="w">
    </span><span class="n">top3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">first_place</span><span class="p">,</span><span class="w"> </span><span class="n">second_place</span><span class="p">,</span><span class="w"> </span><span class="n">third_place</span><span class="p">))</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#-------------Data prep---------------
</span><span class="w">
</span><span class="c1"># Identify the top 128 women playing in 1990 and their last Elo rating that year
</span><span class="n">data</span><span class="p">(</span><span class="n">wta_elo</span><span class="p">)</span><span class="w">

</span><span class="n">women</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wta_elo</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">year</span><span class="p">(</span><span class="n">tourney_start_date</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1990</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># pick just the latest Elo rating
</span><span class="w">  </span><span class="n">group_by</span><span class="p">(</span><span class="n">player_name</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">tourney_start_date</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">overall_elo</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">player_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player_name</span><span class="p">,</span><span class="w"> </span><span class="n">elo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overall_elo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">slice</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">128</span><span class="p">)</span><span class="w">

</span><span class="c1"># example usage:
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">142</span><span class="p">)</span><span class="w">
</span><span class="n">carroll_tournament</span><span class="p">(</span><span class="n">women</span><span class="p">)</span><span class="w">
</span><span class="n">carroll_tournament</span><span class="p">(</span><span class="n">women</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"deterministic"</span><span class="p">)</span><span class="w">

</span><span class="c1"># note that as currently written, rematches don't do anything unless they come out with the other result
# this would not be popular! 
</span><span class="w">

</span><span class="c1">#-----------set up parallel processing-----------
</span><span class="w">
</span><span class="n">cluster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">makeCluster</span><span class="p">(</span><span class="m">7</span><span class="p">)</span><span class="w"> </span><span class="c1"># only any good if you have at least 7 processors :)
</span><span class="n">registerDoParallel</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w">

</span><span class="n">clusterEvalQ</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">library</span><span class="p">(</span><span class="n">foreach</span><span class="p">)</span><span class="w">
  </span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
  </span><span class="n">library</span><span class="p">(</span><span class="n">deuce</span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="n">clusterExport</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"women"</span><span class="p">,</span><span class="w"> </span><span class="s2">"carroll_tournament"</span><span class="p">))</span><span class="w">


</span><span class="c1">#-------------------simulation of tournament-------------------
</span><span class="n">n_sims</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1000</span><span class="w">

</span><span class="n">r</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foreach</span><span class="p">(</span><span class="n">this_sim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n_sims</span><span class="p">,</span><span class="w"> </span><span class="n">.combine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">)</span><span class="w"> </span><span class="o">%dopar%</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">set.seed</span><span class="p">(</span><span class="n">this_sim</span><span class="p">)</span><span class="w">
  </span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">carroll_tournament</span><span class="p">(</span><span class="n">women</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"prob"</span><span class="p">)</span><span class="w">
  </span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">results</span><span class="o">$</span><span class="n">top3</span><span class="p">))</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
    </span><span class="c1"># very rarely, there's only one person emerging
</span><span class="w">    </span><span class="n">tmp</span><span class="o">$</span><span class="n">second</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">){</span><span class="w">
    </span><span class="c1"># sometimes there's no third person due to complications with reversing results
</span><span class="w">    </span><span class="n">tmp</span><span class="o">$</span><span class="n">third</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="nf">names</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"first"</span><span class="p">,</span><span class="w"> </span><span class="s2">"second"</span><span class="p">,</span><span class="w"> </span><span class="s2">"third"</span><span class="p">)</span><span class="w">
  </span><span class="n">tmp</span><span class="o">$</span><span class="n">sim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">this_sim</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># what order *should* have been returned?
</span><span class="n">correct</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">women</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">correct_player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">player_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">place</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"first"</span><span class="p">,</span><span class="w"> </span><span class="s2">"second"</span><span class="p">,</span><span class="w"> </span><span class="s2">"third"</span><span class="p">))</span><span class="w">

</span><span class="c1"># Can it get the top three right as promised:
</span><span class="n">top3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r</span><span class="m">1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">place</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">correct</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"place"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">correct_sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">correct_player</span><span class="p">),</span><span class="w">
            </span><span class="n">correct_approx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">correct_player</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">correct_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">correct_approx</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">correct_approx</span><span class="p">),</span><span class="w"> </span><span class="n">desc</span><span class="p">(</span><span class="n">correct_sequence</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">looking_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w">

</span><span class="c1"># Can it at least get the top two right:
</span><span class="n">top2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r</span><span class="m">1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">place</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">place</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"first"</span><span class="p">,</span><span class="w"> </span><span class="s2">"second"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">correct</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"place"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">correct_sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">correct_player</span><span class="p">),</span><span class="w">
            </span><span class="n">correct_approx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">correct_player</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">correct_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">correct_approx</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">correct_approx</span><span class="p">),</span><span class="w"> </span><span class="n">desc</span><span class="p">(</span><span class="n">correct_sequence</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">looking_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w">

</span><span class="c1"># overall winner
</span><span class="n">top1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r</span><span class="m">1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">place</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">place</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"first"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">correct</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"place"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">correct_approx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">correct_player</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">correct_approx</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">correct_approx</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">looking_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w">

</span><span class="n">rbind</span><span class="p">(</span><span class="n">top3</span><span class="p">,</span><span class="w"> </span><span class="n">top2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">correct_sequence</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rbind</span><span class="p">(</span><span class="n">top1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">looking_at</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">prop_correct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">correct_approx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">looking_at</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span><span class="w">

</span><span class="c1"># chart of results
</span><span class="n">top1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">correct_sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">correct_approx</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rbind</span><span class="p">(</span><span class="n">top3</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rbind</span><span class="p">(</span><span class="n">top2</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">looking_at</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">correct_approx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">correct_approx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">looking_at</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span><span class="w">
            </span><span class="n">correct_exact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">correct_sequence</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">looking_at</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">looking_at</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">variable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"correct_approx"</span><span class="p">,</span><span class="w"> </span><span class="s2">"In the correct prize group but not necessarily sequence"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Correct sequence"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">looking_at</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent_format</span><span class="p">(</span><span class="n">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid.minor.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">expand_limits</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of top players of interest"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Probability those players get prizes at correct levels"</span><span class="p">,</span><span class="w">
       </span><span class="n">colour</span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Chance of the top one, two or three players ending in correct place in the tournament"</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Performance of Lewis Carroll's tennis tournament rules"</span><span class="p">,</span><span class="w">
       </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Analysis by http://freerangestats.info of simulated tournaments of the top 128 women players in 1990, with probabilistic match outcomes"</span><span class="p">)</span><span class="w">


</span><span class="c1">#-------------check that deterministic approach always works for top 3------------
</span><span class="w">
</span><span class="n">n_sims</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">100</span><span class="w">

</span><span class="n">r</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foreach</span><span class="p">(</span><span class="n">this_sim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n_sims</span><span class="p">,</span><span class="w"> </span><span class="n">.combine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">)</span><span class="w"> </span><span class="o">%dopar%</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">set.seed</span><span class="p">(</span><span class="n">this_sim</span><span class="p">)</span><span class="w">
  </span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">carroll_tournament</span><span class="p">(</span><span class="n">women</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"det"</span><span class="p">)</span><span class="w">
  </span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">results</span><span class="o">$</span><span class="n">top3</span><span class="p">))</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
    </span><span class="c1"># very rarely, there's only one person emerging
</span><span class="w">    </span><span class="n">tmp</span><span class="o">$</span><span class="n">second</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">){</span><span class="w">
    </span><span class="c1"># sometimes there's no third person due to complications with reversing results
</span><span class="w">    </span><span class="n">tmp</span><span class="o">$</span><span class="n">third</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="nf">names</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"first"</span><span class="p">,</span><span class="w"> </span><span class="s2">"second"</span><span class="p">,</span><span class="w"> </span><span class="s2">"third"</span><span class="p">)</span><span class="w">
  </span><span class="n">tmp</span><span class="o">$</span><span class="n">sim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">this_sim</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">stopCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w">

</span><span class="n">r</span><span class="m">2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">place</span><span class="p">,</span><span class="w"> </span><span class="n">player</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">correct</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"place"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">correct_sequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">correct_player</span><span class="p">),</span><span class="w">
            </span><span class="n">correct_approx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">player</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">correct_player</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">correct_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">correct_approx</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">correct_approx</span><span class="p">),</span><span class="w"> </span><span class="n">desc</span><span class="p">(</span><span class="n">correct_sequence</span><span class="p">))</span><span class="w"> </span></code></pre></figure>

<p><em>The illustrations in this blog post are screenshots from Lewis Carroll’s complete works with original illustrations by <a href="https://en.wikipedia.org/wiki/John_Tenniel">John Tenniel</a>.</em></p>


		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2020/01/26/tennis-seeding">Analysing the effectiveness of tennis tournament seeding</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2020/02/23/bmi">Body Mass Index</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<hr></hr>
			
			<p>My day job is Chief Data Scientist at <a href='https://www.nousgroup.com/'>Nous Group</a>, an international management consultancy with over 400 people working across Australia, the UK and Canada. <a href='mailto:peter.ellis@nousgroup.com.au'>Contact me</a> if you are interested working with us on a grand challenge or broad agenda.</p>
		
		    <hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics
http://Http://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>