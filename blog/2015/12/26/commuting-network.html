      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Network charts of commuting in New Zealand with R and D3</title>
      	
         
         
            <meta name ="description" content ="Commuting patterns between districts and cities in New Zealand are used to illustrate static (for printing) and interactive (for the web) network charts with R and D3.">
            <meta property="og:description" content ="Commuting patterns between districts and cities in New Zealand are used to illustrate static (for printing) and interactive (for the web) network charts with R and D3.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Network charts of commuting in New Zealand with R and D3" />
         
            <meta property="og:image" content="https:/freerangestats.info/img/0025-commuting.png" />
         
		 
			<meta property="og:url" content="https://freerangestats.info/blog/2015/12/26/commuting-network.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                  <li><a href="/blog/surveys.html">all posts on surveys</a></li> 
				  <li><a href = /blog/2024/08/20/symmetry>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
				  <li><a href = "/covid-tracking/index.html">Covid-19 in Australia</a></li>
                  <li><a href = "/elections/nz-2020/index.html">NZ election 2020</a></li>
                  <li><a href = "/elections/oz-2019/index.html">Australia federal election 2019</a></li>
				  <li><a href = "/elections/nz-2017/combined.html">NZ election 2017</a></li>
                  <li><a href="/blog/voting.html">all blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Network charts of commuting in New Zealand with R and D3</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>Commuting patterns between districts and cities in New Zealand are used to illustrate static (for printing) and interactive (for the web) network charts with R and D3.</p>
	   <p class="meta">26 Dec 2015</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <h2 id="commuting-between-districts-and-cities-in-new-zealand">Commuting between districts and cities in New Zealand</h2>
<iframe src="/img/0025-networkD3.html" style="overflow-y: hidden;" width="100%" height="430px"></iframe>

<p>At this year’s New Zealand Statisticians Association conference I gave a talk on <a href="http://www.mbie.govt.nz/info-services/sectors-industries/regions-cities/research/modelled-territorial-authority-gross-domestic-product">Modelled Territorial Authority Gross Domestic Product</a>.  One thing I’d talked about was the impact on the estimates of people residing in one Territorial Authority (district or city) but working in another one.  This was important because data on earnings  by place of residence formed a crucial step in those particular estimates of modelled GDP, which needs to be based on place of production.  I had a slide to visualise the “commuting patterns”, which I’d prepared for that talk but isn’t used elsewhere, and thought I’d share it and a web version here on this blog.</p>

<p>The web version is the one in the frame above this text.  It’s designed to be interacted with - try hovering over circles, or picking them up and dragging them around.</p>

<h2 id="data">Data</h2>
<p>The source data for this come from 2013 Census and are <a href="http://www.stats.govt.nz/Census/2013-census/profile-and-summary-reports/commuter-view-visualisation.aspx">published by Statistics New Zealand</a>, who have their own <a href="http://www.stats.govt.nz/datavisualisation/commuterview/index.html">rather nifty map-based visualisation</a>.  The data are published on the visualisation’s information page and it’s easy to grab the CSV and tidy it up in R:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">showtext</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">networkD3</span><span class="p">)</span><span class="w">

</span><span class="c1"># import fonts</span><span class="w">
</span><span class="n">font.add.google</span><span class="p">(</span><span class="s2">"Poppins"</span><span class="p">,</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w">
</span><span class="n">showtext.auto</span><span class="p">()</span><span class="w">

</span><span class="c1"># download data from Statistics New Zealand</span><span class="w">
</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"http://www.stats.govt.nz/~/media/Statistics/Census/2013%20Census/profile-and-summary-reports/commuter-view-interactive/2013-usual-residence-by-workplace-address-territorial-authority.csv"</span><span class="p">,</span><span class="w">
              </span><span class="n">na.strings</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">"..C"</span><span class="p">,</span><span class="w">
              </span><span class="n">sep</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="s2">","</span><span class="p">,</span><span class="w">
              </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
              </span><span class="n">check.names</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
              </span><span class="n">header</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Tidy into long form, remove clutter, make names consistent, </span><span class="w">
</span><span class="c1"># drop uninteresting data:</span><span class="w">
</span><span class="n">TravelAll</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">67</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">rename</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Usual.residence</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">from</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" District"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="p">),</span><span class="w">
         </span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" City"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="p">),</span><span class="w">
         </span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" Territory"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" Territory"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" District"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" City"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Hawke s"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Hawke's"</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Matamata Piako"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Matamata-Piako"</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Queenstown Lakes"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Queenstown-Lakes"</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">),</span><span class="w">
         </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Thames Coromandel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Thames-Coromandel"</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
           </span><span class="n">to</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"Total workplace address"</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
           </span><span class="n">to</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"No Fixed Workplace Address"</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
           </span><span class="n">to</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"Area Outside Territorial Authority"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"Not Further Defined"</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w">
         </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">))</span><span class="w"> 

</span><span class="c1"># subset dropping the small values:  </span><span class="w">
</span><span class="n">Travel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">TravelAll</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">100</span><span class="p">)</span></code></pre></figure>

<h2 id="drawing-a-static-plot">Drawing a static plot</h2>
<p><img src="/img/0025-commuting.svg" alt="static" />
The static plot I used in my presentation is made with the excellent <a href="https://cran.r-project.org/web/packages/igraph/index.html"><code class="language-plaintext highlighter-rouge">igraph</code> package</a> by Gabor Csadi.  There are lots of options for layouts; not being an expert in network graphs I used trial and error until I got something sufficiently visually striking.  Note that the locations of districts and cities are chosen to maximise use of white space given the various connections between them - they don’t represent physical locations (which is possible, but less impact for my purpose).</p>

<p>The eventual code is simple enough.  The <code class="language-plaintext highlighter-rouge">Travel</code> object I created in the previous chunk of code is in the right shape, with its “from” and “to” columns enough to define both the nodes and edges (ie links connecting nodes), and the “value” column is used to define the width of each edge.  There was a bit of finesse required with size and font settings to get it looking useful.  As it sits, it’s still difficult to tell which way the arrows are pointing (most relationships are both ways of course, and all the arrows merge together into blobs for significant “target” authorities like Auckland), but it gets the job down of picturing which districts and cities are linked to which.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">draw_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">125</span><span class="p">){</span><span class="w">
   </span><span class="n">set.seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="w"> </span><span class="c1"># there's some randomness in the graphing layout</span><span class="w">
   </span><span class="n">g</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Travel</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">graph.data.frame</span><span class="p">(</span><span class="n">directed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">       
   </span><span class="n">par</span><span class="p">(</span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">,</span><span class="w"> </span><span class="n">mai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">.2</span><span class="p">,</span><span class="w"> </span><span class="m">.2</span><span class="p">,</span><span class="w"> </span><span class="m">.2</span><span class="p">,</span><span class="w"> </span><span class="m">.2</span><span class="p">))</span><span class="w">  
   </span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">edge.arrow.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.4</span><span class="p">,</span><span class="w"> </span><span class="n">layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">layout.davidson.harel</span><span class="p">,</span><span class="w">
        </span><span class="n">edge.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">Travel</span><span class="o">$</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w">
        </span><span class="n">vertex.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">edge.curved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
        </span><span class="n">vertex.label.family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">,</span><span class="w">
        </span><span class="n">vertex.label.cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.8</span><span class="p">,</span><span class="w">
        </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Commuting patterns 2013 (&gt;100 people commuting)"</span><span class="w">
   </span><span class="p">)</span><span class="w">          
</span><span class="p">}</span></code></pre></figure>

<h2 id="drawing-an-interactive-plot">Drawing an interactive plot</h2>
<iframe src="/img/0025-networkD3.html" style="overflow-y: hidden;" width="100%" height="430px"></iframe>

<p>The interactive plot is a bit fiddlier, but still a fairly straightforward task with the help of the <a href="https://cran.r-project.org/web/packages/networkD3/index.html"><code class="language-plaintext highlighter-rouge">networkD3</code> package</a> by Christopher Gandrud et al.  This package uses the <a href="http://www.htmlwidgets.org/">htmlwidgets paradigm</a> to make JavaScript D3 network graph visualisations easy to create.  This gives us access to the data management and analysis capabilities of R as well as the web visualisations of JavaScript.</p>

<p>There’s a bit of extra work to be done here and it’s not quite such an R-native feel as using <code class="language-plaintext highlighter-rouge">igraph</code>.  Most significantly, JavaScript (like most computer languages I know other than R) indexes its arrays starting at zero, not one, and the data frame that holds the “from” and “to” information for the edges needs to refer to nodes by number from zero to (n - 1).  There are many ways to do this but I find the easiest is to use Wickham’s <code class="language-plaintext highlighter-rouge">dplyr</code> pipeline - as in the code that creates the <code class="language-plaintext highlighter-rouge">Links</code> data frame below.  Note that I’m also classifying the territorial authorities by island.</p>

<p>One of the strengths of an interactive plot is we can impart extra information by hover-over tooltips that would be way too cluttered in a static chart.  In this case, I’ve done a slightly ugly summary of an authority’s total “to” and “from” movements from residence to place of work.  The code below creating <code class="language-plaintext highlighter-rouge">froms</code>, <code class="language-plaintext highlighter-rouge">tos</code>, <code class="language-plaintext highlighter-rouge">both</code> and <code class="language-plaintext highlighter-rouge">TAs</code> data frames is for this purpose, so the “label” column can be used in the visualisation for the actual tooltips.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># vector of south island districts so we can colour nodes by island:</span><span class="w">
</span><span class="n">southisland</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Dunedin"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Tasman"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Nelson"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Marlborough"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Christchurch"</span><span class="p">,</span><span class="w"> 
                 </span><span class="s2">"Queenstown-Lakes"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Invercargill"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Grey"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"Westland"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Waimakariri"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Hurunui"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Selwyn"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"Ashburton"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Timaru"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mackenzie"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Waimate"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Central Otago"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"Waitaki"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Clutha"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Gore"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Southland"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Buller"</span><span class="p">)</span><span class="w">

</span><span class="c1"># create a look up table of TA names and ID 0:(n-1)</span><span class="w">
</span><span class="n">TAs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">TA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Travel</span><span class="o">$</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">Travel</span><span class="o">$</span><span class="n">to</span><span class="p">)))</span><span class="w"> 
</span><span class="n">TAs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">TAs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="o">:</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">TAs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
          </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
          </span><span class="n">island</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">TA</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">southisland</span><span class="p">,</span><span class="w"> </span><span class="s2">"South Island"</span><span class="p">,</span><span class="w"> </span><span class="s2">"North Island"</span><span class="p">))</span><span class="w">

</span><span class="c1"># create a data frame with numbers 0 : n-1 instead of names of TAS          </span><span class="w">
</span><span class="n">Links</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Travel</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">TAs</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"from"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"TA"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">from</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">TAs</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"to"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"TA"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">to</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">200</span><span class="p">)</span><span class="w">
   
</span><span class="c1"># create some totals for more informative tooltips:</span><span class="w">
</span><span class="n">froms</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">TravelAll</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">from</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">From</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">TA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">from</span><span class="p">)</span><span class="w">

</span><span class="n">tos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">TravelAll</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">to</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">To</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">TA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">)</span><span class="w">

</span><span class="n">both</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">full_join</span><span class="p">(</span><span class="n">froms</span><span class="p">,</span><span class="w"> </span><span class="n">tos</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"TA"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">TA</span><span class="p">,</span><span class="w"> </span><span class="s2">". From: "</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="s2">"; To: "</span><span class="p">,</span><span class="w"> </span><span class="n">To</span><span class="p">,</span><span class="w"> </span><span class="s2">"."</span><span class="p">))</span><span class="w"> 

</span><span class="n">TAs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">TAs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">both</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"TA"</span><span class="p">)</span><span class="w">   </span></code></pre></figure>

<p>Drawing a good looking network chart is easy enough, and just a matter of getting the data in the right shape and telling the <code class="language-plaintext highlighter-rouge">forceNetwork()</code> R function which columns to use as Source and Target for each edge / link, and which columns of a second data frame to use for <code class="language-plaintext highlighter-rouge">Group</code> (which controls colour), <code class="language-plaintext highlighter-rouge">Nodesize</code>, and <code class="language-plaintext highlighter-rouge">NodeID</code> (which controls the mouse hover tooltips).  Controlling colours requires us to create a D3 scale as a palette which needs a bit of basic JavaScript, which gets passed to <code class="language-plaintext highlighter-rouge">forceNetwork</code> via the <code class="language-plaintext highlighter-rouge">colourScale = JS(...)</code> snippet below.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'d3.scale.ordinal()
         .domain(["South Island", "North Island"])
         .range(["#FF6900", "#694489"]);'</span><span class="w">

</span><span class="n">net</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">forceNetwork</span><span class="p">(</span><span class="n">Links</span><span class="p">,</span><span class="w"> </span><span class="n">Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"from"</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"to"</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"value"</span><span class="p">,</span><span class="w"> 
             </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAs</span><span class="p">,</span><span class="w"> </span><span class="n">NodeID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"label"</span><span class="p">,</span><span class="w"> </span><span class="n">Nodesize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"size"</span><span class="p">,</span><span class="w"> </span><span class="n">Group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"island"</span><span class="p">,</span><span class="w">
             </span><span class="n">fontFamily</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Poppins"</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">350</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">650</span><span class="p">,</span><span class="w"> </span><span class="n">bounded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
             </span><span class="n">colourScale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JS</span><span class="p">(</span><span class="n">pal</span><span class="p">))</span><span class="w">

</span><span class="n">saveNetwork</span><span class="p">(</span><span class="n">net</span><span class="p">,</span><span class="w"> </span><span class="s2">"../img/0025-networkD3.html"</span><span class="p">,</span><span class="w"> </span><span class="n">selfcontained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span></code></pre></figure>

<p>In the code above I’ve saved the resulting HTML to a file (and folders containing the various other assets eg JavaScript).  This file is basically ready to go, but as a final touch I want to insert a line into the header, just above the <code class="language-plaintext highlighter-rouge">&lt;/head&gt;</code> tag, calling in the Cascading Style Sheets used in my blog, including the “Poppins” font from Google Fonts.  You’ll have seen in the code above that I told the D3 network chart to use Poppins font, but unless it knows where to find it it can’t do anything with this.  I also wanted to insert a heading into the body; my intended use for this HTML page was to be placed in an iframe in this blog post, and for visual coherence it needs a heading inside the iframe.</p>

<p>So I read the HTML back into R, insert the lines I want by find and replace with the <code class="language-plaintext highlighter-rouge">gsub()</code> function, and write it back to file, and I’ve managed to avoid editing any HTML by hand (useful if there are going to be lots of iterations during development).</p>

<p>These last few snippets of code would need to be adapted to your particular folder structure, fonts and CSS if you want to copy them.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readLines</span><span class="p">(</span><span class="s2">"../img/0025-networkD3.html"</span><span class="p">)</span><span class="w">

</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s1">'&lt;/head&gt;'</span><span class="p">,</span><span class="w"> 
            </span><span class="s1">'&lt;link href="/css/bootstrap-theme.min.css" rel ="stylesheet"&gt;&lt;/head&gt;'</span><span class="p">,</span><span class="w"> 
            </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s1">'&lt;div id="htmlwidget_container"&gt;'</span><span class="p">,</span><span class="w">
            </span><span class="s1">'&lt;h3&gt;Residents in one area, working in another&lt;/h3&gt;
            &lt;div id="htmlwidget_container"&gt;'</span><span class="p">,</span><span class="w">
            </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
            
</span><span class="n">writeLines</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="s2">"../img/0025-networkD3.html"</span><span class="p">)</span></code></pre></figure>

<p>If anyone’s wondering why Wellington has so many inbound commuters compared to Auckland, which is much larger, it’s just an artefact of boundaries.  Wellington Region is divided into a number of smaller cities and regions which show up in this sort of data, whereas the Auckland region is a single territorial authority.</p>

<p>C’est tout.</p>

<h3 id="edits">Edits</h3>
<p>Edited 27/12/2015 so the numbers in the tooltip labels include the sums of commuters even when less than 100 - incorrectly omitted in the first version.  I now use the pre-filtered <code class="language-plaintext highlighter-rouge">TravelAll</code> object for creating the labels.  This doesn’t make any visual difference, but the numbers were understated before.</p>


		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2015/12/21/m3-and-x13">X13-SEATS-ARIMA as an automated forecasting tool</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2015/12/29/Rrobot-born">A (not too talkative) twitterbot is born</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<hr></hr>
			
			<p>My day job is Director of the <a href='https://sdd.spc.int/'>Statistics for Development Division</a> at the Pacific Community, the principal scientific and technical organisation in the Pacific region, proudly supporting development since 1947. We are an international development organisation owned and governed by our 27 country and territory members. This blog is not part of my role there and contains my personal views only.</p>
		
		    <hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="https://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="https://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics https://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>