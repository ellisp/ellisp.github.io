      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Reproducing and adapting the UN Population Projections</title>
      	
         
         
            <meta name ="description" content ="I have a mostly successful go at cohort component population projections to replicate the UN's totals from their published parts, with an idea to making small changes to observations or assumptions that can build on the official projections.">
            <meta property="og:description" content ="I have a mostly successful go at cohort component population projections to replicate the UN's totals from their published parts, with an idea to making small changes to observations or assumptions that can build on the official projections.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Reproducing and adapting the UN Population Projections" />
         
            <meta property="og:image" content="https:/freerangestats.info/img/0262-vanuatu-pyramid.png" />
         
		 
			<meta property="og:url" content="https://freerangestats.info/blog/2024/05/05/pop-projections.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
	        <!--	  <li><a href="/blog/most-popular.html">ordered by popularity</a></li> -->
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                  <li><a href="/blog/surveys.html">all posts on surveys</a></li> 
				  <li><a href = /blog/2025/11/30/pacific-population>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
				  <li><a href = "/covid-tracking/index.html">Covid-19 in Australia</a></li>
                  <li><a href = "/elections/nz-2020/index.html">NZ election 2020</a></li>
                  <li><a href = "/elections/oz-2019/index.html">Australia federal election 2019</a></li>
				  <li><a href = "/elections/nz-2017/combined.html">NZ election 2017</a></li>
                  <li><a href="/blog/voting.html">all blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Reproducing and adapting the UN Population Projections</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>I have a mostly successful go at cohort component population projections to replicate the UN's totals from their published parts, with an idea to making small changes to observations or assumptions that can build on the official projections.</p>
	   <p class="meta">05 May 2024</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <p>I set out to see if it was possible to reproduce the UN’s <a href="https://population.un.org/wpp/">2022 Revision of World Population Prospects</a> for a given country by cohort component projection from the fertility, mortality and immigration rates and population starting point published as part of their projection. The motivation is to make small changes to some of those parameters - for example by substituting in a recent census result for the population and a given year - and “re-run” the projections to see the impact of changes, or to get a more up-to-date version with data that wasn’t available to the UN at the time of their projection.</p>

<p>It turns out this wasn’t too hard (one morning’s work for the modelling, then a few hours of write-up), particularly in cases where migration is small in the projection period. I was able to reproduce almost exactly population, birth and death totals to 2100 for Vanuatu, and demonstrate the impact of updating the 2020 year for their recent census population totals and fertility rates, and getting a slightly lower projection as a result.</p>

<p>Here’s my reproduction of Vanuatu’s population projection from 2020 to 2100, using just the 2020 population totals and the forecast fertility, mortality and migration rates. As you can see it’s basically identical to the UN totals:</p>

<object type="image/svg+xml" data="/img/0262-vanuatu-pop.svg" width="100%"><img src="/img/0262-vanuatu-pop.png" width="100%" /></object>

<p>And here’s the same method tweaked for the actual 2020 census total and with a rough adjustment made to fertility rates based on what was observed at the 2020 census:</p>

<object type="image/svg+xml" data="/img/0262-vanuatu-revised.svg" width="100%"><img src="/img/0262-vanuatu-revised.png" width="100%" /></object>

<p>Of course, this method delivers a full set of projections by age and sex, and we could construct life tables or any indicators we want from it. Here are population pyramids comparing the published UN projections for 2050 with my revised set. Not visually stunning in its comparison, but enough to prove that it’s possible:</p>

<object type="image/svg+xml" data="/img/0262-vanuatu-pyramid.svg" width="100%"><img src="/img/0262-vanuatu-pyramid.png" width="100%" /></object>

<h2 id="reproducing-un-projections">Reproducing UN projections</h2>

<p>So here’s how I went about that.</p>

<p>First, downloading all the data. The UN recommend bulk downloads of their CSV files. For my purposes I first need the fertility, mortality and population by sex and one year age groups. Of the population original data I am only going to use the 2020 year, and then project it forward myself based on fertility, mortality and migration; but I want the full set for comparison purposes. For migration, I couldn’t see in my hasty look at the UN site a dataset of migration projections by age and sex, so I just use the much simpler net migration rate (per thousand people) per year in the projection period. Here’s code to download all this UN data:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">glue</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">patchwork</span><span class="p">)</span><span class="w">

</span><span class="n">dir.create</span><span class="p">(</span><span class="s2">"data-pop-proj-2022"</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1">#------------------download and import data for all countries from existing projections----------------</span><span class="w">
</span><span class="n">list.files</span><span class="p">(</span><span class="s2">"data-pop-proj-2022"</span><span class="p">)</span><span class="w">

</span><span class="n">files</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"WPP2022_Fertility_by_Age1.zip"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"WPP2022_DeathsBySingleAgeSex_Medium_1950-2021.zip"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"WPP2022_DeathsBySingleAgeSex_Medium_2022-2100.zip"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"WPP2022_Population1JanuaryBySingleAgeSex_Medium_1950-2021.zip"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"WPP2022_Population1JanuaryBySingleAgeSex_Medium_2022-2100.zip"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"WPP2022_Demographic_Indicators_Medium.zip"</span><span class="w">
           </span><span class="p">)</span><span class="w">

</span><span class="c1"># let downloads take up to 10 minutes rather than 1 minute max, as files are</span><span class="w">
</span><span class="c1"># large (largest is fertility for single age, 78MB)</span><span class="w">
</span><span class="n">options</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="m">600</span><span class="p">)</span><span class="w">

</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file.exists</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_Demographic_Indicators_Medium.csv"</span><span class="p">)){</span><span class="w">
  </span><span class="c1"># download the zip files:</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">files</span><span class="p">)){</span><span class="w">
    </span><span class="n">download.file</span><span class="p">(</span><span class="n">glue</span><span class="p">(</span><span class="s2">"https://population.un.org/wpp/Download/Files/1_Indicators%20(Standard)/CSV_FILES/{files[i]}"</span><span class="p">),</span><span class="w">
                   </span><span class="n">destfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glue</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/{files[i]}"</span><span class="p">),</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wb"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># unzip them</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">files</span><span class="p">)){</span><span class="w">
    </span><span class="n">unzip</span><span class="p">(</span><span class="n">glue</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/{files[i]}"</span><span class="p">),</span><span class="w"> </span><span class="n">exdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"data-pop-proj-2022"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">fert_all</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_Fertility_by_Age1.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">mort_past</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_DeathsBySingleAgeSex_Medium_1950-2021.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">mort_future</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_DeathsBySingleAgeSex_Medium_2022-2100.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">pop_past</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_Population1JanuaryBySingleAgeSex_Medium_1950-2021.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">pop_future</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_Population1JanuaryBySingleAgeSex_Medium_2022-2100.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">indicators</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"data-pop-proj-2022/WPP2022_Demographic_Indicators_Medium.csv"</span><span class="p">)</span><span class="w">

</span><span class="n">mort_all</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">mort_past</span><span class="p">,</span><span class="w"> </span><span class="n">mort_future</span><span class="p">)</span><span class="w">
</span><span class="n">pop_all</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">pop_past</span><span class="p">,</span><span class="w"> </span><span class="n">pop_future</span><span class="p">)</span><span class="w">

</span><span class="c1"># clean up</span><span class="w">
</span><span class="n">rm</span><span class="p">(</span><span class="n">mort_past</span><span class="p">,</span><span class="w"> </span><span class="n">mort_future</span><span class="p">,</span><span class="w"> </span><span class="n">pop_past</span><span class="p">,</span><span class="w"> </span><span class="n">pop_future</span><span class="p">)</span></code></pre></figure>

<p>Next, I wrote my own cohort component population projection function. I wanted to do this from scratch rather than using an existing demography package to make sure I understood what was happening (I’m not a demographer) and could make tweaks as necessary to match the UN approach. I used <a href="https://farid-flici.github.io/tuto.html">this tutorial</a> by Farid Flici as my starting point; abstracted his code into a function for easy use with multiple countries, and added a net migration component.</p>

<p>Because migrants’ ages tend to be dissimilar from the country they are migrating too - they are more likely to be in the prime of their working / family life I believe - I needed a way to set the ages of migrants. In the function below I defaulted to a normal distribution of ages, mean 28 and standard deviation 11, which worked well to get similar results to the UN in a few countries I tried. This was the hardest and most discretionary part of the exercise.</p>

<p>My observation is that demographers seem to think in terms of matrices of numbers rather than database-oriented tidy data, and I have kept that matrix approach in this function.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#----------------------projections for one country-------------------</span><span class="w">

</span><span class="c1"># adapting the implementation of the method for cohort component projection at </span><span class="w">
</span><span class="c1"># https://farid-flici.github.io/tuto.html</span><span class="w">


</span><span class="cd">#' @param start_pop_m is a vector of population of males at single year age</span><span class="w">
</span><span class="cd">#'   periods beginning of year starting age 0</span><span class="w">
</span><span class="cd">#' @param start_pop_f as start_pop_m but for females</span><span class="w">
</span><span class="cd">#' @param start_year first year ie the year for which the actual population</span><span class="w">
</span><span class="cd">#'   number refers to</span><span class="w">
</span><span class="cd">#' @param end_year end year for the population projection</span><span class="w">
</span><span class="cd">#' @param fertility a matrix with rows for female agegroups 15 to 49 and a</span><span class="w">
</span><span class="cd">#'   column for each year, values are births per woman (not per thousand women)</span><span class="w">
</span><span class="cd">#'   that year and age. Must have 35 rows and number of columns equal to</span><span class="w">
</span><span class="cd">#'   end_year minus start_year plus one.</span><span class="w">
</span><span class="cd">#' @param mort_m a matrix with rows for age 0 to at least 50 and columns for</span><span class="w">
</span><span class="cd">#'   each year, for males. Must have number of columns equal to end_year minus</span><span class="w">
</span><span class="cd">#'   start_year plus one.</span><span class="w">
</span><span class="cd">#' @param mort_f as mort_m but for females. Must have same number of rows and</span><span class="w">
</span><span class="cd">#'   columns as mort_m.</span><span class="w">
</span><span class="cd">#' @param sex_ratio_birth number of boys born for every girl born, vector with</span><span class="w">
</span><span class="cd">#'   length of years to be projected.</span><span class="w">
</span><span class="cd">#' @param net_migration vector of proportions of the population that migrate to</span><span class="w">
</span><span class="cd">#'   the country, net of those who leave. Defaults to a vector of zeroes.</span><span class="w">
</span><span class="cd">#' @param female_share_migration vector of proportions of net migrants that are</span><span class="w">
</span><span class="cd">#'   female. Defaults to a vector of 0.5s.</span><span class="w">
</span><span class="cd">#' @param migration_age_weights vector of relative distribution of the age of</span><span class="w">
</span><span class="cd">#'   net migrants. Must be 121 values representing relative proportion of net</span><span class="w">
</span><span class="cd">#'   migrants aged zero to 120. Defaults to a normal distribution of mean 28 and</span><span class="w">
</span><span class="cd">#'   standard deviation 11. Note that this distribution currently must be the</span><span class="w">
</span><span class="cd">#'   same through the projection period (unlike eg fertility and mortality,</span><span class="w">
</span><span class="cd">#'   which have individual values for each age group and sex for each year).</span><span class="w">
</span><span class="cd">#'   Only the total net migration proportion can change over time, not its age</span><span class="w">
</span><span class="cd">#'   make-up.</span><span class="w">
</span><span class="cd">#' @author Peter Ellis, expanding on a less-featured example by Farid Flici</span><span class="w">
</span><span class="cd">#'   https://farid-flici.github.io/tuto.html</span><span class="w">
</span><span class="n">pop_proj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">start_pop_m</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">start_pop_f</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">start_year</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">end_year</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">fertility</span><span class="p">,</span><span class="w"> 
                     </span><span class="n">mort_m</span><span class="p">,</span><span class="w">
                     </span><span class="n">mort_f</span><span class="p">,</span><span class="w">
                     </span><span class="n">sex_ratio_birth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1.045</span><span class="p">,</span><span class="w"> </span><span class="n">end_year</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_year</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
                     </span><span class="n">net_migration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">end_year</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_year</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
                     </span><span class="n">female_share_migration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">end_year</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_year</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
                     </span><span class="n">migration_age_weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dnorm</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">120</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11</span><span class="p">)</span><span class="w">
                     </span><span class="p">){</span><span class="w">
  
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">fertility</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">35</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">migration_age_weights</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">121</span><span class="p">)</span><span class="w">
  
  </span><span class="n">ncols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">end_year</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_year</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
  
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">fertility</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">mort_m</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">mort_f</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">start_pop_m</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">50</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">start_pop_m</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">120</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">start_pop_f</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">50</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">start_pop_f</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">120</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">net_migration</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">sex_ratio_birth</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">female_share_migration</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">female_share_migration</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">female_share_migration</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
  
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">mort_m</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">mort_f</span><span class="p">))</span><span class="w">
  
  </span><span class="c1"># fill in with high probability of death for ages beyond where we have mortality data</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">mort_m</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">121</span><span class="p">){</span><span class="w">
    </span><span class="n">extra_deaths_m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">mort_m</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">121</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">mort_m</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncol</span><span class="p">(</span><span class="n">mort_m</span><span class="p">))</span><span class="w">
    </span><span class="n">extra_deaths_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">mort_f</span><span class="p">),</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">121</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">mort_f</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncol</span><span class="p">(</span><span class="n">mort_f</span><span class="p">))</span><span class="w">
    
    </span><span class="n">mort_m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">mort_m</span><span class="p">,</span><span class="w"> </span><span class="n">extra_deaths_m</span><span class="p">)</span><span class="w">
    </span><span class="n">mort_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">mort_f</span><span class="p">,</span><span class="w"> </span><span class="n">extra_deaths_f</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Create matrices for male and female population for the full projections</span><span class="w">
  </span><span class="c1"># each row of the matrix is an age group, each column is a year</span><span class="w">
  </span><span class="n">PopM</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">121</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">PopF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="o">=</span><span class="m">121</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  </span><span class="n">deaths</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w">
  
  </span><span class="n">rownames</span><span class="p">(</span><span class="n">PopF</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">PopM</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">120</span><span class="p">)</span><span class="w">                </span><span class="c1"># ages</span><span class="w">
  </span><span class="n">colnames</span><span class="p">(</span><span class="n">PopF</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">PopM</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">start_year</span><span class="o">:</span><span class="n">end_year</span><span class="p">)</span><span class="w">  </span><span class="c1"># years</span><span class="w">
  
  </span><span class="c1"># first year gets populated with the actual population numbers that we have:</span><span class="w">
  </span><span class="n">PopM</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">start_pop_m</span><span class="p">),</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">start_pop_m</span><span class="w">
  </span><span class="n">PopF</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">start_pop_f</span><span class="p">),</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">start_pop_f</span><span class="w">
  
  </span><span class="c1"># subsequent years get modified by people aging one year, deaths, births, and net migration</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ncols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    
    </span><span class="c1"># Age one and above:</span><span class="w">
    </span><span class="n">PopM</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">121</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">PopM</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">120</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mort_m</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">120</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">])</span><span class="w">
    </span><span class="n">PopF</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">121</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">PopF</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">120</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mort_f</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">120</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">])</span><span class="w">
    
    </span><span class="n">deaths</span><span class="p">[</span><span class="n">i</span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">])</span><span class="w">
    
    
    </span><span class="c1"># migration. </span><span class="w">
    </span><span class="n">total_migrants</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">PopM</span><span class="p">[,</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">PopF</span><span class="p">[,</span><span class="n">i</span><span class="p">]))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">net_migration</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
    </span><span class="n">migf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total_migrants</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">female_share_migration</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">migration_age_weights</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">migration_age_weights</span><span class="p">)</span><span class="w">
    </span><span class="n">migm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total_migrants</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">female_share_migration</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">migration_age_weights</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">migration_age_weights</span><span class="p">)</span><span class="w">
    
    </span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">migm</span><span class="w">
    </span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">migf</span><span class="w">
    
    
    </span><span class="c1"># Age zero ie births. Fertility rate by the number of women in the middle of the previous year.</span><span class="w">
    </span><span class="c1"># Note that PopF rows 16:50 equates to women age 15:49</span><span class="w">
    </span><span class="n">reproducing_women</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">PopF</span><span class="p">[</span><span class="m">16</span><span class="o">:</span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PopF</span><span class="p">[</span><span class="m">16</span><span class="o">:</span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="w">
    
    </span><span class="n">prop_boys</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sex_ratio_birth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sex_ratio_birth</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">          
    </span><span class="n">prop_girls</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prop_boys</span><span class="w">
    
    </span><span class="n">PopM</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">reproducing_women</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">fertility</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_boys</span><span class="w">
    
    </span><span class="n">PopF</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">reproducing_women</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">fertility</span><span class="p">[,</span><span class="w"> </span><span class="n">i</span><span class="m">-1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prop_girls</span><span class="w"> 

  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Return a list of the two matrices</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="w">
    </span><span class="n">PopM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PopM</span><span class="p">,</span><span class="w">
    </span><span class="n">PopF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PopF</span><span class="p">,</span><span class="w">
    </span><span class="n">deaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deaths</span><span class="w">
  </span><span class="p">))</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Next, I wrote a function to extract the necessary fertility, mortality, migration rates and 2020 starting population from the UN data, feed it into my <code class="language-plaintext highlighter-rouge">pop_proj()</code> function and return the result. Unlike <code class="language-plaintext highlighter-rouge">pop_proj()</code>, which is to some degree fully portable, this function is very much specific to this particular project and is really just a convenience function for grabbing the data and turning it into the right units and shapes (vectors and matrices) needed for <code class="language-plaintext highlighter-rouge">pop_proj()</code>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">repeat_un_proj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">the_country</span><span class="p">,</span><span class="w"> </span><span class="n">the_years</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2020</span><span class="o">:</span><span class="m">2100</span><span class="p">){</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">the_country</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">indicators</span><span class="o">$</span><span class="n">Location</span><span class="p">)){</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"Country not found"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="n">this_fert</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fert_all</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">the_years</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># Age-Specific Fertility rate</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">,</span><span class="w"> </span><span class="n">ASFR</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">Time</span><span class="p">),</span><span class="w">
           </span><span class="c1"># turn into proportions, not rates per 1000:</span><span class="w">
           </span><span class="n">ASFR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASFR</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">id_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">,</span><span class="w"> </span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASFR</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">as.matrix</span><span class="p">()</span><span class="w">
  
  </span><span class="c1"># should be 35 rows ie fertilities for ages 15 to 49</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">this_fert</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">35</span><span class="p">)</span><span class="w">
  </span><span class="c1"># should be 81 columns, 1 column for each year from 2020 to 2100</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">this_fert</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">the_years</span><span class="p">))</span><span class="w">
  
  
  </span><span class="c1"># Mortality is in numbers not a ratio so we need to join to the population data to turn it into a ratio</span><span class="w">
  </span><span class="n">pop_years</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop_all</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">the_years</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">PopMale</span><span class="p">,</span><span class="w"> </span><span class="n">PopFemale</span><span class="p">,</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">)</span><span class="w">

  </span><span class="n">this_mort</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mort_all</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">the_years</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">left_join</span><span class="p">(</span><span class="n">pop_years</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Time"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AgeGrp"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># next step important because we will be sorting by AgeGrp</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">AgeGrp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">case_when</span><span class="p">(</span><span class="w">
      </span><span class="n">AgeGrp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"100+"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
      </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">AgeGrp</span><span class="p">)))</span><span class="w">
    </span><span class="p">))</span><span class="w">
  
    
    
  </span><span class="n">this_mort_m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">this_mort</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># sometimes more deaths than people (eg 1 death, 0 people) so cap the death ratio at 1</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">DeathMale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmin</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">DeathMale</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PopMale</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">,</span><span class="w"> </span><span class="n">DeathMale</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">Time</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">id_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">,</span><span class="w"> </span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeathMale</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">as.matrix</span><span class="p">()</span><span class="w">
  
  </span><span class="n">this_mort_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">this_mort</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">DeathFemale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmin</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">DeathFemale</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PopFemale</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">,</span><span class="w"> </span><span class="n">DeathFemale</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">Time</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">id_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AgeGrp</span><span class="p">,</span><span class="w"> </span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeathFemale</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">as.matrix</span><span class="p">()</span><span class="w">
  
  </span><span class="c1"># check the years are correct, didn't get mangled or reordered</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">all</span><span class="p">(</span><span class="n">colnames</span><span class="p">(</span><span class="n">this_mort_f</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_years</span><span class="p">))</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">all</span><span class="p">(</span><span class="n">colnames</span><span class="p">(</span><span class="n">this_mort_m</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_years</span><span class="p">))</span><span class="w">
  
  </span><span class="n">this_pop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop_all</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">the_years</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="c1"># next step important because we will be sorting by AgeGrp</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">AgeGrp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">case_when</span><span class="p">(</span><span class="w">
      </span><span class="n">AgeGrp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"100+"</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
      </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">AgeGrp</span><span class="p">)))</span><span class="w">
    </span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">AgeGrp</span><span class="p">)</span><span class="w"> 
  
  </span><span class="c1"># convert to units, not thousands of people:</span><span class="w">
  </span><span class="n">this_pop_m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">this_pop</span><span class="o">$</span><span class="n">PopMale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="w">
  </span><span class="n">this_pop_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">this_pop</span><span class="o">$</span><span class="n">PopFemale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="w">
  
  </span><span class="c1"># reality check</span><span class="w">
  </span><span class="c1"># Population in millions; should be about 0.3 if the_country is Vanuatu, about 1400 if India:</span><span class="w">
  </span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">this_pop_m</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">this_pop_f</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1e6</span><span class="w">
  
  </span><span class="c1"># net migration</span><span class="w">
  </span><span class="n">this_cnmr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">the_years</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">Time</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">pull</span><span class="p">(</span><span class="n">CNMR</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="w">
  
  </span><span class="c1"># sex ratio at birth</span><span class="w">
  </span><span class="n">this_srb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">the_years</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">Time</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">pull</span><span class="p">(</span><span class="n">SRB</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="w">
  
  </span><span class="n">this_proj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop_proj</span><span class="p">(</span><span class="w">
                  </span><span class="n">start_pop_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_pop_m</span><span class="p">,</span><span class="w"> 
                  </span><span class="n">start_pop_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_pop_f</span><span class="p">,</span><span class="w"> 
                  </span><span class="n">start_year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">the_years</span><span class="p">),</span><span class="w"> 
                  </span><span class="n">end_year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">the_years</span><span class="p">),</span><span class="w"> 
                  </span><span class="n">fertility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_fert</span><span class="p">,</span><span class="w"> 
                  </span><span class="n">mort_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_mort_m</span><span class="p">,</span><span class="w">
                  </span><span class="n">mort_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_mort_f</span><span class="p">,</span><span class="w">
                  </span><span class="n">net_migration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_cnmr</span><span class="p">,</span><span class="w">
                  </span><span class="n">sex_ratio_birth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_srb</span><span class="w">
    
  </span><span class="p">)</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">un_proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_proj</span><span class="p">,</span><span class="w">
         </span><span class="n">un_pop_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_pop_m</span><span class="p">,</span><span class="w">
         </span><span class="n">un_pop_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_pop_f</span><span class="p">,</span><span class="w">
         </span><span class="n">un_fert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_fert</span><span class="p">,</span><span class="w">
         </span><span class="n">un_mort_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_mort_m</span><span class="p">,</span><span class="w">
         </span><span class="n">un_mort_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_mort_f</span><span class="p">,</span><span class="w">
         </span><span class="n">un_cnmr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_cnmr</span><span class="p">,</span><span class="w">
         </span><span class="n">un_srb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_srb</span><span class="p">))</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Note that this function returns, in addition to the results of the population projection, the various inputs in their correct units and shape. This will be useful later when we want to modify some of those inputs.</p>

<p>Now that we’ve got these functions, using them to do projections from 2020 and compare those projections to the published numbers is pretty straight forward. Here’s the code to do that for Vanuatu, which produces the first chart at the top of this blog post:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">the_country</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Vanuatu"</span><span class="w">
</span><span class="n">my_proj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">repeat_un_proj</span><span class="p">(</span><span class="n">the_country</span><span class="p">)</span><span class="o">$</span><span class="n">un_proj</span><span class="w">

</span><span class="c1"># total population</span><span class="w">
</span><span class="n">comp_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="m">2020</span><span class="o">:</span><span class="m">2100</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">`UN original`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TPopulation1Jan</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">`Reproduction`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">my_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">my_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w"> 

</span><span class="c1"># First year should be an exact match:</span><span class="w">
</span><span class="n">stopifnot</span><span class="p">(</span><span class="n">comp_data</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">`UN original`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">comp_data</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">Reproduction</span><span class="p">)</span><span class="w">


</span><span class="n">comp_data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Time</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comma</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_country</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Attempt to re-create the UN population projections from population in 2020, fertility and mortality rates"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Population"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span></code></pre></figure>

<object type="image/svg+xml" data="/img/0262-vanuatu-pop.svg" width="100%"><img src="/img/0262-vanuatu-pop.png" width="100%" /></object>

<p>As we can see the results are pretty much identical. Let’s look at my projected births and deaths based on fertility and mortality rates, and compare them to the published projected numbers</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># births</span><span class="w">
</span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="m">2020</span><span class="o">:</span><span class="m">2100</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">`UN original`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Births</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">Reproduction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">my_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">[</span><span class="m">1</span><span class="p">,]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">my_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Time</span><span class="p">)</span><span class="w">  </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_country</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Attempt to re-create the UN population projections from population in 2020, fertility and mortality rates"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Births (thousands)"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">

</span><span class="c1"># deaths</span><span class="w">
</span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="m">2020</span><span class="o">:</span><span class="m">2100</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">`UN original`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Deaths</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">Reproduction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">my_proj</span><span class="o">$</span><span class="n">deaths</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Time</span><span class="p">)</span><span class="w">  </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_country</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Attempt to re-create the UN population projections from population in 2020, fertility and mortality rates"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Deaths (thousands)"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span></code></pre></figure>

<object type="image/svg+xml" data="/img/0262-vanuatu-births.svg" width="100%"><img src="/img/0262-vanuatu-births.png" width="100%" /></object>
<object type="image/svg+xml" data="/img/0262-vanuatu-deaths.svg" width="100%"><img src="/img/0262-vanuatu-deaths.png" width="100%" /></object>

<p>I’m pretty happy with those. There’s definitely some discrepancies and a lag in the births which I suspect come down to how one treats populations of mothers - numbers on 1 January v 1 July, that sort of thing. But in the scheme of things these are very small.</p>

<p>Now, Vanuatu is relatively easy because the UN assumed net zero migration in the projection period. We can see this by comparing the net migration rates in their Indicators dataset for a few countries, with this code:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">plot_mig</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">the_country</span><span class="p">){</span><span class="w">
  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">the_country</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CNMR</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2022</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"steelblue"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"steelblue"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_country</span><span class="p">,</span><span class="w">
         </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Net migration rate per thousand people"</span><span class="p">,</span><span class="w">
         </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
         </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: UN World Population Prospects 2022"</span><span class="p">)</span><span class="w">
  
  </span><span class="nf">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">plot_mig</span><span class="p">(</span><span class="s2">"Vanuatu"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">plot_mig</span><span class="p">(</span><span class="s2">"Fiji"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">plot_mig</span><span class="p">(</span><span class="s2">"Australia"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">plot_mig</span><span class="p">(</span><span class="s2">"India"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">plot_layout</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span></code></pre></figure>

<object type="image/svg+xml" data="/img/0262-migration.svg" width="100%"><img src="/img/0262-migration.png" width="100%" /></object>

<p>For countries that have good data on it, migration is a big deal in the projections; but forecasting is hard, particularly of the future.</p>

<p>My first few goes at reproducing the projections for Australia and India tended to be badly out because I had added in net migration evenly across the whole age distribution. My eventual solution, making net migration bell curved with an average age of 28, is a bit of a hack with the parameters chosen to make Australia’s projections come out right. Definitely a better method would be to have actual age-specific net migration forecasts. Whether such things are possible will very much depend on the country; it’s probably possible for Australia, but not for most of the countries I work with.</p>

<p>Here’s the final result comparing UN projections with mine for a few interesting countries:</p>

<object type="image/svg+xml" data="/img/0262-Australia-pop.svg" width="100%"><img src="/img/0262-Australia-pop.png" width="100%" /></object>
<object type="image/svg+xml" data="/img/0262-China-pop.svg" width="100%"><img src="/img/0262-China-pop.png" width="100%" /></object>
<object type="image/svg+xml" data="/img/0262-India-pop.svg" width="100%"><img src="/img/0262-India-pop.png" width="100%" /></object>

<h2 id="adjusting-the-starting-point">Adjusting the starting point</h2>

<p>Now, the whole point of this exercise was to see if we can plausibly adjust the starting point - say the population totals in 2020, or the forecast fertility rates - and say we are building on the UN’s projections to get our own.  Here’s my rough demo of how we might do that, again using the case of Vanuatu. Vanuatu’s 2020 census wasn’t available at the time of the UN’s 2022 population projections, so the actual population and fertility numbers for 2020 differ somewhat (of course) from what was projected.</p>

<p>For the below, I am relying on <a href="https://sdd.spc.int/digital_library/vanuatu-2020-national-population-and-housing-census-analytical-report-volume-2">the analytical report of the Vanuatu census</a>. On a quick glance I didn’t see a table of the actual total population by single year age and sex, so I just adjusted the UN’s projected totals by a factor to make them add up to the correct 2020 total males and females. Of course if we were doing this for real we’d get the real numbers straight from the census; I actually can do this easily enough at work but obviously for this blog wanted to use only easily accessible public data.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#-----------------changing one or two factors while keeping the rest the same--------------</span><span class="w">

</span><span class="c1"># Say we had the 2020 Vanuatu census so we knew the real population then, and wanted</span><span class="w">
</span><span class="c1"># to redo the population projections with everything staying as they were before</span><span class="w">


</span><span class="c1"># file:///C:/Users/Peter/Downloads/Vanuatu_2020_Census_Analytical_report_Vol_2.pdf</span><span class="w">
</span><span class="n">revision_country</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Vanuatu"</span><span class="w">
</span><span class="n">van_orig</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">repeat_un_proj</span><span class="p">(</span><span class="n">revision_country</span><span class="p">)</span><span class="w">

</span><span class="c1"># rough adjustment of starting population in 2020 to make totals match the Census totals.</span><span class="w">
</span><span class="c1"># In principle could of course use the actual numbers by single age category.</span><span class="w">
</span><span class="n">revised_pop_m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_pop_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">151597</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_pop_m</span><span class="p">)</span><span class="w">
</span><span class="n">revised_pop_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_pop_f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">148422</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_pop_f</span><span class="p">)</span><span class="w">

</span><span class="c1"># calculate the crude birth rate in the current projection</span><span class="w">
</span><span class="n">un_cbr_2020</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> 
  </span><span class="nf">sum</span><span class="p">(</span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="w">

</span><span class="c1"># make a rough adjustment of future fertility rates assuming they are "out" by the</span><span class="w">
</span><span class="c1"># same proportion that crude birth rate was out in 2020</span><span class="w">
</span><span class="n">adj_ratio</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">28.2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">un_cbr_2020</span><span class="w">
</span><span class="n">revised_fert</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_fert</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">adj_ratio</span><span class="w">

</span><span class="c1"># Refit the projection with the above rough adjustments:</span><span class="w">
</span><span class="n">revised_proj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop_proj</span><span class="p">(</span><span class="w">
  </span><span class="n">start_pop_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revised_pop_m</span><span class="p">,</span><span class="w">
  </span><span class="n">start_pop_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revised_pop_f</span><span class="p">,</span><span class="w">
  </span><span class="n">start_year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2020</span><span class="p">,</span><span class="w">
  </span><span class="n">end_year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2100</span><span class="p">,</span><span class="w">
  </span><span class="n">fertility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revised_fert</span><span class="p">,</span><span class="w">
  </span><span class="n">mort_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_mort_m</span><span class="p">,</span><span class="w">
  </span><span class="n">mort_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_mort_f</span><span class="p">,</span><span class="w">
  </span><span class="n">sex_ratio_birth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_srb</span><span class="p">,</span><span class="w">
  </span><span class="n">net_migration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_cnmr</span><span class="p">)</span><span class="w">


</span><span class="n">projected_pop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">revised_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">revised_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">)</span><span class="w">

</span><span class="c1">#-----------------Compare total population----------------</span><span class="w">
</span><span class="n">comp_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">indicators</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">revision_country</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Variant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Medium"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="m">2020</span><span class="o">:</span><span class="m">2100</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">`2022 UN projections`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TPopulation1Jan</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">`Revised with 2020 census`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">projected_pop</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">


</span><span class="n">p5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">comp_data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">2050</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Time</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variable</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revision_country</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Attempt to re-create the UN population projections from population in 2020, fertility and mortality rates"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Population"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">

</span><span class="c1">#--------------Compare population pyramids-------------------------</span><span class="w">
</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="w"> </span><span class="n">revised_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="m">31</span><span class="p">],</span><span class="w"> </span><span class="n">revised_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="m">31</span><span class="p">],</span><span class="w">   
                  </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_proj</span><span class="o">$</span><span class="n">PopM</span><span class="p">[,</span><span class="w"> </span><span class="m">31</span><span class="p">],</span><span class="w">  </span><span class="n">van_orig</span><span class="o">$</span><span class="n">un_proj</span><span class="o">$</span><span class="n">PopF</span><span class="p">[,</span><span class="w"> </span><span class="m">31</span><span class="p">]),</span><span class="w">
       </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Male"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Female"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Male"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Female"</span><span class="p">),</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">121</span><span class="p">),</span><span class="w">
       </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Revised projections with 2020 census, made in 2024"</span><span class="p">,</span><span class="w"> </span><span class="s2">"UN projections, made in 2022"</span><span class="p">),</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">242</span><span class="p">),</span><span class="w">
       </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">120</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">agef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_reorder</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">age</span><span class="p">),</span><span class="w"> </span><span class="n">age</span><span class="p">),</span><span class="w">
         </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_rev</span><span class="p">(</span><span class="n">model</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">

</span><span class="n">d</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Female"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">agef</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_col</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"brown"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_col</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Male"</span><span class="p">),</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"orange"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of people"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Comparison of UN original and revised population projections"</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Population age distribution in 2050"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-4000</span><span class="p">,</span><span class="w"> </span><span class="m">-2000</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2000</span><span class="p">,</span><span class="w"> </span><span class="m">4000</span><span class="p">),</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"4,000"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Male"</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"Female"</span><span class="p">,</span><span class="w"> </span><span class="s2">"4,000"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_discrete</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">5</span><span class="p">)</span></code></pre></figure>

<p>And that’s what gets us these results:</p>

<object type="image/svg+xml" data="/img/0262-vanuatu-revised.svg" width="100%"><img src="/img/0262-vanuatu-revised.png" width="100%" /></object>

<object type="image/svg+xml" data="/img/0262-vanuatu-pyramid.svg" width="100%"><img src="/img/0262-vanuatu-pyramid.png" width="100%" /></object>

<p>I’m hoping this might be actually useful for pragmatic updates of the UN population projections when more current data is available, without having to revise everything from scratch.</p>

<p>OK, that’s all for today.</p>


		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2023/10/17/mvi-and-v20">The 'V20' group of vulnerable countries and the MVI</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2024/07/27/aging-pacific">Population age changes in the Pacific</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>

			<p>My day job is Director of the <a href='https://sdd.spc.int/'>Statistics for Development Division</a> at the Pacific Community, the principal scientific and technical organisation in the Pacific region, proudly supporting development since 1947. We are an international development organisation owned and governed by our 27 country and territory members. This blog is not part of my role there and contains my personal views only.</p>
		
		    <hr></hr>
			
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<p>Find me on <a rel="me" href="https://bsky.app/profile/freerangestats.info">Bluesky</a> or <a rel="me" href="https://mastodon.social/@peter_ellis">Mastodon</a>.</p>
			<hr></hr>
			


       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="https://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			
			<p>I've never been an academic but have written a few small things and hence have a <a href='https://scholar.google.com/citations?view_op=list_works&hl=en&user=MEtLNDMAAAAJ'>Google Scholar profile</a></p>
			
			<p>I read a lot of books. In the unlikely event you want to see what I think about them or what I'm reading at the moment, <a href='https://www.goodreads.com/user/show/55517482-peter-ellis'>follow me on Goodreads</a>.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="https://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			
			<h4>Bluesky feed:</h3>
         <script src="https://cdn.jsdelivr.net/npm/bsky-embed/dist/bsky-embed.es.js" async></script>
<bsky-embed  
  username="freerangestats.info"  
  limit="5"  
>  
</bsky-embed>

    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics https://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>