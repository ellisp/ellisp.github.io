<h2 id="global-choropleth-maps">Global choropleth maps</h2>

<p>Today I’m writing about using country-level <a href="https://en.wikipedia.org/wiki/Choropleth_map">choropleth maps</a> at a global level, using example data showing nations’ military spending as a percentage of GDP.  There are a few specific issues to work through as a result of the global coverage.  I’m going to start with my two preferred end results.</p>

<p>First, here’s a Twitter-friendly rotating globe:</p>

<div>
<center>
<img src="/img/0099-military-gdp.gif" width="500px" />
</center>
</div>

<p>There are a few problems with it I didn’t quite finish.  If you watch it long enough you’ll see a few times Canada, the USA or Russia flicker out of the frame.  More on that below.</p>

<p>Second, here’s an interactive version, suited for a fully featured web browser:</p>

<iframe width="700" height="350" src="/img/0099-leaflet.html" frameborder="0" scrolling="no"></iframe>

<p>I find this the most useful version, even though I prefer to <em>look</em> at the rotating globe.  The ability to hover over a country to get its name and value, and to zoom into a particular region, adds real value to the visualization.  This is really the minimum people expect out of what I call micro-interactivity (I’m sure there’s a proper, technical name) - ability to zoom and get useful information when hovering.</p>

<p>Unless you spend a lot of time looking at maps of the Middle East, you probably wouldn’t have identified those two dark patches of high military spending as Oman and Eritrea, without the help of the hovering tooltips.</p>

<p>Caveat for today’s post - I’m not a GIS expert at all, and in fact am barely into the “conscious incompetence” stage.  So there may be mistakes in what follows, and there are almost certainly better ways to do some of what I’m doing.</p>

<h2 id="data-on-military-spend">Data on military spend</h2>

<p>First I needed some example data.  Choropleth maps are appropriate for variables like proportions and growth rates rather than absolute numbers.  Military spending as a percentage of GDP was <a href="https://www.nytimes.com/2017/05/26/world/europe/nato-trump-spending.html?_r=0">in the news</a> when I started this, because of USA President Trump drawing attention (in somewhat misleading terms) to the pledge by <a href="http://www.economist.com/blogs/graphicdetail/2017/02/daily-chart-11">NATO leaders in 2014</a> to spend 2% of their GDP on the military by 2024 (the 2% was described as an unofficial floor as early as 2006, but only committed to at <a href="http://carnegieeurope.eu/2015/09/02/politics-of-2-percent-nato-and-security-vacuum-in-europe-pub-61139">the leadership level in 2014</a> in the atmosphere of nervousness after Russia’s actions in the Ukraine).  With seven years to the commitment deadline, it is widely reported that only five countries have yet passed the 2% figure, <a href="https://www.nytimes.com/2017/05/26/world/europe/nato-trump-spending.html?_r=1">usually listed as the United States, Greece, United Kingdom, Estonia and Poland</a>.  Interestingly, the data I’m using suggest the UK is currently just under 2% and France just over, slightly different to some of the media reporting.</p>

<p>Often my first port of call looking for internationally comparable data is the <a href="http://data.worldbank.org/data-catalog/world-development-indicators">World Development Indicators</a> of the World Bank.  While they are the definitive origin of very little data, the World Bank does a great job in collating data from other sources and making it available in their visualisation tool.  There’s also Vincent Arel-Bundock’s handy <a href="https://CRAN.R-project.org/package=WDI">WDI R package</a> which makes it easy to get the data from the Bank into your own analytical tool.</p>

<p>When I started this exercise a couple of weeks ago, I was able to create this choropleth map from the very friendly WDI visualisation tool:</p>

<p><img src="/img/0099-wdi-screenshot.png" width="100%" /></p>

<p>(but interestingly, returning to <a href="http://data.worldbank.org/indicator/MS.MIL.XPND.GD.ZS?end=2014&amp;start=1960&amp;view=chart&amp;year=2011">the site</a> today, I can’t reproduce it).  Anyway, there’s a few things that leave me not happy with it:</p>

<ul>
  <li>The data only go to 2015, whereas the data from the source goes up to 2016 in many cases.</li>
  <li>The Mercator projection of the world map - according to <a href="https://xkcd.com/977/">xkcd’s brilliant summary of ‘what your favorite map projection says about you’</a>, Mercator says “you’re not really into maps”.  There are several problems, but for me it’s all summed up by Greenland looking way too large.</li>
  <li>There’s a great ability to use the slider at the bottom of the map (not in the above screenshot though) to cycle through the years, but the scale of the colour fill recalibrates itself each year so this doesn’t allow a coherent view of change over time.</li>
  <li>the colour scheme isn’t particularly good at drawing out differences between countries.</li>
</ul>

<p>So I went to the source, the <a href="https://www.sipri.org/">Stockholm International Peace Research Institute (SIPRI)</a>, who collate data from governments around the world into a Yearbook and publish <a href="https://www.sipri.org/databases/milex">the data</a> separately - at the time of writing, with data from 1949 to 2016, using the countries that exist in 2016 (ie no East Germany, Soviet Union, etc; data for the Russian Federation, Ukraine, etc begins in 1992 or soon after).</p>

<h2 id="data-exploration">Data exploration</h2>

<p>If we plot all the data for all the countries and years at once, it looks like this:</p>

<p><img src="/img/0099-all-countries.svg" width="100%" /></p>

<p>First thing you might notice is the massive spike.  That turns out to be Kuwait in 1991, when it spent 17 percent <em>more</em> than its GDP on military - the kind of thing that happens when you’re invaded and become the battleground for what in the USA is referred to as the First Gulf War.</p>

<p>In case you’re wondering, there’s no reason why a country can’t spend more than its GDP on the military (or anything else).  In fact, while they are both measured in dollars, GDP is not really the same sort of variable as spend.  GDP is the sum of value add of economic activity in the country.  If spending is on imported goods and services it can exceed GDP.  Similarly, while we see economic indicators like “exports as a percentage of GDP” in use (and it is a good indicator of the importance of trade), there’s no ceiling of that indicator at 100%, and countries like <a href="http://data.worldbank.org/indicator/NE.EXP.GNFS.ZS?locations=LU-HK-SG-MT-IE&amp;year_high_desc=true">Luxembourg, Singapore, Malta and Ireland do in fact exceed 100%</a>.</p>

<p>Here’s the code to download and import the SIPRI “military as a percentage of GDP” data into R and draw that first graph:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Load in all the packages we need for the full post
</span><span class="n">library</span><span class="p">(</span><span class="n">cshapes</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forcats</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">openxlsx</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">directlabels</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">countrycode</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">leaflet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rworldmap</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">maptools</span><span class="p">)</span><span class="w">

</span><span class="c1">#------------download------------
</span><span class="n">tf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tempfile</span><span class="p">()</span><span class="w">

</span><span class="n">download.file</span><span class="p">(</span><span class="s2">"https://www.sipri.org/sites/default/files/SIPRI-Milex-data-1949-2016.xlsx"</span><span class="p">,</span><span class="w">
              </span><span class="n">destfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wb"</span><span class="p">)</span><span class="w">

</span><span class="c1">#---------------import and tidy----------
</span><span class="n">sipri</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.xlsx</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Share of GDP"</span><span class="p">,</span><span class="w"> </span><span class="n">startRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">gather</span><span class="p">(</span><span class="n">Year</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Country</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">Notes</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">Value</span><span class="p">),</span><span class="w">
          </span><span class="n">Year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">Year</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Value</span><span class="p">))</span><span class="w">

</span><span class="c1">#----------------exploratory chart-----------
</span><span class="n">sipri</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Country</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Military expenditure as a percentage of GDP"</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Countries' and regions' expenditure on military as a percentage of GDP"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Stockholm International Peace Research Institute"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span></code></pre></figure>

<p>As further exploration, I picked the five so called <a href="https://en.wikipedia.org/wiki/Five_Eyes">“Five Eyes” countries</a>.  I have a little familiarity with their military history so thought this could be a useful way of checking I understood the data.  Here is military spend as a percentage of GDP for those five countries, with major conflicts they were involved in indicated in a timeline.</p>

<p><img src="/img/0099-fiveeyes.svg" width="100%" /></p>

<p>The dates of the conflicts are just taken from Wikipedia.</p>

<p>The spikes in spending clearly and unsurprisingly relate to conflicts or other known political events, most obviously:</p>

<ul>
  <li>The Korean war led to a big spike for all four countries that had data available.</li>
  <li>The surge in intensity (of their involvement) in the Vietnam war led to spikes for the USA and Australia.</li>
  <li>There was a blip in UK military spending at the time of the Falklands war, but it did not arrest the overall downwards trend, even more marked since significant military conflict in Northern Ireland finished.</li>
  <li>The early 1980s military boom for the USA was the Reagan administration ratcheting up the Cold War as well as militarily engaging in other countries in ways too numerous to show.</li>
  <li>The wars of the George W. Bush era in Afghanistan and Iraq, attempts to create a formal “War on Terror”, temporarily reversed the secular decline in the economic importance of US military spending.</li>
</ul>

<p>Code for drawing this chart (I’m not particularly happy with the manual data entry for the conflicts and their dates, but it will do for a one-off thing like this):</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">wid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.01</span><span class="w"> </span><span class="c1"># width of annotation bars
</span><span class="n">wars</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="w">
   </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w">          </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Malaysia"</span><span class="p">,</span><span class="w">  </span><span class="s2">"Korea"</span><span class="p">,</span><span class="w">     </span><span class="s2">"Aden"</span><span class="p">,</span><span class="w">        </span><span class="s2">"Vietnam"</span><span class="p">,</span><span class="w">   </span><span class="s2">"Northern Ireland"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Falklands"</span><span class="p">,</span><span class="w">  </span><span class="s2">"Gulf"</span><span class="p">,</span><span class="w">      </span><span class="s2">"Afghanistan"</span><span class="p">,</span><span class="w">  </span><span class="s2">"Iraq"</span><span class="p">),</span><span class="w">
   </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"15/6/1948"</span><span class="p">,</span><span class="w"> </span><span class="s2">"25/6/1950"</span><span class="p">,</span><span class="w"> </span><span class="s2">"10/12/1963"</span><span class="p">,</span><span class="w">  </span><span class="s2">"1/11/1955"</span><span class="p">,</span><span class="w"> </span><span class="s2">"1/1/1968"</span><span class="p">,</span><span class="w">         </span><span class="s2">"2/4/1982"</span><span class="w"> </span><span class="p">,</span><span class="w">  </span><span class="s2">"2/8/1990"</span><span class="p">,</span><span class="w">  </span><span class="s2">"7/10/2001"</span><span class="p">,</span><span class="w">   </span><span class="s2">"20/3/2003"</span><span class="p">),</span><span class="w"> 
                   </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%d/%m/%Y"</span><span class="p">),</span><span class="w">
   </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="n">as.Date</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"12/7/1960"</span><span class="p">,</span><span class="w"> </span><span class="s2">"27/7/1953"</span><span class="p">,</span><span class="w">  </span><span class="s2">"30/11/1967"</span><span class="p">,</span><span class="w"> </span><span class="s2">"30/4/1975"</span><span class="p">,</span><span class="w"> </span><span class="s2">"30/6/1998"</span><span class="p">,</span><span class="w">        </span><span class="s2">"14/6/1982"</span><span class="p">,</span><span class="w"> </span><span class="s2">"28/2/1991"</span><span class="p">,</span><span class="s2">"28/12/2014"</span><span class="p">,</span><span class="w">   </span><span class="s2">"18/12/2011"</span><span class="p">),</span><span class="w">
                   </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%d/%m/%Y"</span><span class="p">),</span><span class="w">
   </span><span class="n">lead</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="nf">c</span><span class="p">(</span><span class="s2">"UK"</span><span class="p">,</span><span class="w">         </span><span class="s2">"USA"</span><span class="p">,</span><span class="w">      </span><span class="s2">"UK"</span><span class="p">,</span><span class="w">            </span><span class="s2">"USA"</span><span class="p">,</span><span class="w">        </span><span class="s2">"UK"</span><span class="p">,</span><span class="w">              </span><span class="s2">"UK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"USA"</span><span class="p">,</span><span class="w">         </span><span class="s2">"USA"</span><span class="p">,</span><span class="w">         </span><span class="s2">"USA"</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">name_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">()</span><span class="o">:</span><span class="m">1</span><span class="p">,</span><span class="w">
          </span><span class="n">ystart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">name_seq</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.12</span><span class="p">,</span><span class="w"> 
          </span><span class="n">yend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ystart</span><span class="w"> </span><span class="o">+</span><span class="n">wid</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="n">countries</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Australia"</span><span class="p">,</span><span class="w"> </span><span class="s2">"New Zealand"</span><span class="p">,</span><span class="w"> </span><span class="s2">"USA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"UK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Canada"</span><span class="p">)</span><span class="w">
</span><span class="n">palette</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">brewer.pal</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="s2">"Set1"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">countries</span><span class="w">
   
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sipri</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">filter</span><span class="p">(</span><span class="n">Country</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">countries</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">YearDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"30/6/"</span><span class="p">,</span><span class="w"> </span><span class="n">Year</span><span class="p">),</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%d/%m/%Y"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_rect</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wars</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ystart</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yend</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lead</span><span class="p">),</span><span class="w">
             </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wars</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">yend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ystart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">),</span><span class="w">
             </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey50"</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nudge_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-200</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">YearDate</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Country</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Military expenditure as a percentage of GDP"</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">,</span><span class="w">
                      </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Selected countries' expenditure on military as a percentage of GDP"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"'Five eyes' countries only; periods also shown for conflicts in which they had material deployments"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
        </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Stockholm International Peace Research Institute"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">palette</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">palette</span><span class="p">,</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme_tufte</span><span class="p">(</span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme</span><span class="p">(</span><span class="n">plot.caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey50"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
   </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"1970/6/30"</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="m">0.145</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> 
            </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey50"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w">
            </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Not shown - Grenada, Panama, Balkans,\nLibya, Lebanon, Haiti and numerous smaller..."</span><span class="p">)</span><span class="w">

</span><span class="n">direct.label</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></code></pre></figure>

<h2 id="different-world-projections">Different world projections</h2>

<p>OK, time for maps.  First I wanted to sort out some projections for flat versions of the world.  <code class="highlighter-rouge">ggplot2</code> makes this convenient.  You can define a single map object, and just add a different version of <code class="highlighter-rouge">+ coord_map()</code> to it to get a different projection.  Here are two which worked quite nicely:</p>

<h3 id="globular-projection">Globular projection</h3>

<p>Projection with bilateral symmetry about the Prime Meridian and the equator.  Hemisphere is circle, circular arc meridians equally spaced on equator, circular arc parallels equally spaced on 0- and 90-degree meridians:</p>

<p><img src="/img/0099-globular.svg" width="100%" /></p>

<h3 id="orthographic-projection">Orthographic projection</h3>

<p>Viewed from infinity, centering on 20 degrees latitude, 20 degrees longitude:</p>

<p><img src="/img/0099-ortho.svg" width="100%" /></p>

<h3 id="code-for-the-basic-maps">Code for the basic maps</h3>

<p>There’s a bit of work to be done to join the military spend data to a map data.  Most importantly I need a country code.  The <code class="highlighter-rouge">countrycode</code> package is a great example of a specialist package that does one thing well; what it does is convert country names or codes between eachother.  For my use case, I want everything to be the ISO three character code (eg NZL for New Zealand).  Once this is done, all that is required is to create a flat ggplot-ready version of a map shape file and join the two data frames together.</p>

<p>In the code below I create a single ggplot2 object <code class="highlighter-rouge">worldmap</code> which is an un-projected world choropleth map complete with the information on colour scale (I use viridis inferno), legend, captions, etc.  Then I can add whatever projection I want (final two lines of code in the chunk below.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#===============map prep========================
</span><span class="n">sipri</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sipri</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countrycode</span><span class="p">(</span><span class="n">Country</span><span class="p">,</span><span class="w"> </span><span class="s2">"country.name"</span><span class="p">,</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="c1"># two manual concordances of country code:
</span><span class="w">   </span><span class="n">mutate</span><span class="p">(</span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">Country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Kosovo"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KOS"</span><span class="p">,</span><span class="w"> </span><span class="n">iso3c</span><span class="p">))</span><span class="w">

</span><span class="c1"># for some reason the tidyverse doesn't work for Central African Republic! 
# so we fix it old school:
</span><span class="n">sipri</span><span class="p">[</span><span class="n">sipri</span><span class="o">$</span><span class="n">Country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Central African Rep."</span><span class="p">,</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"CAF"</span><span class="w">

</span><span class="n">world</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map_data</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countrycode</span><span class="p">(</span><span class="n">region</span><span class="p">,</span><span class="w"> </span><span class="s2">"country.name"</span><span class="p">,</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">))</span><span class="w">

</span><span class="c1"># data on military for just the latest year for each country
</span><span class="n">the_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sipri</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">Country</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">filter</span><span class="p">(</span><span class="n">Year</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">Year</span><span class="p">))</span><span class="w">

</span><span class="c1"># using the help at http://ggplot2.tidyverse.org/reference/coord_map.html
</span><span class="w">
</span><span class="n">world2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">the_data</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">)</span><span class="w">

</span><span class="c1"># define a ggplot mapping object
</span><span class="n">worldmap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">world2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey75"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">-2</span><span class="o">:</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">-4</span><span class="o">:</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">45</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_fill_viridis</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"inferno"</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme_minimal</span><span class="p">(</span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"right"</span><span class="p">,</span><span class="w">
         </span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Military expenditure as a percentage of GDP"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"Most recent data shown for each country; mostly this is 2016"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Stockholm International Peace Research Institute"</span><span class="p">)</span><span class="w">

</span><span class="c1">#-------------single map, nice projection-------------------
# Lots of the projections in coord_map have problems with drawing
# polygons.  ok are: globular, harrison 
</span><span class="n">worldmap</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="n">coord_map</span><span class="p">(</span><span class="s2">"globular"</span><span class="p">)</span><span class="w">

</span><span class="n">worldmap</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="n">coord_map</span><span class="p">(</span><span class="s2">"orthographic"</span><span class="p">,</span><span class="w"> </span><span class="n">orientation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span></code></pre></figure>

<h2 id="animated-choropleth-over-time">Animated choropleth over time</h2>

<p>Remebering my reservations with the World Development Indicators site, one of my aims was to have a choropleth map that showed military expenditure as a proportion of GDP for different years, with colour on the same scale.  An animated graphic is the obvious way to do this:</p>

<p><img src="/img/0099-military-gdp-time.gif" width="100%" /></p>

<p>… but it has imperfections:</p>

<ul>
  <li>Because of the few year-country combinations with massive spikes (eg Kuwait in 1991), I needed to use a logarithm transform on the scale or everything looked the same colour.</li>
  <li>The slowly changing dimension of country existence proves a real problem, with data before the 1990s sadly lacking.</li>
  <li>Data existence in general tends to dominate the visual; so rather than a feel for how military expenditure changes over time, the impression one gets is of more data gradually becoming available over time.</li>
</ul>

<p>Not really a success.  Nonetheless, a nice idea (I think) and here’s the code that does it.  It’s basically the same idea as the previous chunk of code, but in a loop that repeats the data filtering and joining for each value of year, and saves a single frame for each printed annual map.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#================animated map over time===============
</span><span class="n">setwd</span><span class="p">(</span><span class="s2">"C:/temp1"</span><span class="p">)</span><span class="w"> </span><span class="c1"># or whatever folder you want to hold the frames in
</span><span class="n">years</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">sipri</span><span class="o">$</span><span class="n">Year</span><span class="p">)</span><span class="w">

</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">years</span><span class="p">){</span><span class="w">

   </span><span class="n">this_year_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sipri</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">group_by</span><span class="p">(</span><span class="n">Country</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">Year</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w">
   
   </span><span class="n">world2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">left_join</span><span class="p">(</span><span class="n">this_year_data</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">)</span><span class="w">
   
   </span><span class="n">worldmap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">world2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey75"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">-2</span><span class="o">:</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">-4</span><span class="o">:</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">45</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">scale_fill_viridis</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">,</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"inferno"</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">,</span><span class="w"> 
                         </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">range</span><span class="p">(</span><span class="n">sipri</span><span class="o">$</span><span class="n">Value</span><span class="p">),</span><span class="w"> </span><span class="n">trans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sqrt"</span><span class="p">,</span><span class="w">
                         </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">theme_minimal</span><span class="p">(</span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"right"</span><span class="p">,</span><span class="w">
            </span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">ggtitle</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Military expenditure as a percentage of GDP -"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Stockholm International Peace Research Institute"</span><span class="p">)</span><span class="w">
   
   </span><span class="n">png</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s2">".png"</span><span class="p">),</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">72</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">72</span><span class="p">)</span><span class="w">
      </span><span class="n">print</span><span class="p">(</span><span class="n">worldmap</span><span class="w"> </span><span class="o">+</span><span class="w">   </span><span class="n">coord_map</span><span class="p">(</span><span class="s2">"harrison"</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-75</span><span class="p">,</span><span class="w"> </span><span class="m">85</span><span class="p">)))</span><span class="w">
   </span><span class="n">dev.off</span><span class="p">()</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Use ImageMagick to convert all those PNG frames into a single animated GIF
# (requires ImageMagick to be separately installed)
</span><span class="n">system</span><span class="p">(</span><span class="s1">'magick -loop 0 -delay 40 *.png "0099-military-gdp-time.gif"'</span><span class="p">)</span></code></pre></figure>

<h2 id="animated-globe">Animated globe</h2>

<p>Finally, on to the two “good” versions of the data.  Here’s a reminder of the animated globe:</p>

<div>
<center>
<img src="/img/0099-military-gdp.gif" width="500px" />
</center>
</div>

<p>The strategy is to create 360 different snapshots of the globe, each one 1 degree changed in longitude and latitude from the previous.  Longitude moves 1 degree each frame in the same direction, latitude meanders from 30 degrees north to 30 degrees south and back again.</p>

<p>I had to leave the <code class="highlighter-rouge">ggplot2</code> universe to do this (but I’m not <em>sure</em> I had to).  I couldn’t get my projections of the ggplot2 version of the globe to work with enough values of latitude and longitude as the centre point.  Whenever one of the larger countries like Russia, China or Canada was split in two ggplot2 would draw the polygons in ugly ways.  My best effort can be seen in <a href="https://twitter.com/ellis2013nz/status/868763709367123968">this tweet</a> - which also has some very useful comments and suggestions in response.</p>

<p>In the end I adapted the suggestion of Edzer Pebesma, which is included in a demo in his amazing <code class="highlighter-rouge">sf</code> package.  I don’t really understand exactly how it successfully clips the polygons, but it works nearly entirely well.</p>

<p>There were still quite a few frames where countries went missing altogether for the wrong combination of latitude and longitude.  Experimenting with different versions of world maps, I found that some were vulnerable to different combinations from others.  To reduce the problem, I made each frame of the end animation actually two globes of countries drawn on top of eachother - to increase the chance that at least one of the maps draws each country.  This reduced the missing country problem to only three or four frames.</p>

<p>Here’s the code that does that:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#------------sf approach------------------
# this solution came from the demo in the sf package, tweeted about at
# https://twitter.com/edzerpebesma/status/835249468874321920
</span><span class="n">circ</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-180</span><span class="o">:</span><span class="m">180</span><span class="p">),</span><span class="w"> </span><span class="n">lon0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">lat0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="n">deg2rad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">180</span><span class="w">
   </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">atan</span><span class="p">(</span><span class="o">-</span><span class="nf">cos</span><span class="p">((</span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lon0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">deg2rad</span><span class="p">)</span><span class="o">/</span><span class="nf">tan</span><span class="p">(</span><span class="n">lat0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">deg2rad</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">deg2rad</span><span class="w">
   </span><span class="n">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lat0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">l</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">90</span><span class="w">
      </span><span class="n">l</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">90</span><span class="w">
      </span><span class="n">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">1</span><span class="p">,</span><span class="m">-90</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">2</span><span class="p">,</span><span class="m">-90</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">2</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">2</span><span class="p">,</span><span class="m">90</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">1</span><span class="p">,</span><span class="m">90</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">l</span><span class="m">1</span><span class="p">,</span><span class="m">-90</span><span class="p">))</span><span class="w">
   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lat0</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">)</span><span class="w">
      </span><span class="n">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span><span class="m">90</span><span class="p">),</span><span class="n">xy</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">180</span><span class="p">,</span><span class="m">90</span><span class="p">),</span><span class="nf">c</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span><span class="m">90</span><span class="p">))</span><span class="w">
   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">)[</span><span class="nf">length</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">,]</span><span class="w">
      </span><span class="n">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">180</span><span class="p">,</span><span class="m">-90</span><span class="p">),</span><span class="w"> </span><span class="n">xy</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span><span class="m">-90</span><span class="p">),</span><span class="nf">c</span><span class="p">(</span><span class="m">180</span><span class="p">,</span><span class="m">-90</span><span class="p">))</span><span class="w">
   </span><span class="p">}</span><span class="w">
   </span><span class="n">st_sfc</span><span class="p">(</span><span class="n">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)),</span><span class="w"> </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="m">4326</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_make_grid</span><span class="p">()</span><span class="w">

</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_segmentize</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="m">4e5</span><span class="p">)</span><span class="w">


</span><span class="n">data</span><span class="p">(</span><span class="n">wrld_simpl</span><span class="p">)</span><span class="w">

</span><span class="c1"># Two versions of the world map, joined to the military/GDP data:
</span><span class="n">w</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_as_sf</span><span class="p">(</span><span class="n">countriesLow</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">the_data</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ISO3"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal</span><span class="p">(</span><span class="n">Value</span><span class="p">))</span><span class="w">

</span><span class="n">w</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_as_sf</span><span class="p">(</span><span class="n">wrld_simpl</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">the_data</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ISO3"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal</span><span class="p">(</span><span class="n">Value</span><span class="p">))</span><span class="w">


</span><span class="c1"># latitudes will go from 30 north to 30 south and back again:
</span><span class="n">lats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">30</span><span class="o">:</span><span class="p">(</span><span class="m">-30</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="m">-29</span><span class="p">)</span><span class="o">:</span><span class="m">29</span><span class="p">),</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
</span><span class="c1"># longitudes will start at 50 and go around backwards:
</span><span class="n">lons</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">180</span><span class="o">:</span><span class="p">(</span><span class="m">-179</span><span class="p">))</span><span class="w">

</span><span class="n">dir.create</span><span class="p">(</span><span class="s2">"C:/temp2"</span><span class="p">)</span><span class="w">
</span><span class="n">setwd</span><span class="p">(</span><span class="s2">"C:/temp2"</span><span class="p">)</span><span class="w">


</span><span class="c1"># Frame 234 goes missing if using wrld_simpl
# Frame 269 goes missing if using countriesLow or wrld_simpl
# etc
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">lons</span><span class="p">)){</span><span class="w">
   </span><span class="n">png</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="m">1000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s2">".png"</span><span class="p">),</span><span class="w"> </span><span class="m">600</span><span class="p">,</span><span class="w"> </span><span class="m">550</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">
   </span><span class="n">par</span><span class="p">(</span><span class="n">mar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">),</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w">
   
   </span><span class="n">lat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
   </span><span class="n">lon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
   
   </span><span class="c1"># define the proj4 string:
</span><span class="w">   </span><span class="n">p</span><span class="m">4</span><span class="n">s</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"+proj=ortho +lat_0="</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="s2">" +lon_0="</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">)</span><span class="w">
   
   </span><span class="c1"># draw the pale blue globe in space
</span><span class="w">   </span><span class="n">blank_globe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_transform</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="n">p</span><span class="m">4</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
   </span><span class="n">plot</span><span class="p">(</span><span class="n">blank_globe</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'#e6f2ff'</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'grey99'</span><span class="p">)</span><span class="w">
   
   </span><span class="c1"># create a clipped version of the great circle??
</span><span class="w">   </span><span class="c1"># I don't really understand what is happening, but it seems to work.
</span><span class="w">   </span><span class="n">crc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">circ</span><span class="p">(</span><span class="n">lat0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon</span><span class="p">)</span><span class="w">
   </span><span class="n">w</span><span class="m">10</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="n">st_intersection</span><span class="p">(</span><span class="n">w</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">crc</span><span class="p">))</span><span class="w">
   </span><span class="n">w</span><span class="m">20</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="n">st_intersection</span><span class="p">(</span><span class="n">w</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">crc</span><span class="p">))</span><span class="w">
   
   </span><span class="c1"># cast and re-project the map itself
</span><span class="w">   </span><span class="n">w</span><span class="m">10</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_cast</span><span class="p">(</span><span class="n">w</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="s2">"MULTIPOLYGON"</span><span class="p">)</span><span class="w">
   </span><span class="n">w</span><span class="m">10</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_transform</span><span class="p">(</span><span class="n">w</span><span class="m">10</span><span class="p">[</span><span class="s2">"fill"</span><span class="p">],</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="n">p</span><span class="m">4</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> 
   </span><span class="n">w</span><span class="m">20</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_cast</span><span class="p">(</span><span class="n">w</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="s2">"MULTIPOLYGON"</span><span class="p">)</span><span class="w">
   </span><span class="n">w</span><span class="m">20</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_transform</span><span class="p">(</span><span class="n">w</span><span class="m">20</span><span class="p">[</span><span class="s2">"fill"</span><span class="p">],</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="n">p</span><span class="m">4</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> 
   
   </span><span class="c1"># draw the map
</span><span class="w">   </span><span class="n">plot</span><span class="p">(</span><span class="n">w</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="m">10</span><span class="o">$</span><span class="n">fill</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">
   </span><span class="n">plot</span><span class="p">(</span><span class="n">w</span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="m">20</span><span class="o">$</span><span class="n">fill</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey75"</span><span class="p">)</span><span class="w">
   
   </span><span class="c1"># title and legend
</span><span class="w">   </span><span class="n">title</span><span class="p">(</span><span class="s2">"Military expenditure as a percentage of GDP\nNearest year to 2016"</span><span class="p">,</span><span class="w"> 
         </span><span class="n">col.main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="n">font.main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
   </span><span class="n">title</span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Stockholm International Peace Research Institute"</span><span class="p">,</span><span class="w"> 
         </span><span class="n">col.sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey50"</span><span class="p">,</span><span class="w"> </span><span class="n">adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
   
   </span><span class="n">leg_nums</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="w">
   </span><span class="n">legend</span><span class="p">(</span><span class="s2">"bottomright"</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">leg_nums</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">),</span><span class="w"> </span><span class="s2">"%"</span><span class="p">),</span><span class="w">
          </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w">
          </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal</span><span class="p">(</span><span class="n">leg_nums</span><span class="p">),</span><span class="w"> </span><span class="n">text.col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pal</span><span class="p">(</span><span class="n">leg_nums</span><span class="p">),</span><span class="w">
          </span><span class="n">bg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey80"</span><span class="p">)</span><span class="w">

   </span><span class="n">dev.off</span><span class="p">()</span><span class="w">
</span><span class="p">}</span><span class="w">
   
</span><span class="n">system</span><span class="p">(</span><span class="s1">'magick -loop 0 -delay 7 *.png "0099-military-gdp.gif"'</span><span class="p">)</span></code></pre></figure>

<h2 id="interactive-leaflet-choropleth">Interactive leaflet choropleth</h2>

<p>Finally, there’s the interactive version (my favourite):</p>

<iframe width="700" height="350" src="/img/0099-leaflet.html" frameborder="0" scrolling="no"></iframe>

<p>To draw this, I used <code class="highlighter-rouge">leaflet</code> and went back to <code class="highlighter-rouge">sp</code> spatial polygons data frames.  The code for this is actually some of the simplest in this post.  While most of the examples I’ve seen of leaflet use Mercator projections, it’s possible to reproject your map (so long as you don’t need Google or other map tiles) with a couple of lines of code:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#-------------------------leaflet------------------
</span><span class="n">shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">countriesCoarse</span><span class="w">

</span><span class="c1"># define colour palette
</span><span class="n">pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorNumeric</span><span class="p">(</span><span class="w">
   </span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inferno</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">),</span><span class="w">
   </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_data</span><span class="o">$</span><span class="n">Value</span><span class="p">)</span><span class="w">

</span><span class="c1"># uses the_data defined earlier in the ggplot2 demos
</span><span class="n">data2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">shape</span><span class="o">@</span><span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">the_data</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ISO_A3"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iso3c"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">tooltip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">ADMIN</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w"> </span><span class="n">Year</span><span class="p">,</span><span class="w"> </span><span class="s2">", "</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="s2">"%"</span><span class="p">))</span><span class="w">

</span><span class="c1"># EPSG4326 means latitude and longitude
</span><span class="n">coarse_crs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">leafletCRS</span><span class="p">(</span><span class="n">crsClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"L.CRS.EPSG4326"</span><span class="p">,</span><span class="w"> </span><span class="n">proj4def</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proj4string</span><span class="p">(</span><span class="n">countriesCoarse</span><span class="p">))</span><span class="w">

</span><span class="n">shape</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">leaflet</span><span class="p">(</span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafletOptions</span><span class="p">(</span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coarse_crs</span><span class="p">))</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">addPolygons</span><span class="p">(</span><span class="n">stroke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">smoothFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
               </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">pal</span><span class="p">(</span><span class="n">data2</span><span class="o">$</span><span class="n">Value</span><span class="p">),</span><span class="w">
               </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data2</span><span class="o">$</span><span class="n">tooltip</span><span class="p">)</span><span class="w"> </span></code></pre></figure>

<p>Happy mapping!</p>
