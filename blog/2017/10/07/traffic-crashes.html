      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>New Zealand 2017 election results</title>
      	
         
         
            <meta name ="description" content ="New Zealand's election results have been released and were within the range of my probabilistic predictions.  The pollsters did a good job.">
            <meta property="og:description" content ="New Zealand's election results have been released and were within the range of my probabilistic predictions.  The pollsters did a good job.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="New Zealand 2017 election results" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0111-histograms.png" />
         
		 
			<meta property="og:url" content="http://ellisp.github.io/blog/2017/10/07/traffic-crashes.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">     
		<link href="/css/syntax.css" rel ="stylesheet">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">Ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2017/10/07/traffic-crashes>Most recent post</a></li>
				  <li><a href="/blog/nz.html">All blog posts with data about New Zealand</a></li>
				  <li><a href="/blog/voting.html">All blog posts on voting behaviour</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
              <li><a href="/presentations/index.html">Presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">NZ Election forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href = "/elections/combined.html">Combined model (recommended)</a></li>
                  <li><a href="https://ellisp.shinyapps.io/nz-election-2017/">Explore coalitions and assumptions</a></li>
				  <li><a href="/elections/elections.html">Model A ("generalized additive model")</a></li>
				  <li><a href = "/elections/state-space.html">Model B ("state space")</a></li>
				  <li><a href="/elections/changelog.html">Log of changes to forecasts</a></li>
				  <li><a href="https://github.com/ellisp/nz-election-forecast">Source code on GitHub (external site)</a></li>
				  <li><a href="/blog/voting.html">All blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>New Zealand 2017 election results</h1>
         <p class="meta">07 Oct 2017</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>At a glance:</h2>
   New Zealand's election results have been released and were within the range of my probabilistic predictions.  The pollsters did a good job.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="election-results-are-in">Election results are in</h2>

<p>The New Zealand Electoral Commission have released the <a href="http://www.electionresults.govt.nz/electionresults_2017/">final count</a> of votes and seats from the 2017 election.  Moving in the direction most sensible observers expected, the National Party lost two seats compared to the “on-the-night” provisional vote once all the special votes were in, and the final results are:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Party</th>
      <th style="text-align: right">Seats</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">National</td>
      <td style="text-align: right">56</td>
    </tr>
    <tr>
      <td style="text-align: left">Labour</td>
      <td style="text-align: right">46</td>
    </tr>
    <tr>
      <td style="text-align: left">New Zealand First</td>
      <td style="text-align: right">9</td>
    </tr>
    <tr>
      <td style="text-align: left">Greens</td>
      <td style="text-align: right">8</td>
    </tr>
    <tr>
      <td style="text-align: left">ACT</td>
      <td style="text-align: right">1</td>
    </tr>
  </tbody>
</table>

<p>Negotiations will take a few days more on the shape of the government, but the make-up of Parliament is now fixed (bar unlikely challenges) and the result is firmly in the “New Zealand First needed to form a coalition” category. Other coalitions are still technically possible but politically infeasible, despite the best attempts of some people over the last week to drum up support for improbable combinations.</p>

<h2 id="comparison-to-my-forecasts">Comparison to my forecasts</h2>

<p>The summary of all my <a href="http://ellisp.github.io/elections/changelog.html">historical forecasts</a> is available for posterity.  When I started doing forecasts for the election back in April 2017, I estimated around a 20% chance of this outcome.  This was a bit against the common expectation at that point - most pundits and people I spoke to seemed to think the National-led coalition was headed for a fourth election win.  The highest chance I ever gave that possibility was in July 2017 when I gave it just less than 50%; from that point onwards the chances of the National coalition plummeted amidst a wave of positive sentiment to the Labour party under their new leader.</p>

<p>By the eve of the election there was little doubt of the result, barring a major polling error.  Labour and Greens never had a realistic chance of government by themselves, and the most plausible outcome by far was a coalition of either National or Labour/Green with New Zealand First.  My <a href="http://ellisp.github.io/elections/combined.html">final forecasts</a> gave this outcome a 95% chance.</p>

<p>Here’s the end results in numbers of seats compared to my final probabilistic forecasts:</p>

<p><img src="/img/0111-histograms.svg" width="100%" /></p>

<p>National outperformed my forecasts a bit, and Labour and New Zealand First underperformed.  The Māori Party wipeout was a significant forecasting failure on my part, but not that surprising a one.  I got their party vote more or less right, but with no significant electorate-level polling data there was no real way of estimating how they’d go in the six Māori electorates they were relying on for Parliamentary representation.</p>

<p>Note that on the eve of the election, I gave <em>zero</em> seats as the single most likely outcome for the Greens, with a one in four chance of that outcome.  When we can consider a range of outcomes though, 6-9 seats was most likely and this is where they ended up.</p>

<h2 id="the-pollsters-did-a-good-job">The pollsters did a good job</h2>

<p>Only three firms published regular polls, making prediction uncertain, and volatility difficult to estimate.  However, the net results were very good.  A simple average of recent polls came within a point or two of the actual results.</p>

<p><a href="https://grumpollie.wordpress.com/2017/10/07/how-did-the-polls-do-final-outcome/">Grumpollie</a> has compared the success or otherwise of the pollsters’ point estimates and of those of us who aggregated them by various means. The dominating fact is that there wasn’t a major polling error.  Reid Research and Colmar Brunton both did better than Roy Morgan.  My own party vote point forecasts weren’t particularly good, but that was never the point for me, as much as quantifying the uncertainty, particularly after converting to seats.  My hunch is that there was a swing back towards National in the last two or three weeks before the election, and with so few data points the evidence for this was treated sceptically by my (deliberately) slow moving models.</p>

<p>Predicting New Zealand elections is easier than in many other jurisdictions because the most important number by far is simply the national party vote.  If the US presidential elections were as simple as that, all the predictions in 2016 would have been right (as the pollsters correctly picked a nation-wide popular vote for Hillary Clinton).</p>

<h2 id="code">Code</h2>

<p>Here’s the code that creates the graphic comparing actual results to the probabilistic forecasts.  This is adapted from the code under the hood of my <a href="https://ellisp.shinyapps.io/nz-election-2017/">“choose your own coalition” web tool</a>.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#-------------functionality and data----------------
</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">nzelect</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forcats</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">testthat</span><span class="p">)</span><span class="w">

</span><span class="c1"># load up the last prediction data, which is a data frame of 4,800 rows
# (one for each simulated result) and 10 columns of party results
</span><span class="w">
</span><span class="n">download.file</span><span class="p">(</span><span class="s2">"https://github.com/ellisp/ellisp.github.io/raw/source/data/ellis-final-nz-election-forecasts-2017.rda"</span><span class="p">,</span><span class="w">
              </span><span class="n">destfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"tmp.rda"</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"wb"</span><span class="p">)</span><span class="w">
</span><span class="n">load</span><span class="p">(</span><span class="s2">"tmp.rda"</span><span class="p">)</span><span class="w">
</span><span class="n">unlink</span><span class="p">(</span><span class="s2">"tmp.rda"</span><span class="p">)</span><span class="w">


</span><span class="c1">#------------electorate seats that matter---------
# probability of Labour win in each of the seven Maori seats:
</span><span class="n">maori_probs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Labour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.49</span><span class="p">,</span><span class="w"> </span><span class="m">0.52</span><span class="p">,</span><span class="w"> </span><span class="m">0.55</span><span class="p">,</span><span class="w"> </span><span class="m">0.58</span><span class="p">,</span><span class="w"> </span><span class="m">0.48</span><span class="p">,</span><span class="w"> </span><span class="m">0.64</span><span class="p">,</span><span class="w"> </span><span class="m">0.3</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">Other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Labour</span><span class="p">)</span><span class="w">

</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span><span class="w"> </span><span class="c1"># number of simulations ie 4800
</span><span class="w">
</span><span class="n">filler</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">party</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Conservative"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NZ First"</span><span class="p">,</span><span class="w"> </span><span class="s2">"United Future"</span><span class="p">),</span><span class="w">
  </span><span class="n">seats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="w">
  </span><span class="n">sim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># probability of ACT win in Epsom
</span><span class="n">epsom</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.8</span><span class="w">

</span><span class="c1"># simulate electorate seat results:
</span><span class="n">electorate_sims</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="w">
  </span><span class="n">epsom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"ACT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"National"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">epsom</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">epsom</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mana"</span><span class="p">),</span><span class="w">  </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
  </span><span class="n">m</span><span class="m">7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">),</span><span class="w"> </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maori_probs</span><span class="p">[</span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">sim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">gather</span><span class="p">(</span><span class="n">seat</span><span class="p">,</span><span class="w"> </span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">group_by</span><span class="p">(</span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="n">sim</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">summarise</span><span class="p">(</span><span class="n">seats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">rbind</span><span class="p">(</span><span class="n">filler</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">spread</span><span class="p">(</span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="n">seats</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1">#-------------convert to total seats-------------------------
</span><span class="n">seats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span><span class="w">
  </span><span class="n">allocate_seats</span><span class="p">(</span><span class="n">votes</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">sims</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">]),</span><span class="w"> 
                 </span><span class="n">electorate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">electorate_sims</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">]),</span><span class="w">
                 </span><span class="n">parties</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"M.ori"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">sims</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">]))</span><span class="o">$</span><span class="n">seats_v</span><span class="w">
</span><span class="p">}))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">as_tibble</span><span class="p">()</span><span class="w">

</span><span class="c1">#-------------compare to actual results----------------------
</span><span class="w">
</span><span class="n">actual_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="w">
  </span><span class="n">party</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ACT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mana"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">,</span><span class="w"> </span><span class="s2">"National"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NZ First"</span><span class="p">),</span><span class="w">
  </span><span class="n">final_seats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="m">46</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">56</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="n">expect_equal</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_results</span><span class="o">$</span><span class="n">final_seats</span><span class="p">),</span><span class="w"> </span><span class="m">120</span><span class="p">)</span><span class="w">

</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seats</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="n">n_seats</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="n">party</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Conservative"</span><span class="p">,</span><span class="w"> </span><span class="s2">"United Future"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mana"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="n">actual_results</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">n_seats</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">final_seats</span><span class="p">,</span><span class="w"> </span><span class="s2">"Actual result"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Probability of other results"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">party</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_reorder</span><span class="p">(</span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="n">desc</span><span class="p">(</span><span class="n">n_seats</span><span class="p">)))</span><span class="w">


</span><span class="c1"># see https://stackoverflow.com/questions/4646020/ggplot2-axis-transformation-by-constant-factor
# for this idea to do a linear transformation of the y axis so it is probabilities rather than
# counts of the 4800 simulations:
</span><span class="n">formatter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4800</span><span class="p">){</span><span class="w"> 
  </span><span class="n">format</span><span class="p">(</span><span class="nf">signif</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">levels</span><span class="p">(</span><span class="n">d</span><span class="o">$</span><span class="n">party</span><span class="p">)[</span><span class="n">levels</span><span class="p">(</span><span class="n">d</span><span class="o">$</span><span class="n">party</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"M\U0101ori"</span><span class="w">

</span><span class="n">d</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_seats</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">success</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">party</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Actual result"</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey10"</span><span class="p">,</span><span class="w"> </span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_alpha_manual</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">`Actual result`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">`Probability of other results`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of seats"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Probability of outcome\n"</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">formatter</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Comparison of forecast and actual number of seats in the 2017 New Zealand election"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"Forecasts are the combination of Peter's Stats' Stuff Models A and B"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parties_v</span><span class="p">,</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span></code></pre></figure>



</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2017/10/07/election-results">
        <p>&larr; Older</p>
        <p>New Zealand 2017 election results</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		<gcse:search></gcse:search>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
			
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

			<div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="true" data-share="false"></div>
			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			

			</footer>
    </div>



  
</body>
</html>
   




         
