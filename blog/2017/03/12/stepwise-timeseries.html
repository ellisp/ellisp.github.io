      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Simulations to explore excessive lagged X variables in time series modelling</title>
      	
         
         
            <meta name ="description" content ="Adding lots of lagged explanatory variables to a time series model without enough data points is a trap, and stepwise-selection doesn't help.  The lasso or other regularization might be a promising alternative.">
            <meta property="og:description" content ="Adding lots of lagged explanatory variables to a time series model without enough data points is a trap, and stepwise-selection doesn't help.  The lasso or other regularization might be a promising alternative.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Simulations to explore excessive lagged X variables in time series modelling" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0087-results.png" />
         
		 
			<meta property="og:url" content="http://freerangestats.info/blog/2017/03/12/stepwise-timeseries.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
				  <li><a href = /blog/2019/07/28/unemployment-forecasts>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">election forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href = "/elections/oz/index.html">Australia federal 2019</a></li>
				  <li><a href = "/elections/combined.html">NZ 2016</a></li>
                  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Simulations to explore excessive lagged X variables in time series modelling</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>Adding lots of lagged explanatory variables to a time series model without enough data points is a trap, and stepwise-selection doesn't help.  The lasso or other regularization might be a promising alternative.</p>
	   <p class="meta">12 Mar 2017</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <p>I was once in a meeting discussing a time series modelling and forecasting challenge where it was suggested that “the beauty of regression is you just add in more variables and more lags of variables and try the combinations until you get something that fits really well”.  Well, no, it doesn’t work like that; at least not in many cases with realistically small social science or public policy datasets.  Today’s post looks at one particular trap - a modelling strategy that tries more lags of explanatory variables than are justified given the amount of data available.</p>

<h2 id="the-data">The data</h2>

<p>Imagine you have a time series <code class="highlighter-rouge">y</code> and two candidate explanatory variables <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code>.  We have values of <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> for the future - perhaps because they are genuinely known in advance, perhaps generated by independent forecasts.  Let’s say there is good theoretical or subject matter reason for thinking there is a relationship between them, but it’s clearly not a simple one.  It’s possible the relationship is lagged - perhaps <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> are leading economic indicators and <code class="highlighter-rouge">y</code> is the result of decisions people take based on the history of the <code class="highlighter-rouge">x</code>s.  The job is to forecast <code class="highlighter-rouge">y</code> conditional on <code class="highlighter-rouge">X</code>, and if possible generate some insight about the structural relationship of the <code class="highlighter-rouge">x</code>s and <code class="highlighter-rouge">y</code>, and be prepared for some scenarios where <code class="highlighter-rouge">x1</code> or <code class="highlighter-rouge">x2</code> might change and we want to see the impact on <code class="highlighter-rouge">y</code>.</p>

<p>Here’s an example of something we might see:</p>

<p><img src="/img/0087-origdata.svg" width="100%" /></p>

<p>Those series were generated by me.  We have 110 historical observations, and a forecast period of 12 for which there are observations for <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> but not <code class="highlighter-rouge">y</code>.  Each series is in reality completely independent of the others, something I’ve done deliberately to illustrate the point I’m about to make.  For those with an interest, they are all <a href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA</a>(2,1,1) models with the same parameterisation but different random sequences behind them.</p>

<h2 id="basic-forecasting-models">Basic forecasting models</h2>

<h3 id="univariate">Univariate</h3>
<p>A simple strategy for forecasting <code class="highlighter-rouge">y</code> would be to find the best ARIMA model that fits the data using Rob Hyndman’s <code class="highlighter-rouge">auto.arima</code> algorithm, which has been shown to perform well.  We can do this with or without considering the x variables at all.  If we ignore the x variables, we get a forecast that looks like this:</p>

<p><img src="/img/0087-fc1.svg" width="100%" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Series: y 
ARIMA(0,1,2)                    

Coefficients:
         ma1     ma2
      1.4250  0.4415
s.e.  0.0865  0.0867

sigma^2 estimated as 0.7736:  log likelihood=-141.77
AIC=289.54   AICc=289.77   BIC=297.62
</code></pre>
</div>

<p>In fact, because we secretly know how the data was generated, we know that this is a good model of this particular data.  The <code class="highlighter-rouge">auto.arima</code> algorithm picked up that the data was non-stationary and needed to be differenced once before modelling; but it got the “wrong” specification of the number of auto-regressive and moving average terms to include (this <a href="/blog/2015/09/30/autoarima-success-rates">isn’t unusual</a>, nor is it necessarily a problem).  By default it uses a stepwise method to identify the best combination of up to five auto-regressive parameters and five moving average parameters.</p>

<h3 id="linear-regression-with-time-series-error-terms">Linear regression with time series error terms</h3>

<p>A second, nearly as simple method of forecasting would be to fit a <a href="http://robjhyndman.com/hyndsight/arimax/">linear regression with an ARIMA time series error term</a>.  The <code class="highlighter-rouge">auto.arima</code> method will do this, and look after all the tests of non-stationarity and difference in response that are required.  It gives easily interpretable coefficients for the relationship between <code class="highlighter-rouge">y</code> and <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code>.  Here’s what we see in our case:</p>

<p><img src="/img/0087-fc2.svg" width="100%" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Series: y 
Regression with ARIMA(0,1,2) errors 

Coefficients:
         ma1     ma2      x1       x2
      1.4202  0.4349  0.0371  -0.0364
s.e.  0.0870  0.0878  0.0867   0.0796

sigma^2 estimated as 0.785:  log likelihood=-141.59
AIC=293.18   AICc=293.77   BIC=306.64
</code></pre>
</div>
<p>Basically, the model has correctly identified there is a weak or no relationship between the <code class="highlighter-rouge">x</code>s and <code class="highlighter-rouge">y</code>.  The momentum of <code class="highlighter-rouge">y</code> itself is the main predictor of future <code class="highlighter-rouge">y</code>, and this shows in the forecasts which are only marginally different from our first univariate case.  Using the Akaike Information Criterion, the model with x regressors is inferior to the simpler model.</p>

<h2 id="more-complex-models">More complex models</h2>

<p>A problem with above approaches is that they don’t take into account the (wrongly) suspected lagged relationship between the <code class="highlighter-rouge">x</code>s and <code class="highlighter-rouge">y</code>, other than through the current/simultaneous in time relationship.  There’s an obvious solution - introduce lagged terms of <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> into the regression.  There are a variety of ways of doing this and specialist R packages like <code class="highlighter-rouge">dynlm</code>, <code class="highlighter-rouge">dyn</code> and <code class="highlighter-rouge">dse</code> that I’m not going to introduce because I want things from here on to be simple and explicit.  See the <a href="https://cran.r-project.org/web/views/TimeSeries.html">CRAN time series task view</a> for a starting point to explore further.</p>

<p>I want to focus on <strong>how problematic this can be</strong>.  How many parameters in our model are we prepared to estimate, given our 110 historical data points?  Frank Harrell’s advice in <em>Regression Modeling Strategies</em> is:</p>

<blockquote>
  <p>“Studies in which models are validated on independent datasets have shown that in many situations a fitted regression model is likely to be reliable when the number of predictors (or <em>candidate</em> predictors if using variable selection) <em>p</em> is less than <em>m/10</em> or <em>m/20</em>, where <em>m</em> is the limiting sample size”</p>
</blockquote>

<p><em>Frank Harrell</em></p>

<p>Our “limiting sample size” is 110, and our 110 time series observations are actually worth less than 110 independent ones would be because each observation contains only marginal new information for us; knowing the value at time <em>t</em> gives us a good indication of where it will be at time <em>t+1</em>, something not the case in more independent sampling situations.</p>

<p>This suggests we should be considering five or six, or eleven at the very most, candidate variables for inclusion.  Just by using <code class="highlighter-rouge">auto.arima</code> we’ve looked at ten parameters (five autoregression lags, and five moving average parameters), and by adding in <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> we’ve definitely reached our maximum.  Ouch.  As we’re usually not interested in individual AR and MA parameters we can perhaps get away with stretching a point, but there’s no get out of jail card here that means we can meaningfully keep adding in more explanatory variables.</p>

<p>So what happens if we proceed anyway?  To check this out, I tried three strategies:</p>

<ol>
  <li>Created variables for up to 20 lag periods for each of the three original variables, leaving us with 62 candidate predictors, and fit a model by ordinary least squares.</li>
  <li>Take the full model from above and use stepwise selection to knock out individual variables with p values &lt; 0.05 (the conventional cut-off point for a variable being “not significant”).  I had to torture R’s <code class="highlighter-rouge">step</code> function to do this, because quite rightly it prefers to choose models based on AIC rather than individual p-values; I wanted to mimic the p-value method for demonstration purposes.</li>
  <li>Take the full model and use lasso-style shrinkage/regularisation on the 62 predictors’ coefficients.</li>
</ol>

<p>Of those methods, I think #1 and #2 are both potentially disastrous and will lead to overfitting (which means that the model will perform badly when confronted with new data ie in predicting our twelve future points).  Stepwise variable selection is particularly pernicious because it can create the illusion that “significant” relationships between the variables have been found.  At the end of a stepwise procedure, software can provide you with F tests, t tests and p-values but they are invalid because you have chosen the variables remaining in the model precisely because they score well on those tests.  In today’s case, here is what we end up with.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.23003    0.10375   2.217 0.029642 *  
y_d_lag_1    1.15802    0.09837  11.772  &lt; 2e-16 ***
x1_d_lag_1   0.27902    0.07908   3.528 0.000718 ***
y_d_lag_2   -1.04546    0.14885  -7.023 8.39e-10 ***
y_d_lag_3    0.78761    0.16493   4.775 8.68e-06 ***
y_d_lag_4   -0.44729    0.14928  -2.996 0.003704 ** 
x1_d_lag_4   0.24485    0.07325   3.342 0.001298 ** 
y_d_lag_5    0.33654    0.10118   3.326 0.001366 ** 
x1_d_lag_6   0.19763    0.06565   3.010 0.003555 ** 
x2_d_lag_8  -0.11246    0.05336  -2.107 0.038422 *  
x2_d_lag_16 -0.17330    0.06347  -2.731 0.007876 ** 
x1_d_lag_17  0.22910    0.07073   3.239 0.001789 ** 
x1_d_lag_18 -0.18724    0.07147  -2.620 0.010643 *  
x2_d_lag_19 -0.11310    0.05536  -2.043 0.044546 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.8418 on 75 degrees of freedom
Multiple R-squared:  0.7594,	Adjusted R-squared:  0.7177 
F-statistic: 18.21 on 13 and 75 DF,  p-value: &lt; 2.2e-16
</code></pre>
</div>
<p>A high R-squared, even a high “Adjusted R-squared” and many variables with p values well below the 0.05 cut-off.  So (for example) the unwary analyst would conclude we have strong evidence that <code class="highlighter-rouge">y</code> is impacted by <code class="highlighter-rouge">x2</code> 16 periods ago and <code class="highlighter-rouge">by x1</code> 17 periods ago, but mysteriously not by anything from lags 9 through 15.</p>

<p>Remember that the true data generation process had <em>zero</em> influence from <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> on <code class="highlighter-rouge">y</code> or vice versa.</p>

<p>Working with lags in a time series situation does not give any wild cards that make stepwise selection valid.  The usual problems with stepwise selection within a model building strategy apply:</p>

<ol>
  <li><script type="math/tex">R^2</script> values are biased high</li>
  <li>The usual F and <script type="math/tex">\chi^2</script> test statistics of the final model do not have the claimed distribution</li>
  <li>The standard errors of coefficients are biased low and confidence intervals of effects are too narrow</li>
  <li>p-values are far too small, do not have the proper meaning, and correction is very difficult</li>
  <li>The coefficients of effects that remain in the model are strongly biased away from zero</li>
  <li>Variable selection is made arbitrary</li>
  <li>The whole process allows us to escape thinking about the problem</li>
</ol>

<p><em>From Harrell’s Regression Modeling Strategies</em>.</p>

<p>In the case of the full model, with 62 variables, the exact problems above do not apply.  The p-values for example will be basically ok (and in fact in this case none of the <code class="highlighter-rouge">x1</code> and <code class="highlighter-rouge">x2</code> lags show up as significant until we start knocking out the variables one at a time).  The problem is that with 64 parameters (including the intercept and variance) estimated from only 109 data points (after we have differenced the series to make them stationary), we have extremely high variance and instability in the model.</p>

<p>Shrinkage of the estimated coefficients via the <a href="https://en.wikipedia.org/wiki/Lasso_(statistics)">lasso</a> is one way of fixing this, and indeed the lasso is generally used precisely in this situation of excessive candidate explanatory variables when predictive power is important.  We trade off some bias in the coefficients for better stability and predictive power.  Using the lasso in this case reduces nearly all the <code class="highlighter-rouge">x</code> coefficients to zero, and lags 1 and 2 of the <code class="highlighter-rouge">y</code> variable staying in the model as they should.</p>

<h2 id="comparison-of-results">Comparison of results</h2>

<p>Here’s the actual forecasts of the five methods we’ve tried so far:</p>

<p><img src="/img/0087-results.svg" width="100%" /></p>

<p>What we see is that the two methods I’ve labelled “bad” give very similar results - a sharp decline.  As a result of their overfitting they are both picking up structure in the <code class="highlighter-rouge">x</code>s that does not really impact on <code class="highlighter-rouge">y</code>.</p>

<p>The three “ok” methods give results that are more in tune with the secret data generating process.  The most encouraging thing for me here is the success of the lasso in avoiding the pitfalls of the stepwise method.  If there really is a complex lagged relationship between the <code class="highlighter-rouge">x</code>s and <code class="highlighter-rouge">y</code>, this method of looking at all 62 variables and forcing a relatively stable estimation process at least gives the analyst a sporting chance of finding it.  The <a href="https://CRAN.R-project.org/package=orderedLasso">orderedLasso</a> R package  - which I haven’t tried using yet - looks to take this idea further in implementing the idea of an “Ordered Lasso and Sparse Time-lagged Regression”, and I’m pretty confident is worth a look.</p>

<p><em>Final word</em> - this is an illustration rather than a comprehensive demonstration.  Obviously, the thing to be done to really prove the issues would be to generate many such cases, including “real” future values of <code class="highlighter-rouge">y</code> for test purposes, and test the error rates of the forecasts from the different methods.  I don’t particularly feel the need to do that, but maybe one day if I run out of things to do will give it a go.</p>

<h2 id="code">Code</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">glmnet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forcats</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">directlabels</span><span class="p">)</span><span class="w">

</span><span class="c1">#===========generate data============
</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">110</span><span class="w">
</span><span class="n">h</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w">

</span><span class="n">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ts</span><span class="p">(</span><span class="nf">cumsum</span><span class="p">(</span><span class="n">arima.sim</span><span class="p">(</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">ar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">-0.2</span><span class="p">),</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.2</span><span class="p">))</span><span class="w">
</span><span class="n">x</span><span class="m">1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">arima.sim</span><span class="p">(</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">ar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">-0.2</span><span class="p">),</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w">
</span><span class="n">x</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">arima.sim</span><span class="p">(</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">ar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">-0.2</span><span class="p">),</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">))</span><span class="w">

</span><span class="n">orig_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="m">2</span><span class="p">),</span><span class="w">
           </span><span class="n">Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"y"</span><span class="p">,</span><span class="w"> </span><span class="s2">"x1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"x2"</span><span class="p">),</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="p">)),</span><span class="w">
           </span><span class="n">TimePeriod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">h</span><span class="p">),</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">h</span><span class="p">)))</span><span class="w"> 

</span><span class="n">orig_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimePeriod</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Variable</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Original data"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"Three unrelated (but that is unknown to us) univariate time series"</span><span class="p">)</span><span class="w">

</span><span class="n">X_full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="n">x</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">X_historical</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_full</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="n">X_future</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">X_full</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">


</span><span class="c1"># A version that has been differenced once....
</span><span class="n">YX_diff_lags</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="w">
   </span><span class="n">y_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">)),</span><span class="w">
   </span><span class="n">x</span><span class="m">1</span><span class="err">_</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="m">1</span><span class="p">),</span><span class="w">
   </span><span class="n">x</span><span class="m">2</span><span class="err">_</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="m">2</span><span class="p">))</span><span class="w">

</span><span class="c1"># And has lagged variables up to lag period of 20 for each variable:
</span><span class="n">lagnumber</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">20</span><span class="w">

</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">lagnumber</span><span class="p">){</span><span class="w">
   </span><span class="n">YX_diff_lags</span><span class="p">[,</span><span class="w"> </span><span class="n">ncol</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lag</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="o">$</span><span class="n">y_d</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w">
   </span><span class="n">YX_diff_lags</span><span class="p">[,</span><span class="w"> </span><span class="n">ncol</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lag</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="o">$</span><span class="n">x</span><span class="m">1</span><span class="err">_</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w">
   </span><span class="n">YX_diff_lags</span><span class="p">[,</span><span class="w"> </span><span class="n">ncol</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lag</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="o">$</span><span class="n">x</span><span class="m">2</span><span class="err">_</span><span class="n">d</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nf">names</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
   </span><span class="n">paste0</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="s2">"_lag_"</span><span class="p">,</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">lagnumber</span><span class="p">,</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">lagnumber</span><span class="p">)))</span><span class="w">
       
</span><span class="k">if</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lagnumber</span><span class="p">){</span><span class="w">
   </span><span class="n">stop</span><span class="p">(</span><span class="s2">"Wrong number of columns; something went wrong"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c1">#===================Modelling options========
</span><span class="w">
</span><span class="c1">#-------------univariate-----------------
</span><span class="n">mod1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">auto.arima</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="n">fc1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">forecast</span><span class="p">(</span><span class="n">mod1</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w">

</span><span class="n">autoplot</span><span class="p">(</span><span class="n">fc1</span><span class="p">)</span><span class="w">

</span><span class="c1">#------------xreg, no lags----------------
</span><span class="n">mod2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">auto.arima</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">xreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X_historical</span><span class="p">)</span><span class="w">
</span><span class="n">fc2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">forecast</span><span class="p">(</span><span class="n">mod2</span><span class="p">,</span><span class="w"> </span><span class="n">xreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X_future</span><span class="p">)</span><span class="w">

</span><span class="n">autoplot</span><span class="p">(</span><span class="n">fc2</span><span class="p">)</span><span class="w">

</span><span class="c1">#-----------xreg, lags----------------
</span><span class="n">YX_hist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">YX_diff_lags</span><span class="p">[</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">

</span><span class="n">mod3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">y_d</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">YX_hist</span><span class="p">)</span><span class="w">

</span><span class="cd">#' Forecast from a regression model with lags one row at a time
#' Assumes the existence of: YX_diff_lags &amp; y.
#' Has to forecast one row at a time, then populate the explanatory data frame
#' with the lagged values possible after that forecast.
</span><span class="n">onerow_forecast</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">model</span><span class="p">){</span><span class="w">
   </span><span class="n">prediction_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">YX_diff_lags</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="o">$</span><span class="n">y_d</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
   </span><span class="n">y_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">)[</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"y_d"</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">YX_diff_lags</span><span class="p">))]</span><span class="w">
   
   </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">prediction_data</span><span class="p">)){</span><span class="w">
      </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">prediction_data</span><span class="p">)){</span><span class="w">
         </span><span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">y_names</span><span class="p">)){</span><span class="w">
            </span><span class="n">prediction_data</span><span class="p">[</span><span class="n">j</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">y_names</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">prediction_data</span><span class="p">[</span><span class="n">j</span><span class="m">-1</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">y_names</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">]]</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
      
      </span><span class="k">if</span><span class="p">(</span><span class="nf">class</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"cv.glmnet"</span><span class="p">){</span><span class="w">
         </span><span class="n">new_y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">newx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">prediction_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">]))</span><span class="w">
      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="n">new_y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prediction_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">])</span><span class="w">   
      </span><span class="p">}</span><span class="w">
      
      </span><span class="n">prediction_data</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">"y_d"</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new_y</span><span class="w">
   </span><span class="p">}</span><span class="w">
   
   </span><span class="c1"># de-diff ie return to the original, non-differenced scale
</span><span class="w">   </span><span class="n">fc_y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">tail</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)),</span><span class="w"> </span><span class="n">prediction_data</span><span class="o">$</span><span class="n">y_d</span><span class="p">))</span><span class="w">
   </span><span class="nf">return</span><span class="p">(</span><span class="n">fc_y</span><span class="p">[</span><span class="m">-1</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">fc3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">onerow_forecast</span><span class="p">(</span><span class="n">mod3</span><span class="p">)</span><span class="w">

</span><span class="c1">#-------xreg, lags, stepwise----------------
# high value of k to mimic stepwise selection based on p values:
</span><span class="n">mod4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">step</span><span class="p">(</span><span class="n">mod3</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4.7</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="n">fc4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">onerow_forecast</span><span class="p">(</span><span class="n">mod4</span><span class="p">)</span><span class="w">

</span><span class="c1">#-----------xreg, lags, lasso---------------
# Use cross-validation to determine best value of lambda, for how much
# shrinkage to force:
</span><span class="n">mod5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cv.glmnet</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">YX_hist</span><span class="o">$</span><span class="n">y_d</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">YX_hist</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="m">-1</span><span class="p">]))</span><span class="w">
</span><span class="n">fc5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">onerow_forecast</span><span class="p">(</span><span class="n">mod5</span><span class="p">)</span><span class="w">     

</span><span class="c1">#====================compare results==============
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">Univariate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fc1</span><span class="o">$</span><span class="n">mean</span><span class="p">,</span><span class="w"> 
           </span><span class="n">SimpleXreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fc2</span><span class="o">$</span><span class="n">mean</span><span class="p">,</span><span class="w"> 
           </span><span class="n">AllLags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fc3</span><span class="p">,</span><span class="w"> 
           </span><span class="n">StepLags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fc4</span><span class="p">,</span><span class="w"> 
           </span><span class="n">LassoLags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fc5</span><span class="p">,</span><span class="w">
           </span><span class="n">TimePeriod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">h</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">gather</span><span class="p">(</span><span class="n">Variable</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">TimePeriod</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">Judge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"Lags"</span><span class="p">,</span><span class="w"> </span><span class="n">Variable</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"Lasso"</span><span class="p">,</span><span class="w"> </span><span class="n">Variable</span><span class="p">),</span><span class="w">
                         </span><span class="s2">"Bad"</span><span class="p">,</span><span class="w"> </span><span class="s2">"OK"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">Variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_relevel</span><span class="p">(</span><span class="n">Variable</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AllLags"</span><span class="p">,</span><span class="w"> </span><span class="s2">"StepLags"</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimePeriod</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Variable</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Judge</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_colour_brewer</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Set1"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"right"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">orig_data</span><span class="p">,</span><span class="w"> </span><span class="n">Variable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"y"</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">xlim</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">130</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">25</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Historical data"</span><span class="p">,</span><span class="w"> 
            </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey40"</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myfont"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Excessive inclusion of lagged explanatory variables leads to overfitting"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"Regularization by lasso, or using a simpler model in the first place, gives much better results."</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Simulations from forecasting one time series based on two unrelated time series."</span><span class="p">)</span><span class="w">

</span><span class="n">direct.label</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
 </span></code></pre></figure>



		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2017/03/11/nzelect-0.3.0">New data and functions in nzelect 0.3.0 R package</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2017/03/21/house-effects">House effects in New Zealand voting intention polls</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics
http://Http://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>