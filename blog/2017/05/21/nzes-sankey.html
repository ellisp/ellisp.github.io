      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Sankey charts for swinging voters</title>
      	
         
         
            <meta name ="description" content ="Sankey charts based on individual level survey data are a good way of showing change from election to election.  I demonstrate this, via some complications with survey-reweighting and missing data, with the New Zealand Election Study for the 2014 and 2011 elections.">
            <meta property="og:description" content ="Sankey charts based on individual level survey data are a good way of showing change from election to election.  I demonstrate this, via some complications with survey-reweighting and missing data, with the New Zealand Election Study for the 2014 and 2011 elections.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Sankey charts for swinging voters" />
         
            <meta property="og:image" content="https:/freerangestats.info/img/0098-vote.png" />
         
		 
			<meta property="og:url" content="https://freerangestats.info/blog/2017/05/21/nzes-sankey.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                  <li><a href="/blog/surveys.html">all posts on surveys</a></li> 
				  <li><a href = /blog/2024/08/31/ppswor>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
				  <li><a href = "/covid-tracking/index.html">Covid-19 in Australia</a></li>
                  <li><a href = "/elections/nz-2020/index.html">NZ election 2020</a></li>
                  <li><a href = "/elections/oz-2019/index.html">Australia federal election 2019</a></li>
				  <li><a href = "/elections/nz-2017/combined.html">NZ election 2017</a></li>
                  <li><a href="/blog/voting.html">all blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Sankey charts for swinging voters</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>Sankey charts based on individual level survey data are a good way of showing change from election to election.  I demonstrate this, via some complications with survey-reweighting and missing data, with the New Zealand Election Study for the 2014 and 2011 elections.</p>
	   <p class="meta">21 May 2017</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <p>Continuing my examination of the individual level voting behaviour from the <a href="http://www.nzes.org/">New Zealand Election Study</a>, I wanted to look at the way individuals swap between parties, and between “did not vote” and a party, from one election to another.  How much and how this happens is obviously an important question for both political scientists and for politicians.</p>

<h2 id="vote-transition-visualisations">Vote transition visualisations</h2>
<p>I chose a Sankey chart as a way of showing the transition matrix from self-reported party vote in the 2011 election to the 2014 election.  Here’s a static version:</p>

<p><img src="/img/0098-vote.png" width="100%" /></p>

<p>And here is the more screen-friendly interactive version, with mouseover tooltips to give actual estimates:</p>

<iframe width="700" height="500" src="/img/0098-sankey.html" frameborder="0" scrolling="no"></iframe>

<p>The point with these graphics is to highlight the transitions.  For example, what were the implications of turnout being higher in 2014 than 2011 (77.9% of enrolled voters in 2014 compared to 74.2% in 2011)?  Judging from this survey data, the National Party gained 6.6% of the enrolled population in 2014 by converting them from a 2011 “did not vote” and lost only 3.6% in the other direction.  This net gain of three percentage points was enough to win the election for the National-led coalition.  In contrast, the Labour party had a net gain from “did not vote” in 2011 of only 0.2 percentage points.  Remember though that these are survey-based estimates, and subject to statistical error.</p>

<p>I find setting up and polishing Sankey charts - controlling colours for example - a bit of a pain, so the code at the bottom of this post on how this was done might be of interest.</p>

<h2 id="weighting-missing-data-population-and-age-complications">Weighting, missing data, population and age complications</h2>

<p>Those visualisations have a few hidden fishhooks, which careful readers would find if they compare the percentages in the tooltips of the interactive version with percentages reported by the <a href="http://www.elections.org.nz/news-media/new-zealand-2014-general-election-official-results">New Zealand Electoral Commission</a>.</p>

<ul>
  <li>The 2014 percentages are proportions of the <em>enrolled</em> population.  As the 2014 turnout of enrolled voters was 77.9%, the numbers here are noticeably less than the usually cited percentages which were used to translate into seat counts (for example, National Party reported party vote of 47.0% of votes becomes 36.6% of enrolled voters)</li>
  <li>The 2011 percentages are even harder to explain, because I’ve chosen not only to scale the party vote and “did not vote” to the 2011 enrolled population as reported by the Commission, but also to add in around 5% of the <em>2014</em> population that were too young to vote in 2011.</li>
</ul>

<p>Two things I would have liked to have taken into account but wasn’t able to were:</p>

<ul>
  <li>The “leakage” from the 2011 election of people who were deceased or had left the country by 2014</li>
  <li>Explicit recognition of people who voted in 2014 but not in 2011 because they were out of the country.  There is a variable in the survey that picks up the year the respondent came to live in New Zealand if not born here, but for only 10 respondents  was this 2012 or later (in contrast to age - there were 58 respondents aged 20 or less in 2014).</li>
</ul>

<p>I re-weighted the survey so the 2014 and 2011 reported party votes matched the known totals (with the addition of people aged 15 to 17 in 2011).  One doesn’t normally re-weight a survey based on answers provided by the respondents, but in this case I think it makes perfect sense to calibrate to the public totals.  The biggest impact is that for both years, but particularly 2011, relying on the respondents’ self-report and the published weighting of the NZES, totals for “did not vote” are materially understated, compared to results when calibrated to the known totals.</p>

<p>When party vote in 2011 had been forgotten or was an NA, and this wasn’t explained by being too young in 2011, I used multiple imputation based on a subset of relevant variables to give five instances of probable party vote to each such respondent.</p>

<p>Taken together, all this gives the visualisations a perspective based in 2014.  It is better to think of it as “where did the 2014 voters come from” than “where did the 2011 voters go”.  This is fairly natural when we consider it is the 2014 New Zealand Election Study, but is worth keeping in mind in interpretation.</p>

<p>Age (and hence the impact new young voters coming in, and of older voters passing on) is important in voting behaviour, as even the most casual observation of politics shows.  In New Zealand, the age distribution of party voters in 2014 is seen in the chart below:</p>

<p><img src="/img/0098-age-densities.svg" width="100%" /></p>

<p>Non-voters, Green voters and to a certain extent Labour voters are young; New Zealand First voters are older.  If this interests you though, I suggest you look at the multivariate analysis in <a href="/blog/2017/05/06/nz-first">this blog post</a> or, probably more fun, <a href="https://ellisp.shinyapps.io/individual-vote-nzes/">this fancy interactive web app</a> which lets you play with the predicted probabilities of voting based on a combination of demographic and socio-economic status variables.</p>

<h2 id="code">Code</h2>

<p>Here’s the R code that did that imputation, weighting, and the graphics:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forcats</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">riverplot</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sankeyD3</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">foreign</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">testthat</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">mice</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span><span class="w">

</span><span class="c1"># Caution networkD3 has its own sankeyD3 with less features.  Make sure you know which one you're using!</span><span class="w">
</span><span class="c1"># Don't load up networkD3 in the same session</span><span class="w">

</span><span class="c1">#============import data======================</span><span class="w">
</span><span class="c1"># See previous blog posts for where this comes from:</span><span class="w">
</span><span class="n">unzip</span><span class="p">(</span><span class="s2">"D:/Downloads/NZES2014GeneralReleaseApril16.sav.zip"</span><span class="p">)</span><span class="w">

</span><span class="n">nzes_orig</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.spss</span><span class="p">(</span><span class="s2">"NZES2014GeneralReleaseApril16.sav"</span><span class="p">,</span><span class="w"> 
                       </span><span class="n">to.data.frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">trim.factor.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Five versions of each row, so when we do imputation later on we</span><span class="w">
</span><span class="c1"># in effect doing multiple imputation:</span><span class="w">
</span><span class="n">nzes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nzes_orig</span><span class="p">[</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">nzes_orig</span><span class="p">),</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="c1"># lump up party vote in 2014:</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">dpartyvote</span><span class="p">),</span><span class="w"> </span><span class="s2">"Did not vote"</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">dpartyvote</span><span class="p">)),</span><span class="w">
          </span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"M.ori"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2014</span><span class="p">),</span><span class="w">
          </span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"net.Man"</span><span class="p">,</span><span class="w"> </span><span class="s2">"net-Man"</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2014</span><span class="p">),</span><span class="w">
          </span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_infreq</span><span class="p">(</span><span class="n">partyvote2014</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_lump</span><span class="p">(</span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">))</span><span class="w"> 

</span><span class="c1"># party vote in 2011, and a smaller set of columns to do the imputation:</span><span class="w">
</span><span class="n">nzes2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nzes</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">ifelse</span><span class="p">(</span><span class="n">dlastpvote</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Don't know"</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">dlastpvote</span><span class="p">))))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="c1"># select a smaller number of variables so imputation is feasible:</span><span class="w">
   </span><span class="n">select</span><span class="p">(</span><span class="n">dwtfin</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2011</span><span class="p">,</span><span class="w"> </span><span class="n">dethnicity_m</span><span class="p">,</span><span class="w"> </span><span class="n">dage</span><span class="p">,</span><span class="w"> </span><span class="n">dhhincome</span><span class="p">,</span><span class="w"> </span><span class="n">dtradeunion</span><span class="p">,</span><span class="w"> </span><span class="n">dprofassoc</span><span class="p">,</span><span class="w">
          </span><span class="n">dhousing</span><span class="p">,</span><span class="w"> </span><span class="n">dclass</span><span class="p">,</span><span class="w"> </span><span class="n">dedcons</span><span class="p">,</span><span class="w"> </span><span class="n">dwkpt</span><span class="p">)</span><span class="w">

</span><span class="c1"># impute the missing values.  Although we are imputing only a single set of values,</span><span class="w">
</span><span class="c1"># because we are doing it with each row repeated five times this has the same impact,</span><span class="w">
</span><span class="c1"># for the simple analysis we do later on, as multiple imputation:</span><span class="w">
</span><span class="n">nzes3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">complete</span><span class="p">(</span><span class="n">mice</span><span class="p">(</span><span class="n">nzes2</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">

</span><span class="c1"># Lump up the 2011 vote, tidy labels, and work out who was too young to vote:</span><span class="w">
</span><span class="n">nzes4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nzes3</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_lump</span><span class="p">(</span><span class="n">partyvote2011</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">),</span><span class="w">
          </span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s2">"I did not vote"</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2011</span><span class="p">),</span><span class="w"> </span><span class="s2">"Did not vote"</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">partyvote2011</span><span class="p">)),</span><span class="w">
          </span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">dage</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">21</span><span class="p">,</span><span class="w"> </span><span class="s2">"Too young to vote"</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2011</span><span class="p">),</span><span class="w">
          </span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">partyvote2014</span><span class="p">))</span><span class="w">

</span><span class="c1">#===============re-weighting to match actual votes in 2011 and 2014===================</span><span class="w">

</span><span class="c1"># This makes a big difference, for both years, but more for 2011. "Did not vote" is only 16% in 2011</span><span class="w">
</span><span class="c1"># if we only calibrate to 2014 voting outcomes, but in reality was 25.8%.  We calibrate for both</span><span class="w">
</span><span class="c1"># 2011 and 2014 so the better proportions for both elections.</span><span class="w">

</span><span class="c1">#------------2014 actual outcomes----------------</span><span class="w">
</span><span class="c1"># http://www.elections.org.nz/news-media/new-zealand-2014-general-election-official-results</span><span class="w">
</span><span class="n">actual_vote_2014</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="w">
   </span><span class="n">partyvote2014</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"National"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NZ First"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Other"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Did not vote"</span><span class="p">),</span><span class="w">
   </span><span class="n">Freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1131501</span><span class="p">,</span><span class="w"> </span><span class="m">604534</span><span class="p">,</span><span class="w"> </span><span class="m">257356</span><span class="p">,</span><span class="w"> </span><span class="m">208300</span><span class="p">,</span><span class="w"> 
            </span><span class="m">31850</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">16689</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">5286</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">95598</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">34095</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">10961</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">5113</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1730</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1096</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">872</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">639</span><span class="p">,</span><span class="w">
            </span><span class="kc">NA</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># calculate the did not vote, from the 77.9 percent turnout</span><span class="w">
</span><span class="n">actual_vote_2014</span><span class="p">[</span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">77.9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2014</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w">

</span><span class="c1"># check I did the turnout sums right:</span><span class="w">
</span><span class="n">expect_equal</span><span class="p">(</span><span class="m">0.779</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2014</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="m">2</span><span class="p">]),</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2014</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]))</span><span class="w">

</span><span class="c1">#---------------2011 actual outcomes---------------------</span><span class="w">
</span><span class="c1"># http://www.elections.org.nz/events/past-events-0/2011-general-election/2011-general-election-official-results</span><span class="w">
</span><span class="n">actual_vote_2011</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="w">
   </span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"National"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Labour"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Green"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NZ First"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Other"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Did not vote"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Too young to vote"</span><span class="p">),</span><span class="w">
   </span><span class="n">Freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1058636</span><span class="p">,</span><span class="w"> </span><span class="m">614937</span><span class="p">,</span><span class="w"> </span><span class="m">247372</span><span class="p">,</span><span class="w"> </span><span class="m">147511</span><span class="p">,</span><span class="w"> 
            </span><span class="m">31982</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">24168</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">23889</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">13443</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">59237</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">11738</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1714</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1595</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1209</span><span class="p">,</span><span class="w">
            </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="c1"># calculate the did not vote, from the 74.21 percent turnout at </span><span class="w">
</span><span class="c1"># http://www.elections.org.nz/events/past-events/2011-general-election</span><span class="w">
</span><span class="n">actual_vote_2011</span><span class="p">[</span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">74.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2011</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w">

</span><span class="c1"># check I did the turnout sums right:</span><span class="w">
</span><span class="n">expect_equal</span><span class="p">(</span><span class="m">0.7421</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2011</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">6</span><span class="w"> </span><span class="p">,</span><span class="m">2</span><span class="p">]),</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2011</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]))</span><span class="w">

</span><span class="c1"># from the below, we conclude 4.8% of the 2014 population (as estimated by NZES)</span><span class="w">
</span><span class="c1"># were too young to vote in 2011:</span><span class="w">
</span><span class="n">nzes_orig</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">tooyoung</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dage</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">21</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">tooyoung</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">dwtfin</span><span class="p">),</span><span class="w">
             </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span><span class="w">

</span><span class="c1"># this is pretty approximate but will do for our purposes.</span><span class="w">
</span><span class="n">actual_vote_2011</span><span class="p">[</span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.048</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2011</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">])</span><span class="w">

</span><span class="c1"># Force the 2011 numbers to match the 2014 population</span><span class="w">
</span><span class="n">actual_vote_2011</span><span class="o">$</span><span class="n">Freq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">actual_vote_2011</span><span class="o">$</span><span class="n">Freq</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2011</span><span class="o">$</span><span class="n">Freq</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">actual_vote_2014</span><span class="o">$</span><span class="n">Freq</span><span class="p">)</span><span class="w">

</span><span class="c1">#------------create new weights--------------------</span><span class="w">
</span><span class="c1"># set up survey design with the original weights:</span><span class="w">
</span><span class="n">nzes_svy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">svydesign</span><span class="p">(</span><span class="o">~</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nzes4</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">dwtfin</span><span class="p">)</span><span class="w">

</span><span class="c1"># calibrate weights to the known total party votes in 2011 and 2014:</span><span class="w">
</span><span class="n">nzes_cal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">calibrate</span><span class="p">(</span><span class="n">nzes_svy</span><span class="p">,</span><span class="w"> 
                      </span><span class="nf">list</span><span class="p">(</span><span class="o">~</span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">partyvote2011</span><span class="p">),</span><span class="w">
                      </span><span class="nf">list</span><span class="p">(</span><span class="n">actual_vote_2014</span><span class="p">,</span><span class="w"> </span><span class="n">actual_vote_2011</span><span class="p">))</span><span class="w">

</span><span class="c1"># extract those weights for use in straight R (not just "survey")</span><span class="w">
</span><span class="n">nzes5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nzes4</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weights</span><span class="p">(</span><span class="n">nzes_cal</span><span class="p">))</span><span class="w">

</span><span class="c1"># See impact of calibrated weights for the 2014 vote:</span><span class="w">
</span><span class="n">prop.table</span><span class="p">(</span><span class="n">svytable</span><span class="p">(</span><span class="o">~</span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="n">nzes_svy</span><span class="p">))</span><span class="w"> </span><span class="c1"># original weights</span><span class="w">
</span><span class="n">prop.table</span><span class="p">(</span><span class="n">svytable</span><span class="p">(</span><span class="o">~</span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="n">nzes_cal</span><span class="p">))</span><span class="w"> </span><span class="c1"># recalibrated weights</span><span class="w">

</span><span class="c1"># See impact of calibrated weights for the 2011 vote:</span><span class="w">
</span><span class="n">prop.table</span><span class="p">(</span><span class="n">svytable</span><span class="p">(</span><span class="o">~</span><span class="n">partyvote2011</span><span class="p">,</span><span class="w"> </span><span class="n">nzes_svy</span><span class="p">))</span><span class="w"> </span><span class="c1"># original weights</span><span class="w">
</span><span class="n">prop.table</span><span class="p">(</span><span class="n">svytable</span><span class="p">(</span><span class="o">~</span><span class="n">partyvote2011</span><span class="p">,</span><span class="w"> </span><span class="n">nzes_cal</span><span class="p">))</span><span class="w"> </span><span class="c1"># recalibrated weights</span><span class="w">


</span><span class="c1">#=======================previous years vote riverplot version============</span><span class="w">

</span><span class="n">the_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nzes5</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="w">
       </span><span class="c1"># add two spaces to ensure the partyvote2011 does not have any</span><span class="w">
       </span><span class="c1"># names that exactly match the party vote in 2014</span><span class="w">
       </span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">partyvote2011</span><span class="p">,</span><span class="w"> </span><span class="s2">"  "</span><span class="p">),</span><span class="w">
       </span><span class="n">partyvote2011</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"M.ori"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Maori"</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2011</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">group_by</span><span class="p">(</span><span class="n">partyvote2011</span><span class="p">,</span><span class="w"> </span><span class="n">partyvote2014</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">summarise</span><span class="p">(</span><span class="n">vote_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> 

</span><span class="c1"># change names to the names wanted by makeRiver</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">the_data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"col1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"col2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">)</span><span class="w">

</span><span class="c1"># node ID need to be characters I think</span><span class="w">
</span><span class="n">c1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">the_data</span><span class="o">$</span><span class="n">col1</span><span class="p">)</span><span class="w">
</span><span class="n">c2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">the_data</span><span class="o">$</span><span class="n">col2</span><span class="p">)</span><span class="w">
</span><span class="n">nodes_ref</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">fullname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">c1</span><span class="p">),</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">c2</span><span class="p">))))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">LETTERS</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">()])</span><span class="w">

</span><span class="n">edges</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">the_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">nodes_ref</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fullname"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ID"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"col1"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fullname"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">N1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">nodes_ref</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fullname"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ID"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"col2"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fullname"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">N2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="n">rp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">makeRiver</span><span class="p">(</span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.vector</span><span class="p">(</span><span class="n">nodes_ref</span><span class="o">$</span><span class="n">ID</span><span class="p">),</span><span class="w"> </span><span class="n">edges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edges</span><span class="p">,</span><span class="w">
                </span><span class="n">node_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_ref</span><span class="o">$</span><span class="n">fullname</span><span class="p">,</span><span class="w">
                </span><span class="c1"># manual vertical positioning by parties.  Look at</span><span class="w">
                </span><span class="c1"># nodes_ref to see the order in which positions are set.  </span><span class="w">
                </span><span class="c1"># This is a pain, so I just let it stay with the defaults:</span><span class="w">
                </span><span class="c1">#  node_ypos = c(4, 1, 1.8, 3, 6, 7, 5, 4, 1, 1.8, 3, 6, 7),</span><span class="w">
                </span><span class="n">node_xpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_ref</span><span class="o">$</span><span class="n">position</span><span class="p">,</span><span class="w">
                </span><span class="c1"># set party colours; all based on those in nzelect::parties_v:</span><span class="w">
                </span><span class="n">node_styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#d82a20"</span><span class="p">),</span><span class="w"> </span><span class="c1"># red labour</span><span class="w">
                                   </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#00529F"</span><span class="p">),</span><span class="w"> </span><span class="c1"># blue national</span><span class="w">
                                   </span><span class="n">E</span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">),</span><span class="w">   </span><span class="c1"># black NZFirst</span><span class="w">
                                   </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#098137"</span><span class="p">),</span><span class="w"> </span><span class="c1"># green</span><span class="w">
                                   </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#d82a20"</span><span class="p">),</span><span class="w"> </span><span class="c1"># labour</span><span class="w">
                                   </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#098137"</span><span class="p">),</span><span class="w"> </span><span class="c1"># green</span><span class="w">
                                   </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#00529F"</span><span class="p">),</span><span class="w"> </span><span class="c1"># national</span><span class="w">
                                   </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)))</span><span class="w">  </span><span class="c1"># NZ First</span><span class="w">

</span><span class="c1"># Turn the text horizontal, and pale grey</span><span class="w">
</span><span class="n">ds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">default.style</span><span class="p">()</span><span class="w">
</span><span class="n">ds</span><span class="o">$</span><span class="n">srt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">ds</span><span class="o">$</span><span class="n">textcol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"grey95"</span><span class="w">

</span><span class="n">mygp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gpar</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey75"</span><span class="p">)</span><span class="w">
</span><span class="c1"># using PNG rather than SVG as vertical lines appear in the SVG version</span><span class="w">

</span><span class="n">par</span><span class="p">(</span><span class="n">bg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey40"</span><span class="p">)</span><span class="w">

</span><span class="c1"># note the plot_area argument - for some reason, defaults to using only half the</span><span class="w">
</span><span class="c1"># vertical space available, so set this to higher than 0.5!:</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span><span class="w"> </span><span class="n">default_style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ds</span><span class="p">,</span><span class="w"> </span><span class="n">plot_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span><span class="w">

</span><span class="n">title</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Self-reported party vote in 2011 compared to 2014"</span><span class="p">,</span><span class="w"> 
      </span><span class="n">col.main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w"> </span><span class="n">font.main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="n">grid.text</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.15</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2011 party vote"</span><span class="p">,</span><span class="w"> </span><span class="n">gp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mygp</span><span class="p">)</span><span class="w">
</span><span class="n">grid.text</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.85</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2014 party vote"</span><span class="p">,</span><span class="w"> </span><span class="n">gp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mygp</span><span class="p">)</span><span class="w">
</span><span class="n">grid.text</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.95</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.03</span><span class="p">,</span><span class="w"> 
          </span><span class="n">gp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpar</span><span class="p">(</span><span class="n">fontsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey75"</span><span class="p">),</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"right"</span><span class="p">,</span><span class="w">
          </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: New Zealand Election Study, analysed at https://ellisp.github.io"</span><span class="p">)</span><span class="w">

</span><span class="c1">#=======================sankeyD3 version====================</span><span class="w">

</span><span class="n">nodes_ref2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nodes_ref</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.factor</span><span class="p">(</span><span class="n">ID</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">as.data.frame</span><span class="p">()</span><span class="w">

</span><span class="n">edges2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">the_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">nodes_ref2</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fullname"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ID"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"col1"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fullname"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">N1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">left_join</span><span class="p">(</span><span class="n">nodes_ref2</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fullname"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ID"</span><span class="p">)],</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"col2"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fullname"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">rename</span><span class="p">(</span><span class="n">N2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">mutate</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">

</span><span class="n">pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'d3.scaleOrdinal()
         .range(["#DCDCDC", "#098137", "#d82a20", "#00529F",  "#000000",  "#DCDCDC", 
                 "#DCDCDC", "#098137", "#d82a20", "#00529F", "#000000", "#DCDCDC"]);'</span><span class="w">

</span><span class="n">sankeyNetwork</span><span class="p">(</span><span class="n">Links</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edges2</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes_ref2</span><span class="p">,</span><span class="w"> 
              </span><span class="n">Source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"N1"</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"N2"</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">,</span><span class="w">
              </span><span class="n">NodeID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fullname"</span><span class="p">,</span><span class="w">
              </span><span class="n">NodeGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"fullname"</span><span class="p">,</span><span class="w">
              </span><span class="n">LinkGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"col2"</span><span class="p">,</span><span class="w">
              </span><span class="n">fontSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">nodeWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w">
              </span><span class="n">colourScale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JS</span><span class="p">(</span><span class="n">pal</span><span class="p">),</span><span class="w">
              </span><span class="n">numberFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JS</span><span class="p">(</span><span class="s1">'d3.format(".1f")'</span><span class="p">),</span><span class="w">
              </span><span class="n">fontFamily</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Calibri"</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%"</span><span class="p">,</span><span class="w"> 
              </span><span class="n">nodeShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
              </span><span class="n">showNodeValues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
              </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">700</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w"> 

</span><span class="c1">#=======other by the by analysis==================</span><span class="w">
</span><span class="c1"># Age density plot by party vote</span><span class="w">

</span><span class="c1"># Remember to weight by the survey weights - in this case it controls for</span><span class="w">
</span><span class="c1"># the under or over sampling by age in the original design.</span><span class="w">
</span><span class="n">nzes5</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
   </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dage</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">nzes5</span><span class="o">$</span><span class="n">weight</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_density</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">partyvote2014</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free_y"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parties_v</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Age at time of 2014 election"</span><span class="p">,</span><span class="w">
        </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: New Zealand Election Study"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Age distribution by Party Vote in the 2014 New Zealand General Election"</span><span class="p">)</span></code></pre></figure>



		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2017/05/14/nzes-app">Web app for individual party vote from the 2014 New Zealand election study</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2017/06/04/military-gdp">Global choropleth maps of military expenditure</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<hr></hr>
			
			<p>My day job is Director of the <a href='https://sdd.spc.int/'>Statistics for Development Division</a> at the Pacific Community, the principal scientific and technical organisation in the Pacific region, proudly supporting development since 1947. We are an international development organisation owned and governed by our 27 country and territory members. This blog is not part of my role there and contains my personal views only.</p>
		
		    <hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="https://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="https://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics https://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>