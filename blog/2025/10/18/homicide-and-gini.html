      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Inequality and homicide, within-country and between country</title>
      	
         
         
            <meta name ="description" content ="Countries with higher income or consumption inequality tend to have more homicides per population. But looking at the relationship within each country's data, there does not seem to be a consistent relationship between inequality and homicide rates (that is, when there is a relationship in some countries, on average there is no evidence of such a relationship). This is an interesting multilevel or mixed-effects modelling problem that could easily trip one up.">
            <meta property="og:description" content ="Countries with higher income or consumption inequality tend to have more homicides per population. But looking at the relationship within each country's data, there does not seem to be a consistent relationship between inequality and homicide rates (that is, when there is a relationship in some countries, on average there is no evidence of such a relationship). This is an interesting multilevel or mixed-effects modelling problem that could easily trip one up.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Inequality and homicide, within-country and between country" />
         
            <meta property="og:image" content="https:/freerangestats.info/img/0303-scatter.png" />
         
		 
			<meta property="og:url" content="https://freerangestats.info/blog/2025/10/18/homicide-and-gini.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
	        <!--	  <li><a href="/blog/most-popular.html">ordered by popularity</a></li> -->
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                  <li><a href="/blog/surveys.html">all posts on surveys</a></li> 
				  <li><a href = /blog/2025/10/18/homicide-and-gini>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
				  <li><a href = "/covid-tracking/index.html">Covid-19 in Australia</a></li>
                  <li><a href = "/elections/nz-2020/index.html">NZ election 2020</a></li>
                  <li><a href = "/elections/oz-2019/index.html">Australia federal election 2019</a></li>
				  <li><a href = "/elections/nz-2017/combined.html">NZ election 2017</a></li>
                  <li><a href="/blog/voting.html">all blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Inequality and homicide, within-country and between country</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>Countries with higher income or consumption inequality tend to have more homicides per population. But looking at the relationship within each country's data, there does not seem to be a consistent relationship between inequality and homicide rates (that is, when there is a relationship in some countries, on average there is no evidence of such a relationship). This is an interesting multilevel or mixed-effects modelling problem that could easily trip one up.</p>
	   <p class="meta">18 Oct 2025</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <p>So this is a blog post about making and finding an error in modelling strategy, in an apparently simple situation.</p>

<p>I saw <a href="https://mastodon.sdf.org/@dlakelan/115055789165555934">this post (toot?) on Mastodon</a> from Daniel Lakens mentioning in passing that “On the other hand, the homicide rate across the world is well modeled as exp(k * income_gini_coefficient).” This struck me as worth checking; So I did! It turns out it is more or less correct.</p>

<p>Here is a chart I drew of homicides per 100,000 population on the vertical axis versus income or consumption inequality on the horizontal. Consumption is the preferred way to measure poverty and inequality in poorer countries in particular, so in this data, which comes from the World Bank, it is used when available.</p>

<object type="image/svg+xml" data="/img/0303-scatter.svg" width="100%"><img src="/img/0303-scatter.png" width="100%" /></object>

<p>It’s not a big point, but the model implied by Professor Lakens would be a straight diagonal line, what you’d get if you just used <code class="language-plaintext highlighter-rouge">geom_smooth(method = lm, formula = y ~ x - 1)</code>. I haven’t shown his, but two slightly more complex models.</p>

<p>Here’s the code that downloads the data, fits those models and draws the chart. A few things to note:</p>

<ul>
  <li>There’s a bit of fancy footwork to define which countries I label on the chart, and in the end also a few I chose manually and ad hoc because I was interested in them.</li>
  <li>While the y axis in this plot uses a logarithm transform, for the model itself I transformed the response variable not with a logarithm but with a BoxCox transformation that still works when countries have zero homicides in a particular year. I toyed with alternatives like using a generalized linear model with a log link (which still works when data is observed to be zero, because it will be predicted/expected to be slightly more) but decided to avoid this so I could use <code class="language-plaintext highlighter-rouge">lme</code> which lets me specify autocorrelated error terms.</li>
  <li>Because the model and plot are both a bit complex I set out my own prediction grid and calculate expected values and crude (ie assuming asymptotic normality) confidence intervals rather than using <code class="language-plaintext highlighter-rouge">marginaleffects</code> package to get me something out of the box.</li>
  <li>The ribbons drawn are showing the expected homicide rate for the country with random country effect closest to zero, which happens to be Czechia with the data at the time of writing (17 October 2025).</li>
  <li>The ribbons are also based on the assumption that the hypothetical country they refer to has an average inequality (over all years for which there are observations) as shown on the horizontal axis. This point is pretty crucial.</li>
</ul>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">WDI</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">nlme</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w"> </span><span class="c1"># for chosing box cox parameters</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">AICcmodavg</span><span class="p">)</span><span class="w"> </span><span class="c1"># for predictSE with lmer</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggrepel</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">GGally</span><span class="p">)</span><span class="w">

</span><span class="c1"># Analysis to follow up this remark:</span><span class="w">
</span><span class="c1"># https://mastodon.sdf.org/@dlakelan/115055789165555934</span><span class="w">
</span><span class="c1"># "On the other hand, the homicide rate across the world </span><span class="w">
</span><span class="c1">#  is well modeled as exp(k * income_gini_coefficient)."</span><span class="w">

</span><span class="c1">#--------Download World Bank data and prep it------------</span><span class="w">
</span><span class="c1"># These searches were used to find series with a lot of data for country-year combinations:</span><span class="w">
</span><span class="c1"># WDIsearch("homicide")</span><span class="w">
</span><span class="c1"># WDIsearch("Gini")</span><span class="w">

</span><span class="c1"># Metadata for SI.POV.GINI at https://data360files.worldbank.org/data360-data/metadata/WB_WDI/WB_WDI_SI_POV_GINI.pdf</span><span class="w">
</span><span class="c1"># Key points include:</span><span class="w">
</span><span class="c1"># * individuals (not household)</span><span class="w">
</span><span class="c1"># * adjusted for household size</span><span class="w">
</span><span class="c1"># * can be income or consumption depending on what was available</span><span class="w">

</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">WDI</span><span class="p">(</span><span class="n">indicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">homicide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"VC.IHR.PSRC.P5"</span><span class="p">,</span><span class="w"> 
                              </span><span class="n">gini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SI.POV.GINI"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">as_tibble</span><span class="p">()</span><span class="w">

</span><span class="c1"># Countries we are going to want to highlight in our chart</span><span class="w">
</span><span class="n">highlights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"United States"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Russian Federation"</span><span class="p">,</span><span class="w"> 
                  </span><span class="s2">"Samoa"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Australia"</span><span class="p">,</span><span class="w"> </span><span class="s2">"United Kingdom"</span><span class="p">,</span><span class="w">
                  </span><span class="s2">"Fiji"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mexico"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Papua New Guinea"</span><span class="p">)</span><span class="w">

</span><span class="c1"># There are a few country-years with zero homicides so can't use a simple</span><span class="w">
</span><span class="c1"># logarithm transformation, but can have a Box-Cox that has a similar result</span><span class="w">
</span><span class="c1"># Choose a lambda that gives a distribution after the transformation where</span><span class="w">
</span><span class="c1"># changes are relatively stable in absolute terms:</span><span class="w">
</span><span class="n">lambda</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">forecast</span><span class="o">::</span><span class="n">BoxCox.lambda</span><span class="p">(</span><span class="n">d</span><span class="o">$</span><span class="n">homicide</span><span class="p">)</span><span class="w">

</span><span class="c1"># version of the data we will use for plotting and modelling:</span><span class="w">
</span><span class="n">d2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">drop_na</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="w"> </span><span class="s2">"Latest"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Earlier"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">ctry_avg_gini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">gini</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Latest"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">gini</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">homicide</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">35</span><span class="w"> </span><span class="o">|</span><span class="w"> 
                                 </span><span class="n">gini</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">homicide</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.26</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">highlights</span><span class="p">),</span><span class="w">
                        </span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">),</span><span class="w">
         </span><span class="n">hom_tran</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BoxCox</span><span class="p">(</span><span class="n">homicide</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambda</span><span class="p">),</span><span class="w">
         </span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">country</span><span class="p">))</span><span class="w">  </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="w">

</span><span class="c1">#------------Modelling and predictions (for drawing 95% confidence intervals on charts)----</span><span class="w">
</span><span class="c1"># you could have random slopes too but a fair number of countries have only one</span><span class="w">
</span><span class="c1"># or two observations</span><span class="w">
</span><span class="c1"># see https://www.frontiersin.org/journals/education/articles/10.3389/feduc.2017.00058/full</span><span class="w">
</span><span class="c1"># for example which says you want at least 6 observations per group to have</span><span class="w">
</span><span class="c1"># a random slope. Not sure how many you need, but 1 isn't enough :)</span><span class="w">

</span><span class="c1"># Barchart of number of observations per country, used later in the blog post</span><span class="w">
</span><span class="n">p1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">count</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"n_obs"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">count</span><span class="p">(</span><span class="n">n_obs</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"n_countries"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_obs</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_countries</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_col</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"steelblue"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of observations (ie years)"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of countries"</span><span class="p">,</span><span class="w">
      </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Complete data for Gini coefficient and homicide rates"</span><span class="p">)</span><span class="w">

</span><span class="n">print</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="w">

</span><span class="c1"># super simple model, not mentioned in the actual blog post</span><span class="w">
</span><span class="n">model1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">hom_tran</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Latest"</span><span class="p">))</span><span class="w">

</span><span class="c1"># multilevel model with a country random intercept, and inequality only at the lowest level</span><span class="w">
</span><span class="n">model2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lme</span><span class="p">(</span><span class="n">hom_tran</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="m">1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">correlation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corAR1</span><span class="p">())</span><span class="w">


</span><span class="c1"># multilevel model with country random intercept and countries' average inequality, as well</span><span class="w">
</span><span class="c1"># as the lowest level (country-year) granularity inequality:</span><span class="w">
</span><span class="n">model3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lme</span><span class="p">(</span><span class="n">hom_tran</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">gini</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctry_avg_gini</span><span class="p">,</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="m">1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">correlation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corAR1</span><span class="p">())</span><span class="w">

</span><span class="c1"># Fairly high (and similar) coefficients, about 0.11, but for differ</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">model1</span><span class="p">)</span><span class="w"> </span><span class="c1"># 0.12 for gini</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">model3</span><span class="p">)</span><span class="w"> </span><span class="c1"># 0.11 for ctry_avg_gini; gini not significant</span><span class="w">

</span><span class="c1"># Relatively low coefficients - the country randomness </span><span class="w">
</span><span class="c1"># soaks up a lot of the randomness:</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">model2</span><span class="p">)</span><span class="w"> </span><span class="c1"># gini not significant</span><span class="w">

</span><span class="c1"># Is the average random country effect basically zero? - check:</span><span class="w">
</span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">ranef</span><span class="p">(</span><span class="n">model2</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]),</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">ranef</span><span class="p">(</span><span class="n">model3</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]),</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1"># Find the country with random effect closest to zero. Needed for predictions</span><span class="w">
</span><span class="c1"># to draw an average country ribbon on the chart, even though the country effect</span><span class="w">
</span><span class="c1"># is actually not taken into account in predictSE</span><span class="w">
</span><span class="n">avg_country</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ranef</span><span class="p">(</span><span class="n">model3</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">arrange</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">`(Intercept)`</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">row.names</span><span class="p">()</span><span class="w">

</span><span class="n">pred_grid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="n">gini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="o">:</span><span class="m">65</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">ctry_avg_gini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="o">:</span><span class="m">65</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avg_country</span><span class="p">)</span><span class="w">

</span><span class="n">pse1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">pse2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predictSE</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">pse3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predictSE</span><span class="p">(</span><span class="n">model3</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">


</span><span class="n">pred_grid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pred_grid</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">predicted1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pse1</span><span class="o">$</span><span class="n">fit</span><span class="p">,</span><span class="w">
         </span><span class="n">lower1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pse1</span><span class="o">$</span><span class="n">se.fit</span><span class="p">,</span><span class="w">
        </span><span class="n">upper1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pse1</span><span class="o">$</span><span class="n">se.fit</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">predicted2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pse2</span><span class="o">$</span><span class="n">fit</span><span class="p">,</span><span class="w">
         </span><span class="n">lower2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pse2</span><span class="o">$</span><span class="n">se.fit</span><span class="p">,</span><span class="w">
        </span><span class="n">upper2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pse2</span><span class="o">$</span><span class="n">se.fit</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">predicted3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pse3</span><span class="o">$</span><span class="n">fit</span><span class="p">,</span><span class="w">
         </span><span class="n">lower3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pse3</span><span class="o">$</span><span class="n">se.fit</span><span class="p">,</span><span class="w">
        </span><span class="n">upper3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pse3</span><span class="o">$</span><span class="n">se.fit</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">predicted1</span><span class="o">:</span><span class="n">upper3</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">InvBoxCox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambda</span><span class="p">)}))</span><span class="w">

</span><span class="c1">#------------------Draw chart--------------------</span><span class="w">

</span><span class="n">mod_cols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"purple"</span><span class="p">,</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="s2">"brown"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pink"</span><span class="p">)</span><span class="w">

</span><span class="n">p2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">homicide</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_log10</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlim</span><span class="p">(</span><span class="m">18</span><span class="p">,</span><span class="w"> </span><span class="m">70</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_shape_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">19</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"steelblue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"black"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Inequality (Gini coefficient), based on individual income or in some cases, consumption. Higher means more inequality."</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Homicide rate (per 100,000)"</span><span class="p">,</span><span class="w">
      </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Observation year:"</span><span class="p">,</span><span class="w">
      </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Observation year:"</span><span class="p">,</span><span class="w">
      </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Higher inequality countries have more homicides."</span><span class="p">,</span><span class="w">
      </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: World Bank, World Development Indicators, series VC.IHR.PSRC.P5 and SI.POV.GINI. Analysis by freerangestats.info."</span><span class="p">)</span><span class="w"> 
  
  
</span><span class="n">p2a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># model2 - just country-year level data, country random effect</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower2</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper2</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span><span class="w"> 
                </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  
  </span><span class="c1">#model3 - country-year but also country average data, country random effect</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower3</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper3</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span><span class="w"> 
                </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_label_repel</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">label</span><span class="p">),</span><span class="w"> </span><span class="n">max.overlaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey10"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2.8</span><span class="p">,</span><span class="w">
                   </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">123</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"mm"</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgb</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.04</span><span class="p">))</span><span class="w">  </span><span class="o">+</span><span class="w">
  </span><span class="c1"># annotations - text and arrows - for models 2 and 3</span><span class="w">
  </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">61.5</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
               </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_wrap</span><span class="p">(</span><span class="s2">"Model with no such average country inequality effect."</span><span class="p">,</span><span class="w"> </span><span class="m">24</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">61.5</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">200</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
               </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_wrap</span><span class="p">(</span><span class="s2">"Model including an effect for average inequality in each 
                                country over time."</span><span class="p">,</span><span class="w"> </span><span class="m">26</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  
  </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"segment"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">64</span><span class="p">,</span><span class="w"> </span><span class="n">xend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">64</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">yend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> 
            </span><span class="n">arrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrow</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"mm"</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"segment"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">64</span><span class="p">,</span><span class="w"> </span><span class="n">xend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">64</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">75</span><span class="p">,</span><span class="w"> </span><span class="n">yend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">45</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> 
            </span><span class="n">arrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrow</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s2">"mm"</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
  
  </span><span class="n">labs</span><span class="p">(</span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Selected countries highlighted. 
Shaded ribbons show 95% confidence interval of mixed effects models with random country effect and autocorrelated error terms."</span><span class="p">,</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">print</span><span class="p">(</span><span class="n">p2a</span><span class="p">)</span></code></pre></figure>

<p>In fact at first I just had that green line—<code class="language-plaintext highlighter-rouge">model2</code> in the code—which is pretty flat. I was naturally struck at how it doesn’t seem to go through the data points. At first I thought this was because I was so clever, and had incorporated a country level random effect, and allowed autocorrelation over time for the multiple observations of each country. That is, I thought I’d revealed some fundamental truth of a non-relationship where more naive modelling appeared to show a relationship.</p>

<p>To extract that model—the one with the green line that’s conspicuously under the data—from the mess of code above, it’s <code class="language-plaintext highlighter-rouge">model2</code> and it looks like this:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">model2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lme</span><span class="p">(</span><span class="n">hom_tran</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="m">1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">correlation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corAR1</span><span class="p">())</span></code></pre></figure>

<p>This seemed like the really obvious thing to fit for me. Why not just some ordinary least squares thing? Because many of the countries have multiple observations, as we see in this plot (which was created in the code chunk we’ve already seen above):</p>

<object type="image/svg+xml" data="/img/0303-number-obs.svg" width="100%"><img src="/img/0303-number-obs.png" width="100%" /></object>

<p>I would say that the thing that is most often done in this situation is to filter the data down to just one observation per country—perhaps by taking the latest observation for each country, or the one that is closest to some year that is chosen precisely because most countries have an observation in that year or close to it.</p>

<p>That seemed like a sad waste of data to me (although in my code above you can see that I did fit such a model, <code class="language-plaintext highlighter-rouge">model1</code>, and if you want to look at it, it avoids the problem I’m about to talk about!). So my thinking was to use all the data in a mixed effects model, with a random intercept at the country level to allow for the fact that each new observation on a country, while definitely worth <em>something</em>, isn’t worth as much as an independent observation because it’s going to be similar to the other observations for that country. To do this even better, as well as the country level random intercept I throw in an autocorrelation of the residuals, showing that the values in one year are expected to be correlated with those in the previous year (as indeed they turn out to be).</p>

<p>That’s all well and good but in this case it backfired on me. When I first drew this plot, with only the green line of <code class="language-plaintext highlighter-rouge">model2</code> showing, I thought “Oh that’s cool, when we correct for the fact that many of these observations are low-value repeats of the same country’s previous observations, it turns out there’s very little relationship between inequality and homicide after all”. But more thinking, and looking at some residuals, and comparing it to the more positive results from the much simpler <code class="language-plaintext highlighter-rouge">model1</code>, quickly made me realise I was barking badly up the wrong tree.</p>

<p>The problem is best illustrated by this chart that I drew at some point along the way. I realised that as I have a random intercept that is different for each country, the expected value for that country from the model will vary very much by country. But then the modelling of homicide on inequality will start from that point—the model will be seeking to explain variance in homicide rates <em>in this particular</em> country based on its observations.</p>

<object type="image/svg+xml" data="/img/0303-faceted.svg" width="100%"><img src="/img/0303-faceted.png" width="100%" /></object>

<p>If we had a random slope as well, the result would look closer to the dark grey lines in these plots—a different relationship for each country. But I hadn’t done this, because I judged there just weren’t enough observations per country for a random slope (many countries in fact have a single observation—economic inequality is difficult and costly to measure, needing a special household consumption survey if possible). So my models look more like the pale red ribbon shown here:</p>

<p>What’s happening is that we have two things going on:</p>

<ul>
  <li>Inequality <em>between</em> countries does quite a good job of explaining differences in homicide rates.</li>
  <li><em>Within</em> each country that has observations over multiple years, there is much less relationship between the two variables; and where there is a relationship, it differs country by country. For example, judging by the the black dot representing the most recent point, Australia and the United States look to have gotten more unequal over time but less homicides; Mexico has gotten less unequal and more homicides; whereas Russia, Ukraine and the UK have had decreases in both inequality and homicides. In other words, for Russia, Ukraine and the UK, the within-country data matches the between-country positive rleationship between inequality and homicide, but Australia, USA and Mexico have a negative relationship between the two variables.</li>
</ul>

<p>Another way of looking at this is to say that the random country intercept absorbs the variance in homicide that could be instead explained by that country’s enduring average inequality. But we don’t have “enduring, average inequality” as a variable in model2. If we calculate a proxy for that the obvious way (average of the inequality values we have for that country, disregarding the fact that they come from different years for each country), we can look at the relationship between this “enduring inequality” and the country intercepts in <code class="language-plaintext highlighter-rouge">model2</code>, and we see a strong positive relationship. That’s the middle left panel (a scatter plot) in the chart below, as well as the middle top correlation (0.608, well different from zero).</p>

<object type="image/svg+xml" data="/img/0303-country-level-ranef.svg" width="100%"><img src="/img/0303-country-level-ranef.png" width="100%" /></object>

<p>The other variable in that scatter plot matrix is the country effects from <code class="language-plaintext highlighter-rouge">model3</code>, which has been specified like this:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">model3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lme</span><span class="p">(</span><span class="n">hom_tran</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">gini</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctry_avg_gini</span><span class="p">,</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="m">1</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">correlation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corAR1</span><span class="p">())</span></code></pre></figure>

<p>The difference from <code class="language-plaintext highlighter-rouge">model2</code> is that now we have <code class="language-plaintext highlighter-rouge">ctry_avg_gini</code> there as our estimate of enduring average country inequality. We still have <code class="language-plaintext highlighter-rouge">gini</code>, which is the value of inequality that varies for this country year by year. That will pick up the average within-country effect.</p>

<p>In the scatterplot matrix above we can see that once we include each country’s average inequality in the model, there is no relationship between that variable and the country level random effects. This is to be expected, precisely because the model fitting process is designed to achieve this.</p>

<p>Here’s the summary results for <code class="language-plaintext highlighter-rouge">model3</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; summary(model3)
Linear mixed-effects model fit by REML
  Data: d2 
       AIC      BIC   logLik
  2542.301 2574.914 -1265.15

Random effects:
 Formula: ~1 | country
        (Intercept)  Residual
StdDev:   0.8371227 0.7065144

Correlation Structure: AR(1)
 Formula: ~1 | country 
 Parameter estimate(s):
      Phi 
0.7574314 
Fixed effects:  hom_tran ~ gini + ctry_avg_gini 
                  Value Std.Error   DF   t-value p-value
(Intercept)   -3.193199 0.3950271 1554 -8.083494  0.0000
gini           0.007850 0.0056463 1554  1.390213  0.1647
ctry_avg_gini  0.113641 0.0117143  141  9.701081  0.0000
 Correlation: 
              (Intr) gini  
gini           0.001       
ctry_avg_gini -0.858 -0.482

Standardized Within-Group Residuals:
         Min           Q1          Med           Q3          Max 
-11.47176745  -0.44184320  -0.04595294   0.42362704   3.06647091 

Number of Observations: 1698
Number of Groups: 143 

</code></pre></div></div>

<p>We see the strong effect of average country-level inequality effect, and no significant evidence of an effect of inequality within countries. Interesting! But beyond my scope today to go into that.</p>

<p>Finally I want to finish off with a clean plot of my best model and the phenomenon under question—the strong empirical relationship between economic inequality in a country and the homicide rate.</p>

<object type="image/svg+xml" data="/img/0303-scatter-final.svg" width="100%"><img src="/img/0303-scatter-final.png" width="100%" /></object>

<p>Here’s the code for that final clean plot:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">p2b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w">
  
  </span><span class="c1">#model3 - country-year but also country average data, country random effect</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower3</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper3</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span><span class="w"> 
                </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_label_repel</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">label</span><span class="p">),</span><span class="w"> </span><span class="n">max.overlaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey10"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2.8</span><span class="p">,</span><span class="w">
                   </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">123</span><span class="p">,</span><span class="w"> </span><span class="n">label.size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"mm"</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgb</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.04</span><span class="p">))</span><span class="w"> 

</span><span class="n">print</span><span class="p">(</span><span class="n">p2b</span><span class="p">)</span></code></pre></figure>

<p>Note that this builds on the object <code class="language-plaintext highlighter-rouge">p2</code> that was the basis of the first plot, the one showing both <code class="language-plaintext highlighter-rouge">model2</code> and <code class="language-plaintext highlighter-rouge">model3</code>, to avoid repetition.</p>

<p>And here’s the code for the playing around with residuals at different levels and drawing that facet plot version with 12 selected countries:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#---------------residuals from model2 and model3---------------</span><span class="w">

</span><span class="c1"># Individual level residuals - plot not used in blog</span><span class="w">
</span><span class="n">p3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">`Residuals from Model 2`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">residuals</span><span class="p">(</span><span class="n">model2</span><span class="p">),</span><span class="w">
          </span><span class="n">`Residuals from Model 3`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">residuals</span><span class="p">(</span><span class="n">model3</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">select</span><span class="p">(</span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">`Residuals from Model 2`</span><span class="p">,</span><span class="w"> </span><span class="n">`Residuals from Model 3`</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">gini</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Inequality"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Residuals (on Box-Cox transformed scale)"</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Residuals from two mixed-effects models of homicide"</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Residuals at the most granular level ie year-country are uncorrelated with inequality"</span><span class="p">)</span><span class="w">

</span><span class="n">svg_png</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span><span class="w"> </span><span class="s2">"../img/0303-residuals"</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">

</span><span class="c1"># out of curiousity what are those low outlier residuals? - Iceland and Malta</span><span class="w">
</span><span class="nf">round</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">residuals</span><span class="p">(</span><span class="n">model2</span><span class="p">)),</span><span class="m">2</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">
</span><span class="nf">round</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">residuals</span><span class="p">(</span><span class="n">model3</span><span class="p">)),</span><span class="m">2</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">

</span><span class="c1"># Country level effects plot - pairs plot used in blog</span><span class="w">
</span><span class="n">p4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(){</span><span class="w">
  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">distinct</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">ctry_avg_gini</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">`Country effects in Model 2`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ranef</span><span class="p">(</span><span class="n">model2</span><span class="p">)[[</span><span class="m">1</span><span class="p">]],</span><span class="w">
         </span><span class="n">`Country effects in Model 3`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ranef</span><span class="p">(</span><span class="n">model3</span><span class="p">)[[</span><span class="m">1</span><span class="p">]])</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">rename</span><span class="p">(</span><span class="n">`Countries' average inequality`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctry_avg_gini</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggpairs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Comparison of country-level random effects in two models"</span><span class="p">,</span><span class="w">
      </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Model 3 has a fixed effect for countries' average inequality; Model 2 doesn't.
The country-level residuals are correlated with this variable in Model 2, but not Model 3."</span><span class="p">)</span><span class="w">
 
    </span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">p4</span><span class="p">()</span><span class="w">


</span><span class="c1">#---------------further illustrations - facets----------------------</span><span class="w">
</span><span class="n">d3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">filter</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">highlights</span><span class="p">,</span><span class="w"> </span><span class="s2">"South Africa"</span><span class="p">,</span><span class="w"> </span><span class="s2">"France"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Japan"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Ukraine"</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">lm</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">homicide</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">gini</span><span class="p">))[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replace_na</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_reorder</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w">  </span><span class="n">fct_drop</span><span class="p">())</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w">


</span><span class="n">pred_grid2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">filter</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">d3</span><span class="o">$</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">distinct</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">ctry_avg_gini</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">expand_grid</span><span class="p">(</span><span class="n">gini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="o">:</span><span class="m">70</span><span class="p">)</span><span class="w">

</span><span class="c1"># Note that predictSE excludes random country effect....</span><span class="w">
</span><span class="n">more_preds2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predictSE</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid2</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">more_preds3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predictSE</span><span class="p">(</span><span class="n">model3</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid2</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">


</span><span class="n">pred_grid2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pred_grid2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">predicted2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">more_preds2</span><span class="o">$</span><span class="n">fit</span><span class="p">,</span><span class="w">
         </span><span class="n">lower2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">more_preds2</span><span class="o">$</span><span class="n">se.fit</span><span class="p">,</span><span class="w">
         </span><span class="n">upper2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">more_preds2</span><span class="o">$</span><span class="n">se.fit</span><span class="p">,</span><span class="w">
         </span><span class="n">predicted3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">more_preds3</span><span class="o">$</span><span class="n">fit</span><span class="p">,</span><span class="w">
         </span><span class="n">lower3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">more_preds3</span><span class="o">$</span><span class="n">se.fit</span><span class="p">,</span><span class="w">
        </span><span class="n">upper3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predicted3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">more_preds3</span><span class="o">$</span><span class="n">se.fit</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="n">predicted2</span><span class="o">:</span><span class="n">upper3</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">InvBoxCox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambda</span><span class="p">)}))</span><span class="w">



</span><span class="n">p5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levels</span><span class="p">(</span><span class="n">d3</span><span class="o">$</span><span class="n">country</span><span class="p">)))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">drop_na</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gini</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">homicide</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_log10</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">100</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlim</span><span class="p">(</span><span class="m">18</span><span class="p">,</span><span class="w"> </span><span class="m">70</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_shape_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">19</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"steelblue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"black"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_grid2</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower3</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upper3</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span><span class="w"> 
                </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_cols</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lm</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey50"</span><span class="p">,</span><span class="w"> </span><span class="n">fullrange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">  </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Inequality (Gini coefficient), based on individual income or in some cases, consumption. Higher means more inequality."</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Homicide rate (per 100,000)"</span><span class="p">,</span><span class="w">
      </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Observation year:"</span><span class="p">,</span><span class="w">
      </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Observation year:"</span><span class="p">,</span><span class="w">
      </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Higher inequality countries have more homicides."</span><span class="p">,</span><span class="w">
      </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"But for any given country, the relationship over time may well be the reverse.
Pale ribbons show a model's confidence interval for homicide for a country's average over time level of inequality.
Dark line shows simple model fit to just this country's data."</span><span class="p">,</span><span class="w">
      </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: World Bank, World Development Indicators, series VC.IHR.PSRC.P5 and SI.POV.GINI. Analysis by freerangestats.info."</span><span class="p">)</span><span class="w"> 
  
</span><span class="n">print</span><span class="p">(</span><span class="n">p5</span><span class="p">)</span></code></pre></figure>

<p>The full set of code, in sequence, can be <a href="https://github.com/ellisp/blog-source/blob/master/_working/0303-homicide-inequality.R">found on GitHub</a> if the above presentaiton is confusing.</p>


		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2025/10/05/earhart-map">Mapping locations related to the Amelia Earhart disappearance</a></p>
		
		
		
		
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>

			<p>My day job is Director of the <a href='https://sdd.spc.int/'>Statistics for Development Division</a> at the Pacific Community, the principal scientific and technical organisation in the Pacific region, proudly supporting development since 1947. We are an international development organisation owned and governed by our 27 country and territory members. This blog is not part of my role there and contains my personal views only.</p>
		
		    <hr></hr>
			
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<p>Find me on <a rel="me" href="https://bsky.app/profile/freerangestats.info">Bluesky</a> or <a rel="me" href="https://mastodon.social/@peter_ellis">Mastodon</a>.</p>
			<hr></hr>
			


       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="https://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			
			<p>I've never been an academic but have written a few small things and hence have a <a href='https://scholar.google.com/citations?view_op=list_works&hl=en&user=MEtLNDMAAAAJ'>Google Scholar profile</a></p>
			
			<p>I read a lot of books. In the unlikely event you want to see what I think about them or what I'm reading at the moment, <a href='https://www.goodreads.com/user/show/55517482-peter-ellis'>follow me on Goodreads</a>.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="https://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			
			<h4>Bluesky feed:</h3>
         <script src="https://cdn.jsdelivr.net/npm/bsky-embed/dist/bsky-embed.es.js" async></script>
<bsky-embed  
  username="freerangestats.info"  
  limit="5"  
>  
</bsky-embed>

    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics https://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>