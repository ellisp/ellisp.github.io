      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Making a database of security prices and volumes</title>
      	
         
         
            <meta name ="description" content ="I make a SQLite database of daily observations of Australian security prices, volumes and short positions.">
            <meta property="og:description" content ="I make a SQLite database of daily observations of Australian security prices, volumes and short positions.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="Making a database of security prices and volumes" />
         
            <meta property="og:image" content="https:/freerangestats.info/img/0199-er-diagram.png" />
         
		 
			<meta property="og:url" content="https://freerangestats.info/blog/2021/02/14/stock-database.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                  <li><a href="/blog/surveys.html">all posts on surveys</a></li> 
				  <li><a href = /blog/2025/06/14/more-on-fragile-p-values>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
				  <li><a href = "/covid-tracking/index.html">Covid-19 in Australia</a></li>
                  <li><a href = "/elections/nz-2020/index.html">NZ election 2020</a></li>
                  <li><a href = "/elections/oz-2019/index.html">Australia federal election 2019</a></li>
				  <li><a href = "/elections/nz-2017/combined.html">NZ election 2017</a></li>
                  <li><a href="/blog/voting.html">all blog posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>Making a database of security prices and volumes</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>I make a SQLite database of daily observations of Australian security prices, volumes and short positions.</p>
	   <p class="meta">14 Feb 2021</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <h2 id="motivation">Motivation</h2>

<p>So, there’s been a  recent flurry of attention to the stock market. It prompted <a href="/blog/2021/02/05/stock-visualizations">last week’s post</a>. But it also reminded me to bubble up to higher in my priority list a project to create a database of daily security prices and short positions from open data sources.</p>

<p>Yahoo Finance is an excellent data source and the <code class="language-plaintext highlighter-rouge">quantmod</code> R package provides a very convenient way of accessing it, but fundamentally its API is oriented around looking up a single security and examining its price and volume trends. This is fine for many purposes, but for analysis <em>across</em> securities one wants to start with a generic question like “which stocks have had the highest growth rate in price or volume”. This requires a data set of all available security prices, rather than looking them up one at a time.</p>

<p>It is in fact possible to create the dataset I want for these purposes from scratch from original sources in a few hours, but as I’m thinking of using this multiple times I want to persist it somehow to avoid duplicate work and hitting the original data sources more than needed. Caveat - I think this is allowed with the data sources I’m working with but it’s frustratingly difficult to find out for sure. If I’m wrong, let me know and I’ll pull down this post.</p>

<p>A database is the obvious solution. In this blog post I build such a database using SQLite, which works well enough for my single-user use case. At work we’d use SQL Server for a job like this but part of my motivation for today was to push me into a different zone and work with a less familiar tool, to remind myself of which things are idiosyncratic to which database systems.</p>

<h2 id="the-data-model">The data model</h2>

<p>For my purposes I am happy with daily data. The data I want to store has an obvious grain of date-security ie one row for each day for each security that I have data for. This implies just two dimensions - date and security (or product, as I call it below, following ASIC’s terminology for their published data on short positions). The facts that I’m interested in are the open, high, low, close and adjusted price for each day; the volume of transactions; the short position; the total float; and the short position as a proportion of the total float. The price and volume data can come from Yahoo Finance, and the short positions data can be downloaded from the <a href="https://asic.gov.au/regulatory-resources/markets/short-selling/short-position-reports-table/">Australian Securities and Investment Commission</a>, who collect self-reports from short sellers.</p>

<p>My initial plan was just two tables:</p>

<ul>
  <li>one for the product dimension with unchanging (or slowly changing) information like its ASX ticker, the ticker on Yahoo Finance, its latest name with various alternative approaches to punctuation</li>
  <li>one for the facts, with separate columns for the nine facts (open price, volume, etc) listed in the previous paragraph.</li>
</ul>

<p>I think this is indeed probably the correct structure for a Kimball-style dimensionally modelled analytical datamart. However, it proved unpleasant to write the extract-transform-load for my two data sources into that wide fact table. It would have involved a lot of <code class="language-plaintext highlighter-rouge">UPDATE</code> operations to add data from one source to columns for rows that are partly populated by the other). SQLite in particular does not really support <code class="language-plaintext highlighter-rouge">UPDATE</code> in combination with a <code class="language-plaintext highlighter-rouge">JOIN</code> and getting around this would have been awkward. So to simplify things I normalised the data one step further and made my fact table more “long and thin”. This meant adding a variable dimension so that when extra data comes in from another source I am just adding new rows to the data for a subset of variables rather than filling in empty columns for existing rows.</p>

<p>Here’s how the data model looks:</p>

<p><img src="/img/0199-er-diagram.png" width="100%" /></p>

<p>I used the excellent (and free) <a href="short_positions_prop">DBeaver universal database tool</a> to make that diagram, and to develop any non-trivial SQL code used in this blog.</p>

<p>And this is the SQL that creates it. I’ve used <code class="language-plaintext highlighter-rouge">GO</code> (in the style of Microsoft T-SQL) to separate each command, not because SQLite understands it (it doesn’t) but because I have R functions that do, which I’ll be using in a minute.</p>

<p><em>Post continues below SQL code</em></p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- Drop existing version of database (careful!):</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">f_prices_and_volumes</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">d_variables</span><span class="p">;</span>
<span class="k">GO</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">d_products</span><span class="p">;</span>
<span class="k">GO</span>

<span class="c1">-- Define the various tables:</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">d_products</span> <span class="p">(</span>
  <span class="n">product_id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">ticker_yahoo</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
  <span class="n">ticker_origin</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
  <span class="n">exchange_origin</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
  <span class="n">latest_full_description</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
  <span class="n">latest_full_description_tc</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
  <span class="n">industry_group</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
  <span class="n">latest_observed</span> <span class="nb">DATE</span>
  
<span class="p">)</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">d_variables</span> <span class="p">(</span>
  <span class="n">variable_id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="k">variable</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span>
<span class="p">)</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">f_prices_and_volumes</span> <span class="p">(</span>
  <span class="n">product_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
  <span class="n">observation_date</span> <span class="nb">DATE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">variable_id</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">value</span> <span class="nb">FLOAT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  
  <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">d_products</span> <span class="p">(</span><span class="n">product_id</span><span class="p">),</span>
  <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">variable_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">d_variables</span> <span class="p">(</span><span class="n">variable_id</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">one_obs_per_var</span> 
    <span class="k">ON</span> <span class="n">f_prices_and_volumes</span><span class="p">(</span><span class="n">variable_id</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">observation_date</span><span class="p">);</span>
<span class="k">GO</span>

<span class="c1">-- Populate the variables dimension:</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">d_variables</span> <span class="p">(</span><span class="k">variable</span><span class="p">)</span> <span class="k">VALUES</span>
	<span class="p">(</span><span class="s1">'open'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'high'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'low'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'close'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'volume'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'adjusted'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'short_positions'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'total_product_in_issue'</span><span class="p">),</span>
	<span class="p">(</span><span class="s1">'short_positions_prop'</span><span class="p">)</span></code></pre></figure>

<h2 id="populating-with-data">Populating with data</h2>

<p>I used R for accessing the origin data from the web and sending SQL commands to set up the database. Here’s the first chunk of code that creates the empty database, runs the SQL above to set up tables, and makes an initial dump of ASX listed companies into the <code class="language-plaintext highlighter-rouge">d_products</code> table. I adapted some of this and subsequent code from <a href="https://www.michaelplazzer.com/import-asx-data-r/">this blog post</a> by Michael Plazzer. I’m not sure how definitive is that list of ASX listed companies referred to in the below code.</p>

<p><em>Post continues below R code</em></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">glue</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">frs</span><span class="p">)</span><span class="w"> </span><span class="c1"># for download_if_fresh and execute_sql. Available from GitHub.</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">janitor</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggrepel</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">kableExtra</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">quantmod</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RSQLite</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">DBI</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span><span class="w">

</span><span class="c1">#=============database setup============================</span><span class="w">


</span><span class="c1">#-----------Define database------------------</span><span class="w">
</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="s2">"stocks.sqlite"</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">list.files</span><span class="p">()){</span><span class="w">
  </span><span class="c1"># if this is the very first run we need to create the empty database and its tables</span><span class="w">
  </span><span class="n">con</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbConnect</span><span class="p">(</span><span class="n">RSQLite</span><span class="o">::</span><span class="n">SQLite</span><span class="p">(),</span><span class="w"> </span><span class="s2">"stocks.sqlite"</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># run the SQL script that defines the table - needs to be saved in seaprate file:</span><span class="w">
  </span><span class="n">execute_sql</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"0199-stocks-db-setup.sql"</span><span class="p">,</span><span class="w"> </span><span class="n">log_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w">
  
</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">con</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbConnect</span><span class="p">(</span><span class="n">RSQLite</span><span class="o">::</span><span class="n">SQLite</span><span class="p">(),</span><span class="w"> </span><span class="s2">"stocks.sqlite"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#------------set up product dimension-----------</span><span class="w">

</span><span class="n">asx_cos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"http://www.asx.com.au/asx/research/ASXListedCompanies.csv"</span><span class="p">,</span><span class="n">skip</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">ticker_yahoo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">ASX.code</span><span class="p">,</span><span class="w"> </span><span class="s2">".AX"</span><span class="p">),</span><span class="w">
         </span><span class="n">exchange_origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ASX"</span><span class="p">,</span><span class="w">
         </span><span class="n">latest_observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w">
         </span><span class="n">latest_full_description_tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tools</span><span class="o">::</span><span class="n">toTitleCase</span><span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">Company.name</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="w">
    </span><span class="n">ticker_yahoo</span><span class="p">,</span><span class="w">
    </span><span class="n">ticker_origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASX.code</span><span class="p">,</span><span class="w">
    </span><span class="n">exchange_origin</span><span class="p">,</span><span class="w">
    </span><span class="n">latest_full_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Company.name</span><span class="p">,</span><span class="w">
    </span><span class="n">latest_full_description_tc</span><span class="p">,</span><span class="w">
    </span><span class="n">industry_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GICS.industry.group</span><span class="p">,</span><span class="w">
    </span><span class="n">latest_observed</span><span class="w">
  </span><span class="p">)</span><span class="w">

</span><span class="n">RSQLite</span><span class="o">::</span><span class="n">dbWriteTable</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"d_products"</span><span class="p">,</span><span class="w"> </span><span class="n">asx_cos</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span></code></pre></figure>

<h2 id="loading-the-short-positions-data">Loading the short positions data</h2>

<p>The short positions data from the ASIC website includes many products that aren’t in the list of listed companies on the ASX site. In general, I want to be able to update my list of products/securities. Getting data from Yahoo Finance, where I specify a security ticker code and then get the data, won’t let me do this (unless I tried codes at random). Because of all this, in my initial bulk upload I do the ASIC data first, hoping (without really checking how it happens, which of course I would for a more formal use) that this will surface new (or old) securities that aren’t in the spreadsheet I downloaded from the ASX.</p>

<p>The code below is in two chunks. It downloads all the CSVs of short positions data from ASIC, taking care not to re-download data it already has. Each CSV represents one day of three facts on each product. Then (somewhat more complex), it reads all the CSVs one at a time (if it hasn’t already processed this particular CSV); identifies missing products/securities which it then adds to the <code class="language-plaintext highlighter-rouge">d_products</code> table; then populates the fact table with the facts for all the products it’s found in this particular CSV, having matched them to the <code class="language-plaintext highlighter-rouge">product_id</code> field in the <code class="language-plaintext highlighter-rouge">d_products</code> table.</p>

<p>Other than the three-card shuffle with adding new products to <code class="language-plaintext highlighter-rouge">d_products</code> as it goes, and some annoying complications with different formats and encoding of the CSV files on the ASIC page (see comments in the code), this is fairly straightforward data-wrangling stuff for R.</p>

<p>This took three or four hours each for the two bits of functionality (bulk download and bulk import) to run.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#===============Get the short positions data=============</span><span class="w">

</span><span class="c1">#----------Download-------------</span><span class="w">
</span><span class="c1"># From:</span><span class="w">
</span><span class="c1"># https://asic.gov.au/regulatory-resources/markets/short-selling/short-position-reports-table/</span><span class="w">

</span><span class="n">all_dates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"2010-06-16"</span><span class="p">),</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sys.Date</span><span class="p">(),</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">dir.create</span><span class="p">(</span><span class="s2">"asic-shorts"</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">all_dates</span><span class="p">)){</span><span class="w">
  </span><span class="n">the_date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">all_dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
  
  </span><span class="c1"># Don't bother trying to download on weekends:</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">wday</span><span class="p">(</span><span class="n">the_date</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Sat"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Sun"</span><span class="p">)){</span><span class="w">
    </span><span class="k">next</span><span class="p">()</span><span class="w">
    </span><span class="p">}</span><span class="w">
  
  </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">str_pad</span><span class="p">(</span><span class="n">month</span><span class="p">(</span><span class="n">the_date</span><span class="p">),</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">side</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"left"</span><span class="p">,</span><span class="w"> </span><span class="n">pad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0"</span><span class="p">)</span><span class="w">
  </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">the_date</span><span class="p">)</span><span class="w">
  </span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="n">the_date</span><span class="p">,</span><span class="w"> </span><span class="s2">"%Y%m%d"</span><span class="p">)</span><span class="w">
  </span><span class="n">fn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glue</span><span class="p">(</span><span class="s2">"RR{ch}-001-SSDailyAggShortPos.csv"</span><span class="p">)</span><span class="w">
  
  </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glue</span><span class="p">(</span><span class="s2">"https://asic.gov.au/Reports/Daily/{y}/{m}/{fn}"</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># Only exists for trading days. Rather than bother to work out exactly the trading days,</span><span class="w">
  </span><span class="c1"># we will just skip over any 404 error</span><span class="w">
  </span><span class="n">try</span><span class="p">(</span><span class="n">download_if_fresh</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">glue</span><span class="p">(</span><span class="s2">"asic-shorts/{fn}"</span><span class="p">)))</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="c1">#----------------------Import---------------------------</span><span class="w">

</span><span class="n">all_products</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"SELECT product_id, ticker_yahoo 
                                 FROM d_products 
                                 WHERE exchange_origin = 'ASX'"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">as_tibble</span><span class="p">()</span><span class="w">

</span><span class="n">already_done_dates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"SELECT DISTINCT observation_date AS od
                                      FROM f_prices_and_volumes AS a
                                      INNER JOIN d_variables AS b
                                        On a.variable_id = b.variable_id
                                      WHERE b.variable = 'short_positions'
                                      ORDER BY observation_date"</span><span class="p">)</span><span class="o">$</span><span class="n">od</span><span class="w">

</span><span class="n">d_variables</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"select variable_id, variable from d_variables"</span><span class="p">)</span><span class="w">

</span><span class="n">all_csvs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="s2">"asic-shorts"</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"DailyAggShortPos"</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># we are going to do this backwards so product names are the latest ones</span><span class="w">
</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">all_csvs</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="m">1</span><span class="p">){</span><span class="w">
  
  </span><span class="n">the_csv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">all_csvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
  </span><span class="n">the_date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">str_extract</span><span class="p">(</span><span class="n">the_csv</span><span class="p">,</span><span class="w"> </span><span class="s2">"[0-9]+"</span><span class="p">),</span><span class="w"> </span><span class="n">format</span><span class="o">=</span><span class="w"> </span><span class="s2">"%Y%m%d"</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># if we've already got short positions observations in the data for this date,</span><span class="w">
  </span><span class="c1"># then break out of the loop and go to the next iteration</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">the_date</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">already_done_dates</span><span class="p">){</span><span class="k">next</span><span class="p">()}</span><span class="w">
  
  </span><span class="c1"># The first 1400 files are actually tab-delimited and UTF-16, the</span><span class="w">
  </span><span class="c1"># rest are genuine comma separated files and more standard encoding.</span><span class="w">
  </span><span class="c1"># Couldn't get read_csv to work with the various encoding here.</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">1400</span><span class="p">){</span><span class="w">
    </span><span class="n">d1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">the_csv</span><span class="p">,</span><span class="w"> </span><span class="n">fileEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UTF-16"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\t"</span><span class="p">)</span><span class="w"> 
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">d1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">the_csv</span><span class="p">)</span><span class="w"> 
    </span><span class="c1"># sometimes this still doesn't work and we go back to the other method:</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">10</span><span class="p">){</span><span class="w">
      </span><span class="n">d1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">the_csv</span><span class="p">,</span><span class="w"> </span><span class="n">fileEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UTF-16"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\t"</span><span class="p">)</span><span class="w"> 
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="n">d2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">clean_names</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">as_tibble</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">observation_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_date</span><span class="p">,</span><span class="w">
           </span><span class="n">ticker_yahoo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">str_trim</span><span class="p">(</span><span class="n">product_code</span><span class="p">),</span><span class="w"> </span><span class="s2">".AX"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">left_join</span><span class="p">(</span><span class="n">all_products</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ticker_yahoo"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="w">
      </span><span class="n">product_id</span><span class="p">,</span><span class="w">
      </span><span class="n">observation_date</span><span class="p">,</span><span class="w">
      </span><span class="n">short_positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reported_short_positions</span><span class="p">,</span><span class="w">
      </span><span class="n">total_product_in_issue</span><span class="p">,</span><span class="w">
      </span><span class="n">short_positions_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x_of_total_product_in_issue_reported_as_short_positions</span><span class="p">,</span><span class="w">
      </span><span class="n">ticker_yahoo</span><span class="p">,</span><span class="w">
      </span><span class="n">product</span><span class="p">,</span><span class="w">
      </span><span class="n">product_code</span><span class="w">
    </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1"># convert from percentage to proportion:</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">short_positions_prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">short_positions_prop</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">
  
  </span><span class="n">non_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">d2</span><span class="o">$</span><span class="n">product_id</span><span class="p">))</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">non_match</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="w">
    </span><span class="n">message</span><span class="p">(</span><span class="n">glue</span><span class="p">(</span><span class="s2">"Found {non_match} products in the short data not yet in the database"</span><span class="p">))</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">filter</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="nf">is.na</span><span class="p">(</span><span class="n">product_id</span><span class="p">)),</span><span class="w"> </span><span class="n">ticker_yahoo</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">observation_date</span><span class="p">))</span><span class="w">
    
    </span><span class="n">new_products</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">product_id</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">exchange_origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'ASX'</span><span class="p">,</span><span class="w">
             </span><span class="n">latest_full_description_tc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tools</span><span class="o">::</span><span class="n">toTitleCase</span><span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">product</span><span class="p">)),</span><span class="w">
             </span><span class="n">industry_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
             </span><span class="n">latest_observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
             </span><span class="n">ticker_origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_trim</span><span class="p">(</span><span class="n">product_code</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">select</span><span class="p">(</span><span class="n">ticker_yahoo</span><span class="p">,</span><span class="w">
             </span><span class="n">ticker_origin</span><span class="p">,</span><span class="w">
             </span><span class="n">exchange_origin</span><span class="p">,</span><span class="w">
             </span><span class="n">latest_full_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w">
             </span><span class="n">latest_full_description_tc</span><span class="p">,</span><span class="w">
             </span><span class="n">industry_group</span><span class="p">,</span><span class="w">
             </span><span class="n">latest_observed</span><span class="p">)</span><span class="w">
    
    </span><span class="n">RSQLite</span><span class="o">::</span><span class="n">dbWriteTable</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"d_products"</span><span class="p">,</span><span class="w"> </span><span class="n">new_products</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
    
    </span><span class="n">all_products</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"SELECT product_id, ticker_yahoo 
                                 FROM d_products 
                                 WHERE exchange_origin = 'ASX'"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">as_tibble</span><span class="p">()</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="n">upload_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">select</span><span class="p">(</span><span class="n">observation_date</span><span class="o">:</span><span class="n">ticker_yahoo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">left_join</span><span class="p">(</span><span class="n">all_products</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ticker_yahoo"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">ticker_yahoo</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">observation_date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">left_join</span><span class="p">(</span><span class="n">d_variables</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"variable"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">select</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w">
         </span><span class="n">observation_date</span><span class="p">,</span><span class="w">
         </span><span class="n">variable_id</span><span class="p">,</span><span class="w">
         </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1"># a small number of occasions the short_positions_prop is NA or Inf because</span><span class="w">
    </span><span class="c1"># the totla product in issue is 0 even though there are some short positions.</span><span class="w">
    </span><span class="c1"># we will just filter these out</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">observation_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">observation_date</span><span class="p">))</span><span class="w">
  
  </span><span class="n">dbWriteTable</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"f_prices_and_volumes"</span><span class="p">,</span><span class="w"> </span><span class="n">upload_data</span><span class="p">,</span><span class="w"> </span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># progress counter so we know it isn't just stuck</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">cat</span><span class="p">(</span><span class="n">i</span><span class="p">)}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="loading-the-price-and-volumes-data">Loading the price and volumes data</h2>

<p>Next step is to get some data from Yahoo Finance on price and volumes. Overall, this is more straightforward. The <code class="language-plaintext highlighter-rouge">quantmod</code> R package describes the functionality I’m about to use as “essentially a simple wrapper to the underlying Yahoo! finance site’s historical data download”.</p>

<p>I’ve tried in the code below to make this updateable, so in future I can run the same code without downloading all the historical data again. But I haven’t fully tested this; it’s more a working prototype than production-ready code (and I wouldn’t use SQLite for production in this case). But here’s code that works, at least for now. It gets all the Australian security ticker names in the format used by Yahoo (finishing with <code class="language-plaintext highlighter-rouge">.AX</code> for the ASX) and their matching <code class="language-plaintext highlighter-rouge">product_id</code> values for my database; finds the latest data data is available in the database; downloads anything additional to that; normalises it into long format and uploads it to the fact table in the database.</p>

<p>This took a couple of hours to run (I didn’t time it precisely).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#================stock price and volume information===========</span><span class="w">

</span><span class="n">all_stocks</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"SELECT product_id, ticker_yahoo 
                               FROM d_products 
                               ORDER BY product_id"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">as_tibble</span><span class="p">()</span><span class="w">

</span><span class="n">i</span><span class="o">=</span><span class="m">1</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">i</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">all_stocks</span><span class="p">)){</span><span class="w">
  </span><span class="c1"># display a counter ever 20 iterations so we know we're making progress:</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">ax_ticker</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">all_stocks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">ticker_yahoo</span><span class="w">
  
  </span><span class="n">latest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">glue</span><span class="p">(</span><span class="s2">"select max(observation_date) as x from f_prices_and_volumes 
                        where product_id = {all_stocks[i, ]$product_id}"</span><span class="p">))</span><span class="o">$</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">latest</span><span class="p">)){</span><span class="w">
    </span><span class="n">start_date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"1980-01-01"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">start_date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">start_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Sys.Date</span><span class="p">()){</span><span class="w">
    </span><span class="n">tryCatch</span><span class="p">({</span><span class="w">
      </span><span class="n">df_get</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">getSymbols</span><span class="p">(</span><span class="w">
        </span><span class="n">ax_ticker</span><span class="p">,</span><span class="w">
        </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'yahoo'</span><span class="p">,</span><span class="w">
        </span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_date</span><span class="p">,</span><span class="w">
        </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sys.Date</span><span class="p">(),</span><span class="w">
        </span><span class="n">auto.assign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">))</span><span class="w"> 
      
      </span><span class="k">if</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">df_get</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="w">
        </span><span class="n">df_get</span><span class="o">$</span><span class="n">observation_date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">df_get</span><span class="p">)</span><span class="w">
        
        </span><span class="n">row.names</span><span class="p">(</span><span class="n">df_get</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
        </span><span class="nf">names</span><span class="p">(</span><span class="n">df_get</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"open"</span><span class="p">,</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w"> </span><span class="s2">"low"</span><span class="p">,</span><span class="w"> </span><span class="s2">"close"</span><span class="p">,</span><span class="w"> </span><span class="s2">"volume"</span><span class="p">,</span><span class="w"> </span><span class="s2">"adjusted"</span><span class="p">,</span><span class="w"> </span><span class="s2">"observation_date"</span><span class="p">)</span><span class="w">
        </span><span class="n">upload_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_get</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">as_tibble</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">mutate</span><span class="p">(</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_stocks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="o">$</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">gather</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">observation_date</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">product_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">inner_join</span><span class="p">(</span><span class="n">d_variables</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"variable"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">select</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w">
                 </span><span class="n">observation_date</span><span class="p">,</span><span class="w">
                 </span><span class="n">variable_id</span><span class="p">,</span><span class="w">
                 </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">filter</span><span class="p">(</span><span class="n">observation_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">start_date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
          </span><span class="n">mutate</span><span class="p">(</span><span class="n">observation_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">observation_date</span><span class="p">))</span><span class="w">
        
        </span><span class="n">dbWriteTable</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="s2">"f_prices_and_volumes"</span><span class="p">,</span><span class="w"> </span><span class="n">upload_data</span><span class="p">,</span><span class="w"> </span><span class="n">append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
      
    </span><span class="p">},</span><span class="w">
    </span><span class="n">error</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="p">){})</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="updating-the-product-dimension-with-some-summary-data">Updating the product dimension with some summary data</h2>

<p>The final steps in the extract-transform-load process are some convenience additions to the database. First, I update the <code class="language-plaintext highlighter-rouge">d_products</code> table which has a <code class="language-plaintext highlighter-rouge">latest_observed</code> column in it with the most recent observation for each product:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#===============Update the observation dates in the dimension table============</span><span class="w">
</span><span class="c1"># This is much more complicated with SQLite than in SQL Server because of the</span><span class="w">
</span><span class="c1"># apparent inability of SQLite to elegantly update a table via a join with</span><span class="w">
</span><span class="c1"># another table. There may be a better way than the below but I couldn't find it:</span><span class="w">

</span><span class="n">sql1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="s2">"CREATE TABLE tmp AS
  SELECT product_id, max(observation_date) as the_date
  FROM f_prices_and_volumes 
  WHERE observation_date IS NOT NULL
  GROUP BY product_id;"</span><span class="w">

</span><span class="n">sql2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
  </span><span class="s2">"UPDATE d_products
  SET latest_observed = (SELECT the_date FROM tmp WHERE d_products.product_id = tmp.product_id)
  WHERE EXISTS (SELECT * FROM tmp WHERE d_products.product_id = tmp.product_id);"</span><span class="w">

</span><span class="n">sql3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"DROP TABLE tmp;"</span><span class="w">


</span><span class="n">dbSendQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql1</span><span class="p">)</span><span class="w">
</span><span class="n">dbSendQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql2</span><span class="p">)</span><span class="w">
</span><span class="n">dbSendQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql3</span><span class="p">)</span></code></pre></figure>

<p>Finally, I want to create a wider version of the data, closer to my original idea of a fact table with one row per product-date combination, and nine fact columns (for open price, volume, short position, etc). In another database I would use an indexed or materialized view for this sort of thing, but SQLite doesn’t support that. I tried making a view (basically a stored query) but its performance was too slow. So I created a whole new table that will need to be created from scratch after each update of the data. This isn’t as disastrous as it sounds - an indexed view does something similar in terms of disk space, and it only takes a minute or so to run this. And it is a convenient table to have.</p>

<p>So here’s the final step in this whole data upload and update process, creating that wide table from scratch. Note the clunky (to R or Python users who are used to things like <code class="language-plaintext highlighter-rouge">spread()</code> or <code class="language-plaintext highlighter-rouge">pivot_wider()</code>) way that SQL pivots a table wide, with that use of the <code class="language-plaintext highlighter-rouge">SUM(CASE WHEN ...)</code> pattern. It looks horrible, but it works (so long as you know in advance all the column names you are trying to make in the wider version):</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#============Create a denormalised (wide) version of the main fact table=======</span><span class="w">
</span><span class="c1"># In another database system this would be a materialized view or indexed view or similar,</span><span class="w">
</span><span class="c1"># but we don't have that in SQLite so it is a straight out table. Note that this roughly</span><span class="w">
</span><span class="c1"># doubles the size of the database on disk; and duplication means we need to remember</span><span class="w">
</span><span class="c1"># to re-create this table whenevedr the original fact table updates.</span><span class="w">

</span><span class="n">sql1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"DROP TABLE IF EXISTS f_prices_and_volumes_w"</span><span class="w">

</span><span class="n">sql2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"
CREATE TABLE f_prices_and_volumes_w AS
SELECT 
	observation_date,
	c.ticker_yahoo,
	c.ticker_origin,
	c.latest_full_description,
	SUM(CASE WHEN variable = 'open' THEN value END) AS open,
	SUM(CASE WHEN variable = 'high' THEN value END) AS high,
	SUM(CASE WHEN variable = 'low' THEN value END) AS low,
	SUM(CASE WHEN variable = 'close' THEN value END) AS close,
	SUM(CASE WHEN variable = 'volume' THEN value END) AS volume,
	SUM(CASE WHEN variable = 'adjusted' THEN value END) AS adjusted,
	SUM(CASE WHEN variable = 'short_positions' THEN value END) AS short_positions,
	SUM(CASE WHEN variable = 'total_product_in_issue' THEN value END) AS total_product_in_issue,
	SUM(CASE WHEN variable = 'short_positions_prop' THEN value END) AS short_positions_prop
FROM f_prices_and_volumes AS a
INNER JOIN d_variables AS b
	ON a.variable_id = b.variable_id
INNER JOIN d_products AS c
	ON a.product_id = c.product_id
GROUP BY observation_date, ticker_yahoo, ticker_origin, latest_full_description"</span><span class="w">

</span><span class="n">dbSendStatement</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql1</span><span class="p">)</span><span class="w">
</span><span class="n">dbSendStatement</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql2</span><span class="p">)</span><span class="w"> </span><span class="c1"># takes a minute or so</span></code></pre></figure>

<h2 id="exploratory-analysis">Exploratory analysis</h2>

<p>Phew, now for the fun bit. But I’m going to leave substantive analysis of this for another post, as this is already long enough! I’ll just do two things here.</p>

<p>First, let’s look at a summary of how many data points we’ve got in the database</p>

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> variable </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> number_products </th>
   <th style="text-align:right;"> number_dates </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> open </td>
   <td style="text-align:right;"> 880775 </td>
   <td style="text-align:right;"> 1873 </td>
   <td style="text-align:right;"> 8491 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:right;"> 880775 </td>
   <td style="text-align:right;"> 1873 </td>
   <td style="text-align:right;"> 8491 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:right;"> 880775 </td>
   <td style="text-align:right;"> 1873 </td>
   <td style="text-align:right;"> 8491 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> close </td>
   <td style="text-align:right;"> 880775 </td>
   <td style="text-align:right;"> 1873 </td>
   <td style="text-align:right;"> 8491 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> volume </td>
   <td style="text-align:right;"> 880775 </td>
   <td style="text-align:right;"> 1873 </td>
   <td style="text-align:right;"> 8491 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> adjusted </td>
   <td style="text-align:right;"> 880775 </td>
   <td style="text-align:right;"> 1873 </td>
   <td style="text-align:right;"> 8491 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> short_positions </td>
   <td style="text-align:right;"> 1318329 </td>
   <td style="text-align:right;"> 3048 </td>
   <td style="text-align:right;"> 2694 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> total_product_in_issue </td>
   <td style="text-align:right;"> 1318326 </td>
   <td style="text-align:right;"> 3047 </td>
   <td style="text-align:right;"> 2694 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> short_positions_prop </td>
   <td style="text-align:right;"> 1318204 </td>
   <td style="text-align:right;"> 3046 </td>
   <td style="text-align:right;"> 2694 </td>
  </tr>
</tbody>
</table>

<p>That all looks as expected. In total we have about 9 million observations. There are many securities with short positions reported to ASIC that I couldn’t find prices and volumes for in Yahoo Finance, which is interesting and worth looking into, but not astonishing.</p>

<p>That table was created with this SQL (and a bit of R sugar around using <code class="language-plaintext highlighter-rouge">knitr</code> and <code class="language-plaintext highlighter-rouge">kableExtra</code>, not shown):</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> 
	<span class="k">variable</span><span class="p">,</span>
	<span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">n</span><span class="p">,</span>
	<span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">product_id</span><span class="p">))</span> <span class="k">AS</span> <span class="n">number_products</span><span class="p">,</span>
	<span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">observation_date</span><span class="p">))</span> <span class="k">AS</span> <span class="n">number_dates</span>
<span class="k">FROM</span> <span class="n">f_prices_and_volumes</span> <span class="k">AS</span> <span class="n">a</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">d_variables</span> <span class="k">AS</span> <span class="n">b</span>
	<span class="k">ON</span> <span class="n">a</span><span class="p">.</span><span class="n">variable_id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">variable_id</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">variable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">b</span><span class="p">.</span><span class="n">variable_id</span></code></pre></figure>

<p>Finally, some real analysis. What can we do with this database? Here’s an example of the sort of thing that’s possible with this asset that wasn’t earlier. This is an answer to my hypothetical question I started with - what are the most traded and fastest growing (in price) securities on the ASX?</p>

<object type="image/svg+xml" data="/img/0199-vol-and-growth.svg" width="100%"><img src="/img/0199-vol-and-growth.png" width="100%" /></object>

<p>That chart was created with this code, which has three substantive bits:</p>

<ul>
  <li>an SQL query (and R code to send it to the databse) that grabs the data we need, averaged by year for each product, from the wide table defined above</li>
  <li>a little function purely to change the upper/lower case status of product names for the chart</li>
  <li><code class="language-plaintext highlighter-rouge">ggplot2</code> code to draw the chart.</li>
</ul>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#---------Recent growth-----------</span><span class="w">

</span><span class="n">sql</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"
WITH annual_vals AS
	(SELECT
	    CAST(STRFTIME('%Y', observation_date) AS INT) AS year,
		AVG(adjusted) AS avg_adjusted,
		sum(volume * adjusted) AS vol_val,
		latest_full_description,
		ticker_origin
	FROM f_prices_and_volumes_w
	GROUP BY latest_full_description, ticker_yahoo, STRFTIME('%Y', observation_date))
SELECT 
	SUM(CASE WHEN year = 2020 THEN avg_adjusted END) AS adj_2020,
	SUM(CASE WHEN year = 2021 THEN avg_adjusted END) AS adj_2021,
	SUM(CASE WHEN year = 2021 THEN vol_val END) AS vol_val_2021,
	ticker_origin,
	latest_full_description
FROM annual_vals
WHERE year &gt;= 2020
GROUP BY ticker_origin, latest_full_description
HAVING SUM(CASE WHEN year = 2020 THEN avg_adjusted END) &gt; 0"</span><span class="w">

</span><span class="n">recent_growth</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">as_tibble</span><span class="p">()</span><span class="w">

</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recent_growth</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">gr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adj_2021</span><span class="w"> </span><span class="o">/</span><span class="w">  </span><span class="n">adj_2020</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">vol_val_2021</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1e6</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">arrange</span><span class="p">(</span><span class="n">adj_2021</span><span class="p">)</span><span class="w"> 

</span><span class="cd">#' Convert upper case security names to title case</span><span class="w">
</span><span class="cd">#' </span><span class="w">
</span><span class="cd">#' @param x a character vector</span><span class="w">
</span><span class="cd">#' @param rm_ltd whether or not to strip "Limited" and "Ltd" from titles as unwanted clutter</span><span class="w">
</span><span class="cd">#' @details A convenience function for labelling securities on a chart, which</span><span class="w">
</span><span class="cd">#'   converts to title case, keeps ETF (Exchange Trade Fund) in capitals, and</span><span class="w">
</span><span class="cd">#'   can remove 'Limited' altogether</span><span class="w">
</span><span class="n">better_case</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">rm_ltd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">){</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">toTitleCase</span><span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Etf "</span><span class="p">,</span><span class="w"> </span><span class="s2">"ETF "</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">rm_ltd</span><span class="p">){</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Limited"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Ltd"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">str_trim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span><span class="w">
</span><span class="n">d</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vol_val_2021</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">1e6</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gr</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ticker_origin</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_text_repel</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">gr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">vol_val_2021</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">100e6</span><span class="p">),</span><span class="w">
                  </span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">better_case</span><span class="p">(</span><span class="n">latest_full_description</span><span class="p">)),</span><span class="w">
                  </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2.6</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_log10</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dollar_format</span><span class="p">(</span><span class="n">suffix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"m"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Value of transactions in 2021, to 14 February"</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Growth in price\nfrom average in 2020 to average in 2021"</span><span class="p">,</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"High volume and growth securities in the ASX, 2021"</span><span class="p">,</span><span class="w">
       </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Labelled securities are those with volume of trades &gt; $100m or growth &gt;200%"</span><span class="p">,</span><span class="w">
       </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: Yahoo Finance via https:/freerangestats.info. This is not financial advice."</span><span class="p">)</span></code></pre></figure>

<p>La voila. Coming soon in a future blog post - exploring short positions of securities on the ASX.</p>


		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2021/02/05/stock-visualizations">Visualising stock prices and volume</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2021/06/14/pc-penguins">Principal components and penguins</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<p>Find me on <a rel="me" href="https://mastodon.social/@peter_ellis">Mastodon</a>.</p>
			<hr></hr>
			
			<p>My day job is Director of the <a href='https://sdd.spc.int/'>Statistics for Development Division</a> at the Pacific Community, the principal scientific and technical organisation in the Pacific region, proudly supporting development since 1947. We are an international development organisation owned and governed by our 27 country and territory members. This blog is not part of my role there and contains my personal views only.</p>
		
		    <hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="https://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="https://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics https://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>