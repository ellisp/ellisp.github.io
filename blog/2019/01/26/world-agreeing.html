      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>What the world agrees with</title>
      	
         
         
            <meta name ="description" content ="I load wave 6 of the World Values Survey into a database so it's possible to analyse more questions and countries at once, and find some interesting variations in what people agree with in different parts of the world.">
            <meta property="og:description" content ="I load wave 6 of the World Values Survey into a database so it's possible to analyse more questions and countries at once, and find some interesting variations in what people agree with in different parts of the world.">
         
         <meta property="og:site_name" content="free range statistics" />
         <meta property="og:title" content="What the world agrees with" />
         
            <meta property="og:image" content="http://freerangestats.info/img/0143-heatmap.png" />
         
		 
			<meta property="og:url" content="http://freerangestats.info/blog/2019/01/26/world-agreeing.html" />
		 
         <meta property="og:author" content= "https://www.facebook.com/peterstats" />
         <meta property="og:type" content="article" />
      

<link href='https://fonts.googleapis.com/css?family=Sarala' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Prosto+One' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet'>
	  
          <link href="/css/bootstrap.min.css" rel ="stylesheet" type="text/css">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet" type="text/css">
            <link href="/css/custom.css" rel ="stylesheet" type="text/css">     
		<link href="/css/syntax.css" rel ="stylesheet" type="text/css">     			
                 
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>
   
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="free range statistics by Peter Ellis"
      href="/feed.xml">

	  

      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
  <script>
  (function() {
    var cx = '015640467633673901770:pk3v2c95baw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">free range statistics</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/about">about</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">all posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">ordered by date</a></li>
				  <li><a href="/blog/most-popular.html">ordered by popularity</a></li>
                  <li><a href="/blog/index_by_tag.html">grouped by subject matter</a></li>
                  <li><a href="/blog/nz.html">all posts with data about new zealand</a></li>
				  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
				  <li><a href = /blog/2020/05/09/covid-population-incidence>most recent post</a></li>
				</ul>
            </li>
              <li><a href="/blog/showcase.html">showcase</a></li>
              <li><a href="/presentations/index.html">presentations</a></li>
			  <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">election forecasts<span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href = "/elections/oz/index.html">Australia federal 2019</a></li>
				  <li><a href = "/elections/combined.html">NZ 2016</a></li>
                  <li><a href="/blog/voting.html">all posts on voting behaviour</a></li>
                </ul>				
			  </li>
			  
			  
			  
		    </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			<div class="jumbotron">
  <div class="container">
	<center><h1>What the world agrees with</h1></center>
  </div>
</div>



	<div class = "post-summary">
	<h2>At a glance:</h2>
	   <p>I load wave 6 of the World Values Survey into a database so it's possible to analyse more questions and countries at once, and find some interesting variations in what people agree with in different parts of the world.</p>
	   <p class="meta">26 Jan 2019</p>
	   <hr></hr>
	</div>


<div class="col-md-7">

	<div class="post">
		
	  <h2 id="a-serious-decades-long-attempt-to-understand-different-peoples-values">A serious, decades-long attempt to understand different peoples’ values</h2>

<p>David Hood (@Thoughfulnz) has been posting some interesting snippets of analysis using the World Values Survey data (like <a href="https://twitter.com/Thoughtfulnz/status/1088339318752464897">this example</a>). This inspired me to have a look at the data myself; something that’s been on my to-do list for years. I have analysed it before, but a long while ago and for only a single specific purpose, and I wanted to get a more general overview of it.</p>

<p>The <a href="http://www.worldvaluessurvey.org/WVSContents.jsp">World Values Survey</a> is an amazing multi-decade (started in 1981) network of scientists doing their best to create standard, internationally comparable, nationally representative data on values and their impact on social and political life.</p>

<p>It’s an impressive resource, with six waves of data already published and a seventh in preparation. I’ve only had a few hours today to look at it and that’s enough to make me want to come back. But let’s start with my finishing point for today - a big graphic of around 40 of the questions from the various surveys, showing how much people in different countries agree with various statements:</p>

<p><a href="/img/0143-heatmap.svg" target="_blank"><img src="/img/0143-heatmap.svg" width="100%" /></a></p>

<p>It really needs a big screen of course. Click on the image to open it in its own tab of the browser.</p>

<p>I find this fascinating and hope you do to. It’s a graphic that repays close attention, and the more I look at it the more interesting snippets I find. The ordering of the graphic with the most “agreed-with” statements at the top and the most “agreeing” countries on the right is crucial. It means that you can look up or across the graphic and look the squares of unusual colour that indicate exceptions. Here’s just some of the things that I noticed:</p>

<ul>
  <li>The United States stands out for its residents agreement with “Under some conditions, war is necessary to obtain justice”</li>
  <li>The people of Hong Kong don’t agree that they are autonomous individuals</li>
  <li>The people of Sweden are inclined to agree that all religions should be taught in public schools; and to disagree that “when jobs are scarce, employers should give priority to people of this country:</li>
  <li>Residents of former Soviet Union countries (Belarus, Russia, Kazakhstan, Ukraine) stand out for not agreeing with “I see myself as part of my local community”</li>
</ul>

<h2 id="data-wrangling">Data wrangling</h2>

<p>I have in mind the plan to eventually grab all six waves of the World Values Survey, as the real benefit of this sort of data comes not just from cross-country comparisons but comparisons over time. I also wanted a way of wrangling the data that would lend itself to efficient analysis of multiple questions at once. Both of these needs pushed me away from the common way of treating survey with one row per respondent, one column per question to a more efficient data model as used in data warehousing.</p>

<p>At first I did this all in R, but then I found that when I got to the analysis stage and wanted to join my 38 million row fact table to the 90,000 row dimension table I ran out of memory. I needed a database so that hard disk could be used when the going gets tough, and to draw on all the optimisation built into that software for exactly this job. So I ended up with this toolchain (which is a very common one for me):</p>

<ul>
  <li>data import, cleaning and some normalising in R</li>
  <li>upload into a database with the right disciplines and constraints, and (sometimes, not today) finishing off the cleaning and normalising</li>
  <li>for analysis, do the heavy lifting in SQL queries but bring filtered or aggregated data into R for any statistical modelling or for presentation.</li>
</ul>

<p>Here’s the R code for the first step. It draws first on code by David Hood for extracting the infromation on questions and answers that was encoded in the original file as attributes; then moves on to split the data into four tables representing respondents, questions, possible responses and (finally) the 38 million combinations of respondent - question - response combinations in a single long, thin table.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">frs</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">odbc</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span><span class="w">

</span><span class="c1"># correct citation must be used WV6_Data_R_v20180912; . 
</span><span class="w">

</span><span class="c1"># Obtain data from here:
# http://www.worldvaluessurvey.org/WVSDocumentationWV6.jsp
# including filling in a form re appropriate use etc.
</span><span class="w">
</span><span class="c1"># load in data:
</span><span class="n">wvs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readRDS</span><span class="p">(</span><span class="s2">"../data/F00007762-WV6_Data_R_v20180912.Rds"</span><span class="p">)</span><span class="w">

</span><span class="c1">#--------------extract labels and questions-----------
# label code from David Hood @Thoughtfulnz https://gist.github.com/thoughtfulbloke/8d6e016a74039c030ba3871dca36c19c
</span><span class="w">
</span><span class="n">unlabel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="w">
  </span><span class="n">codes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">attr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s2">"labels"</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">codes</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"No labels with"</span><span class="p">,</span><span class="nf">attr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s2">"label"</span><span class="p">)))</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
  
  </span><span class="n">replacement</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">codes</span><span class="p">),</span><span class="w">
    </span><span class="n">newform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">codes</span><span class="p">),</span><span class="w">
    </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
  </span><span class="p">)</span><span class="w">
  </span><span class="n">df2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"y"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">newform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">newform</span><span class="p">),</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">newform</span><span class="p">))</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">df2</span><span class="o">$</span><span class="n">newform</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
     </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">df2</span><span class="o">$</span><span class="n">newform</span><span class="p">))){</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">df2</span><span class="o">$</span><span class="n">newform</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Problem with"</span><span class="p">,</span><span class="nf">attr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s2">"label"</span><span class="p">)))</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">wv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wvs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">mutate_all</span><span class="p">(</span><span class="n">unlabel</span><span class="p">)</span><span class="w"> 

</span><span class="n">labs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">wvs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">map_chr</span><span class="p">(</span><span class="o">~</span><span class="nf">attributes</span><span class="p">(</span><span class="n">.</span><span class="p">)</span><span class="o">$</span><span class="n">label</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">make.names</span><span class="p">(</span><span class="n">unique</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="nf">names</span><span class="p">(</span><span class="n">wv</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">labs</span><span class="w">
</span><span class="c1"># End of David Hood's tidying code
</span><span class="w">
</span><span class="c1">#=============turn into a star schema===================
# we need to make our own ID because nothing in the data seems to be a unique identifier
</span><span class="n">wv</span><span class="o">$</span><span class="n">respondent_id</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">wv</span><span class="p">)</span><span class="w">

</span><span class="c1"># Define the variables that will eventually be in the respondent dimension table.
# This is things about the respondent and the interview and wave, rather than questions
# they've answered.
</span><span class="n">respondent_vars</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Wave"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Country.Code"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Country.regions..with.split.ups."</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"Interview.number"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Study"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Unified.respondent.number"</span><span class="p">,</span><span class="w"> 
                 </span><span class="s2">"X1000.equilibrated.weight"</span><span class="p">,</span><span class="w"> </span><span class="s2">"X1500.equilibrated.weight"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"Country...wave...study...set...year"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Nation.Wave"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Nation.Year"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"COW.Country.Code"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Weight.for.overal.secular.values"</span><span class="p">,</span><span class="w"> 
                 </span><span class="s2">"Weight.for.Emancipative.values"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Weight"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Weight.with.split.ups"</span><span class="p">,</span><span class="w">
                 </span><span class="s2">"Questionnaire.version"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date.of.interview"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Survey.year"</span><span class="p">,</span><span class="w"> </span><span class="s2">"respondent_id"</span><span class="p">)</span><span class="w">


</span><span class="c1">#--------long thin version that will be the basis of the main fact table----------
# we want all the original columns (ie questions), *except* those
# that are going to end up in the respondent dimension table. But
# we need respondent_id as that is going to link the two.
</span><span class="n">wvt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wv</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">wv</span><span class="p">)[</span><span class="o">!</span><span class="nf">names</span><span class="p">(</span><span class="n">wv</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">respondent_vars</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">"respondent_id"</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">gather</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">respondent_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">question</span><span class="p">),</span><span class="w">
         </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="w">
         </span><span class="n">question_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">question</span><span class="p">),</span><span class="w">
         </span><span class="n">response_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># one mystery NA to Highest.educational.level.attained
</span><span class="w">  </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="w">
</span><span class="c1"># note that this version is 38 million rows long
</span><span class="w">
</span><span class="c1"># extract the questions and do a bit of cleaning:
</span><span class="n">d_questions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wvt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">distinct</span><span class="p">(</span><span class="n">question_id</span><span class="p">,</span><span class="w"> </span><span class="n">question</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">".."</span><span class="p">,</span><span class="w"> </span><span class="s2">": "</span><span class="p">,</span><span class="w"> </span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w"> </span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_squish</span><span class="p">(</span><span class="n">question</span><span class="p">),</span><span class="w">
         </span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"country s "</span><span class="p">,</span><span class="w"> </span><span class="s2">"country's "</span><span class="p">,</span><span class="w"> </span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Mother s "</span><span class="p">,</span><span class="w"> </span><span class="s2">"Mother's "</span><span class="p">,</span><span class="w"> </span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Father s "</span><span class="p">,</span><span class="w"> </span><span class="s2">"Father's "</span><span class="p">,</span><span class="w"> </span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">separate</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"super_broad"</span><span class="p">,</span><span class="w"> </span><span class="s2">"very_broad"</span><span class="p">,</span><span class="w"> </span><span class="s2">"broad_question"</span><span class="p">,</span><span class="w"> </span><span class="s2">"mid_question"</span><span class="p">,</span><span class="w"> </span><span class="s2">"narrow_question"</span><span class="p">),</span><span class="w"> 
           </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"left"</span><span class="p">,</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">":"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">narrow_question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_squish</span><span class="p">(</span><span class="n">narrow_question</span><span class="p">),</span><span class="w">
         </span><span class="n">mid_question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_squish</span><span class="p">(</span><span class="n">mid_question</span><span class="p">),</span><span class="w">
         </span><span class="n">broad_question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_squish</span><span class="p">(</span><span class="n">broad_question</span><span class="p">))</span><span class="w">

</span><span class="c1"># extract the responses and do some cleaning and add some 
# classifications that might be useful:		 
</span><span class="n">d_responses</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wvt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">distinct</span><span class="p">(</span><span class="n">response_id</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># cleaning
</span><span class="w">  </span><span class="n">mutate</span><span class="p">(</span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_squish</span><span class="p">(</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"Dont "</span><span class="p">,</span><span class="w"> </span><span class="s2">"Don't "</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># creating alternative versions of some of the responses:
</span><span class="w">  </span><span class="n">mutate</span><span class="p">(</span><span class="n">response_no_commas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">response_no_spaces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">response_no_commas</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w">
         </span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tolower</span><span class="p">(</span><span class="n">response</span><span class="p">),</span><span class="w">
         </span><span class="n">response_numeric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_no_spaces</span><span class="p">)),</span><span class="w">
         </span><span class="n">response_any_numerals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">response_numeric</span><span class="p">),</span><span class="w">
                                        </span><span class="n">str_extract</span><span class="p">(</span><span class="n">response_no_spaces</span><span class="p">,</span><span class="w"> </span><span class="s2">"[0-9]+"</span><span class="p">),</span><span class="w">
                                        </span><span class="n">response_numeric</span><span class="p">),</span><span class="w">
         </span><span class="n">response_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">response_numeric</span><span class="p">),</span><span class="w"> </span><span class="s2">"character"</span><span class="p">,</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">),</span><span class="w">
         
         </span><span class="n">agrees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w"> 
                               </span><span class="nf">c</span><span class="p">(</span><span class="s2">"strongly agree"</span><span class="p">,</span><span class="w"> </span><span class="s2">"agree"</span><span class="p">,</span><span class="w"> </span><span class="s2">"completely agree"</span><span class="p">,</span><span class="w"> </span><span class="s2">"agree strongly"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">important</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w"> 
                                  </span><span class="nf">c</span><span class="p">(</span><span class="s2">"very important"</span><span class="p">,</span><span class="w"> </span><span class="s2">"important"</span><span class="p">,</span><span class="w"> </span><span class="s2">"absolutely important"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rather important"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">trust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w"> 
                              </span><span class="nf">c</span><span class="p">(</span><span class="s2">"trust somewhat"</span><span class="p">,</span><span class="w"> </span><span class="s2">"trust completely"</span><span class="p">,</span><span class="w"> </span><span class="s2">"most people can be trusted"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">often</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                              </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fairly often"</span><span class="p">,</span><span class="w"> </span><span class="s2">"very often"</span><span class="p">,</span><span class="w"> </span><span class="s2">"often"</span><span class="p">,</span><span class="w"> </span><span class="s2">"quite frequently"</span><span class="p">,</span><span class="w"> </span><span class="s2">"very frequently"</span><span class="p">,</span><span class="w"> </span><span class="s2">"frequently"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">like_me</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                                </span><span class="nf">c</span><span class="p">(</span><span class="s2">"very much like me"</span><span class="p">,</span><span class="w"> </span><span class="s2">"like me"</span><span class="p">,</span><span class="w"> </span><span class="s2">"somewhat like me"</span><span class="p">,</span><span class="w"> </span><span class="s2">"a little like"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">interested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                                   </span><span class="nf">c</span><span class="p">(</span><span class="s2">"somewhat interested"</span><span class="p">,</span><span class="w"> </span><span class="s2">"very interested"</span><span class="p">,</span><span class="w"> </span><span class="s2">"respondent was somewhat interested"</span><span class="p">,</span><span class="w">
                                     </span><span class="s2">"respondent was very interested"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">satisfied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                                  </span><span class="nf">c</span><span class="p">(</span><span class="s2">"completely satisfied"</span><span class="p">,</span><span class="w"> </span><span class="s2">"fairly satisfied"</span><span class="p">,</span><span class="w"> </span><span class="s2">"very satisfied"</span><span class="p">,</span><span class="w"> </span><span class="s2">"strongly satisfied"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">happy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                              </span><span class="nf">c</span><span class="p">(</span><span class="s2">"rather happy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"very happy"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">respect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                                </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fairly much respect"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">justifiable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w">
                                    </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Always justifiable"</span><span class="p">)),</span><span class="w">
         
         </span><span class="n">invalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">response_lower_case</span><span class="w"> </span><span class="o">%in%</span><span class="w"> 
                                </span><span class="nf">c</span><span class="p">(</span><span class="s2">"no answer"</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> 
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"not asked"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"don't know"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"unsure"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"unknown"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"inapplicable"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"dropped out survey"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"inappropriate response"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"missing"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
                                </span><span class="n">grepl</span><span class="p">(</span><span class="s2">"not applicable"</span><span class="p">,</span><span class="w"> </span><span class="n">response_lower_case</span><span class="p">))</span><span class="w">
         
         
         
         </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  
  </span><span class="n">select</span><span class="p">(</span><span class="n">response_id</span><span class="p">,</span><span class="w"> </span><span class="n">everything</span><span class="p">())</span><span class="w">


</span><span class="c1"># extract all the individual responses  
</span><span class="n">d_respondents</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wv</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">respondent_vars</span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rename_all</span><span class="p">(</span><span class="n">tolower</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rename_all</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"\\.+"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)})</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">respondent_id</span><span class="p">,</span><span class="w"> </span><span class="n">everything</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">weight</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"No weighting"</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">weight</span><span class="p">)))</span><span class="w">

  
</span><span class="c1"># final version of the factless fact table, with no information other than the combinations
# of respondent, question and response:
</span><span class="n">f_wvs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wvt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">respondent_id</span><span class="p">,</span><span class="w"> </span><span class="n">question_id</span><span class="p">,</span><span class="w"> </span><span class="n">response_id</span><span class="p">)</span></code></pre></figure>

<p>One of the key things I’ve done here is coded some of the responses with new classification columns such as <code class="highlighter-rouge">agree</code> - which is 1 for every response that is some kind of partly or fully agree, and 0 otherwise. This will let us analyse the multiple questions that use variants of this response set efficiently down the track.  The <code class="highlighter-rouge">invalid</code> column for every variant on “not asked”, “dropped out”, “don’t know”, is also important.</p>

<h2 id="creating-a-database">Creating a database</h2>

<h3 id="defining-a-data-model">Defining a data model</h3>

<p>The data model I’ve split the data out into is basically this:</p>

<p><img src="/img/0143-schema.png" width="100%" /></p>

<p>This is the classic data warehousing approach to this sort of data. A long, thin fact table; and shorter, wider dimension tables that hold all the text information and slowly changing information about the entities such as people, questions, etc.  For those interested in these things, <code class="highlighter-rouge">f_wvs</code> is a good example of a “factless fact table” - meaning that other than indicating unique combinations of the three dimensions (<em>this respondent</em> gave <em>this response</em> to <em>this question</em>) it has no additional numeric information or “facts”.</p>

<p>There are many many advantages of this data model; as well as being convenient for analysis down the track, one of the advantages is that we can do cleaning and enhancements of the dimension data in a compact way. In this case, I can add classifications to the responses in the 28,000 row <code class="highlighter-rouge">d_responses</code> table much more efficiently (with each unique response represented only once) than if I’d tried to do it to the original data, where each response is repeated each time someone in the original survey ticked it. And those columns of 1s and 0s with names like <code class="highlighter-rouge">agree</code> and <code class="highlighter-rouge">invalid</code> are going to become crucial for efficient analysis down the track.</p>

<p>Here’s the SQL that I ran in SQL Server to set up that simple empty <code class="highlighter-rouge">wvs</code> schema ready to accept the data from R:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">USE</span> <span class="n">survey_microdata</span>

<span class="k">CREATE</span> <span class="k">SCHEMA</span> <span class="n">wvs</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">wvs</span><span class="p">.</span><span class="n">f_wvs</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_respondents</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_responses</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_questions</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_respondents</span><span class="p">(</span>
	<span class="n">respondent_id</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">wave</span>          <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">country_code</span>  <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">weight</span>        <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">survey_year</span>   <span class="n">SMALLINT</span>
<span class="p">)</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_questions</span><span class="p">(</span>
	<span class="n">question_id</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="n">question</span>    <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span>

<span class="c1">-- response (second column below) isn't unique because of upper / lower case issues for agree strongly</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_responses</span><span class="p">(</span>
	<span class="n">response_id</span>            <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>	
	<span class="n">response</span>               <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">response_no_commas</span>     <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">response_no_spaces</span>     <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">response_lower_case</span>    <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">response_numeric</span>       <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
	<span class="n">response_any_numerals</span>  <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">63</span><span class="p">),</span>
	<span class="n">response_class</span>         <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">63</span><span class="p">),</span>
	<span class="n">agrees</span>                 <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">important</span>              <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">trust</span>                  <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">often</span>                  <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">like_me</span>                <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">interested</span>             <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">satisfied</span>              <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">happy</span>                  <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">respect</span>                <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">justifiable</span>            <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">invalid</span>                <span class="n">NUMERIC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
	<span class="p">)</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">wvs</span><span class="p">.</span><span class="n">f_wvs</span> <span class="p">(</span>
	<span class="n">respondent_id</span> <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">question_id</span>	  <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="n">response_id</span>   <span class="n">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">respondent_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_respondents</span><span class="p">(</span><span class="n">respondent_id</span><span class="p">),</span>
	<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">question_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_questions</span><span class="p">(</span><span class="n">question_id</span><span class="p">),</span>
	<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">response_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">wvs</span><span class="p">.</span><span class="n">d_responses</span><span class="p">(</span><span class="n">response_id</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">wvs</span><span class="p">.</span><span class="n">f_wvs</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">respondent_id</span><span class="p">,</span> <span class="n">question_id</span><span class="p">);</span></code></pre></figure>

<h3 id="uploading-data-from-r">Uploading data from R</h3>

<p>For larger datasets, my preferred approach to getting the data from R into a SQL Server database is:</p>

<ul>
  <li>define the database tables in SQL (as done above)</li>
  <li>from R, save the tables as pipe-delimited text files with no columns. The <code class="highlighter-rouge">fwrite</code> function in <code class="highlighter-rouge">data.table</code> package is super-fast at doing this - less than a second for the 38 million rows in <code class="highlighter-rouge">f_wvs</code> in this case.</li>
  <li>upload the data from the local disk to the database server via SQL Server’s <code class="highlighter-rouge">bcp</code> bulk import and export tool. This is a common enough task for me that I’ve made a convenience wrapper function <code class="highlighter-rouge">bcp()</code> in my <a href="https://github.com/ellisp/frs-r-package">frs R package</a> of miscellaneous bits and pieces.</li>
</ul>

<p>Here’s how that upload process looks in R:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">#-----------upload to database--------------
</span><span class="n">fwrite</span><span class="p">(</span><span class="n">d_respondents</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"respondent_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wave"</span><span class="p">,</span><span class="w"> </span><span class="s2">"country_code"</span><span class="p">,</span><span class="w"> </span><span class="s2">"weight"</span><span class="p">,</span><span class="w"> </span><span class="s2">"survey_year"</span><span class="p">)],</span><span class="w"> 
       </span><span class="s2">"d_respondents.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">col.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="n">bcp</span><span class="p">(</span><span class="s2">"localhost"</span><span class="p">,</span><span class="w"> </span><span class="s2">"survey_microdata"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wvs"</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"d_respondents"</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"d_respondents.txt"</span><span class="p">)</span><span class="w">


</span><span class="n">fwrite</span><span class="p">(</span><span class="n">d_questions</span><span class="p">[</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"question_id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"question"</span><span class="p">)],</span><span class="w"> 
       </span><span class="s2">"d_questions.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">col.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="n">bcp</span><span class="p">(</span><span class="s2">"localhost"</span><span class="p">,</span><span class="w"> </span><span class="s2">"survey_microdata"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wvs"</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"d_questions"</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"d_questions.txt"</span><span class="p">)</span><span class="w">

</span><span class="n">fwrite</span><span class="p">(</span><span class="n">d_responses</span><span class="p">,</span><span class="w"> </span><span class="s2">"d_responses.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">col.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="n">bcp</span><span class="p">(</span><span class="s2">"localhost"</span><span class="p">,</span><span class="w"> </span><span class="s2">"survey_microdata"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wvs"</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"d_responses"</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"d_responses.txt"</span><span class="p">)</span><span class="w">

</span><span class="c1"># this is astonishly fast - less than a second to write 38 million rows to disk
</span><span class="n">fwrite</span><span class="p">(</span><span class="n">f_wvs</span><span class="p">,</span><span class="w"> </span><span class="s2">"f_wvs.txt"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"|"</span><span class="p">,</span><span class="w"> </span><span class="n">col.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1"># this is more like a 15+ minutes. As well as writing to the database server disk,
# it's checking for uniqueness of primary keys and the foreign key constraints.
</span><span class="n">bcp</span><span class="p">(</span><span class="s2">"localhost"</span><span class="p">,</span><span class="w"> </span><span class="s2">"survey_microdata"</span><span class="p">,</span><span class="w"> </span><span class="s2">"wvs"</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"f_wvs"</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"f_wvs.txt"</span><span class="p">)</span></code></pre></figure>

<h2 id="analysis">Analysis</h2>

<p>After all this, the analysis is the easy and fun part. Because this post is already long enough I’m going to just show the creation of that graphic I started with. My workflow at this point is writing SQL queries in SQL Server Management Studio until I’m satisfied I’ve got the right filtering and aggregation; then I copy and paste that query into my R script so everything is in one place. If the SQL gets much more complicated than the below I’d want to save separate SQL scripts rather than copy them into R.</p>

<p>So here it is, code to pull down the appropriately weighted responses for all questions in all countries that have an “agree” part of the response. The code below is specific to my setup in that I have an ODBC data source name “sqlserver” which I use to connect to the localhost database; that was just set up in the Windows ODBC administrator by following the prompts. If you’ve got a remote server it gets a little more complicated.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">sql</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"
WITH agree_questions AS
  (SELECT	DISTINCT question, c.question_id
   FROM wvs.d_responses AS a
   INNER JOIN wvs.f_wvs AS b
     ON a.response_id = b.response_id
   INNER JOIN wvs.d_questions AS c
     ON b.question_id = c.question_id
   WHERE agrees = 1)
SELECT
  sum(g.weight * f.agrees) / sum(g.weight) AS weighted_agree,
  question,
  country_code
FROM wvs.f_wvs AS d
INNER JOIN agree_questions AS e
  ON d.question_id = e.question_id
INNER JOIN wvs.d_responses AS f
  ON d.response_id = f.response_id
INNER JOIN wvs.d_respondents AS g
  ON d.respondent_id = g.respondent_id
WHERE f.invalid != 1
GROUP BY question, country_code
ORDER by weighted_agree DESC"</span><span class="w">

</span><span class="n">con</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbConnect</span><span class="p">(</span><span class="n">odbc</span><span class="p">(),</span><span class="w"> </span><span class="s2">"sqlserver"</span><span class="p">,</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"survey_microdata"</span><span class="p">)</span><span class="w">

</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="w"> </span><span class="n">sql</span><span class="p">)</span><span class="w">

</span><span class="n">d</span><span class="m">2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">as_tibble</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">question</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_reorder</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="w"> </span><span class="n">weighted_agree</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fct_reorder</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span><span class="w"> </span><span class="n">weighted_agree</span><span class="p">))</span><span class="w"> 

</span><span class="n">yup</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="m">2</span><span class="o">$</span><span class="n">question</span><span class="p">))</span><span class="w">

</span><span class="n">d</span><span class="m">2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country_code</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">question</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme_tufte</span><span class="p">(</span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"main_font"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_tile</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weighted_agree</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_fill_viridis</span><span class="p">(</span><span class="s2">"Weighted percentage of valid answers that agreed or strongly agreed:"</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">45</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">),</span><span class="w">
        </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottom"</span><span class="p">,</span><span class="w">
        </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"The countries that 'agree' with more statements are on the right."</span><span class="p">,</span><span class="w">
       </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"The statements most agreed with (when asked) are at the top.\n"</span><span class="p">,</span><span class="w">
       </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Source: http://www.worldvaluessurvey.org/WVSDocumentationWV6.jsp, WV6_Data_R_v20180912. Analysis by http://freerangestats.info"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># draw the countries along the top as a sort of repeat of the x axis:
</span><span class="w">  </span><span class="n">geom_text</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distinct</span><span class="p">(</span><span class="n">d</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">country_code</span><span class="p">),</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country_code</span><span class="p">),</span><span class="w"> 
            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yup</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">45</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2.7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">expand_limits</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yup</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="m">2</span><span class="o">$</span><span class="n">country_code</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"What do people of the world agree with?"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"All questions in the World Values survey with an agree/disagree style of response."</span><span class="p">)</span></code></pre></figure>

<p>I’ve ignored statistical issues so far, in particular dealing with sampling uncertainty and the complex survey nature of the data. But I’m all set up to do this when I need to (and I need to understand better the sampling design to do it properly), down the track at some point I hope.</p>

<p>That’s all for now. But I’ll definitely be coming back to this data!</p>



		
	</div>
</div>

<div class="col-md-1"></div>
<div class="col-md-4">
	<div class="side-banner">
	


	<div>
	   
	    
			
			<p>&larr; Previous post</p>
			<p><a rel="prev" href="/blog/2018/12/23/persian-monarchs">Simulating Persian Monarchs gameplay</a></p>
		
		
		
		
		 
			
			<p>Next post &rarr;</p>
			<p><a rel="next" href="/blog/2019/02/20/voting-seasonality">Seasonality in NZ voting preference?</a></p>
			
			
		
		
	</div>
	
	 

   <div class = "side-footer">
			
			<hr></hr>
			<p><gcse:search></gcse:search></p>
			<hr></hr>
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.</p>
			<hr></hr>
			
       <div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="false" data-share="false"></div>
			
			<hr></hr>
			<p>I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>
			<hr></hr>

			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><i>free range statistics</i></span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			<hr></hr>
			


    </div>



  
   




		  
		  



	   
	<div id="disqus_thread"></div>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>

		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = 'statsinthewild';
			
			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var s = document.createElement('script'); s.async = true;
				s.type = 'text/javascript';
				s.src = '//' + disqus_shortname + '.disqus.com/count.js';
				(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
			}());
		</script>

	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>	
</div>    
   
   

			
			</div><!-- /.container -->
         
   <!-- Default Statcounter code for Free Range Statistics
http://Http://freerangestats.info -->
<script type="text/javascript">
var sc_project=11673245; 
var sc_invisible=1; 
var sc_security="5b7111a4"; 
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js" async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img class="statcounter"
src="//c.statcounter.com/11673245/0/5b7111a4/1/" alt="Web
Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->

</body>   
</html>