<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Peter&#39;s stats stuff - R</title>
		<description>Posts categorised as 'R'</description>
		<link>http://ellisp.github.io</link>
		<atom:link href="http://ellisp.github.io/feed.R.xml" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Importing the New Zealand Income Survey SURF</title>
					<description>&lt;h2&gt;The quest for income microdata&lt;/h2&gt;
&lt;p&gt;For a separate project, I&#39;ve been looking for source data on income and wealth inequality.  Not aggregate data like Gini coefficients or the percentage of income earned by the bottom 20% or top 1%, but the sources used to calculate those things.  Because it&#39;s sensitve personal financial data either from surveys or tax data, it&#39;s not easy to get hold of, particularly if you want to do it in the comfort of your own home and don&#39;t have time / motivation to fill in application forms.  So far, what I&#39;ve got is a &lt;a href = &quot;http://www.stats.govt.nz/tools_and_services/microdata-access/nzis-2011-cart-surf.aspx&quot;&gt;simulated unit record file (SURF) from the New Zealand Income Survey,&lt;/a&gt; published by Statistics New Zealand for educational and instructional purposes. It&#39;s a simplified, simulated version of the original survey and it lets me make graphics like this one:&lt;/p&gt;

&lt;div class =&quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0003-nzis-ethnicity-density.svg&quot;&gt;&lt;/div&gt;
 &lt;p&gt;
 This plot shows the density of income from all sources for four of the most prominent ethnicity types in New Zealand.  New Zealand official statistics allow people to identify with more than one ethnicity, which means there is some double counting (more on that below).  Three things leap out at me from this chart:
 &lt;ol&gt;
 &lt;li&gt;The density curves of the different ethnic groups are very similar visually
 &lt;li&gt;People of Maori and Pacific Peoples ethnicity have proportionately more $300-$400 per week earners than Europeans and Asians, leading to an overall noticeable lean to the lower numbers
 &lt;li&gt;Weekly income is bimodal, bunching up at $345 per week and $820 per week
 &lt;/ol&gt;
  &lt;/p&gt;
  &lt;p&gt;
  Statistics New Zealand warn that while this simulated data is an accurate representation of the actual New Zealand population, it shouldn&#39;t be used for precise statistics, so for now I won&#39;t draw particularly strong conclusions on anything.  A simulated unit record file is a great way of solving confidentiality purposes, but in the end it has been created by a statistical model.  There&#39;s a risk that interesting inferences might be just picking up something implicit in the model that wasn&#39;t taken into account when it was first put together.  That&#39;s not likely to be the case for the basic distribution of the income values, but we&#39;ll note the exploratory finding for now and move on.&lt;/p&gt;
  
  &lt;p&gt;A box plot is better for examining the full range of reported ethnicities but not so good for picking up the bi-modal subtlety.  It should also be noted that both these graphs delete people who made losses (negative income) in a given week - the data show income from all sources:
  &lt;/p&gt;

&lt;div class = &quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0003-nzis-ethnicity-boxplot.svg&quot;&gt;&lt;/div&gt;

&lt;h2&gt;Loading the NZIS SURF into a database&lt;/h2&gt;
Here&#39;s how I drew the graphs, and estimated the two modes.  I think I&#39;ll want to re-use this data quite often, so it&#39;s worth while putting in a database that&#39;s accessible from different projects without having to move a bunch of data files around in Windows Explorer.  The way Statistics New Zealand have released the file, with codings rather than values for dimensions like ethnicity and region, also makes a database a good way to make the data analysis ready.&lt;/p&gt;

&lt;p&gt;After importing the data, the first significant job is to deal with that pesky ethnicity variable.  In the released version of the data respondents with two ethnicities have both code numbers joined together eg 12 means both European (1) and Maori (2).  To get around this I split the data into two fact tables, one with a single row per respondent with most of the data; and a second just for ethnicity with either one or two rows for each respondent.  Here&#39;s how I do that with a combination of {dplyr} and {tidyr}:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mbie&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for AskCreds, which is alternatively directly available &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;c1&quot;&gt;# https://github.com/nz-mbie/mbie-r-package/blob/master/pkg/R/Creds.R &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imports, clean up, and save to database the data from&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# http://www.stats.govt.nz/tools_and_services/microdata-access/nzis-2011-cart-surf.aspx&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;url &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.stats.govt.nz/~/media/Statistics/services/microdata-access/nzis11-cart-surf/nzis11-cart-surf.csv&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;nzis &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------fact tables------------------&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Create a main table with a primary key&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;f_mainheader &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; nzis &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;survey_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# we need to normalise the multiple ethnicities, currently concatenated into a single variable&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;cat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;max number of ethnicities is&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;f_ethnicity &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; f_mainheader &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; survey_id&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;First &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;          Second &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity_type&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ethnicity_id&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;survey_id&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity_id &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# drop the original messy ethnicity variable and tidy up names on main header&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;f_mainheader &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; f_mainheader &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;region_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lgr&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;          sex_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sex&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;          agegrp_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; agegrp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;          qualification_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; qualification&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;          occupation_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; occupation&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Second step is to re-create the dimension tables that turn the codes (eg 1 and 2) into meaningful values (European and Maori).  Statistics New Zealand provide these, but unfortunately in an Excel workbook that&#39;s easier for humans than computers to link up to the data.  There&#39;s not too many of so it&#39;s easy enough to code them by hand, which the next set of code does:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------dimension tables------------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# all drawn from the data dictionary available at the first link given above&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;d_sex &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sex_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; sex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;male&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;female&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;d_agegrp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   agegrp_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;agegrp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;agegrp_id &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;65+&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;agegrp_id&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;-&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; agegrp_id &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;d_ethnicity &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;                          ethnicity &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;European&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Pacific Peoples&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Asian&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Middle Eastern/Latin American/African&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Other Ethnicity&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Residual Categories&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;d_occupation &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;occupation_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;                       occupation &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Managers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Professionals&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Technicians and Trades Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Community and Personal Service Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Clerical and Adminsitrative Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Sales Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Machinery Operators and Drivers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Labourers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Residual Categories&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;No occupation&amp;quot;&lt;/span&gt;                          
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;                       &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;d_qualification &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;qualification_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;                        qualification &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;None&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;School&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;Vocational/Trade&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;Bachelor or Higher&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;Other&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;                        &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;d_region &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;region_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;                       region &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Northland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Auckland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Waikato&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Bay of Plenty&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Gisborne / Hawke&amp;#39;s Bay&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;                                  &lt;span class=&quot;s&quot;&gt;&amp;quot;Taranaki&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Manawatu-Wanganui&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Wellington&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;                                  &lt;span class=&quot;s&quot;&gt;&amp;quot;Nelson/Tasman/Marlborough/West Coast&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Canterbury&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Otago&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Southland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The final step in the data cleaning is to save all of our tables to a database, create some indexes so they work nice and fast, and join them up in an analysis-ready view.  In the below I use an ODBC (open database connectivity) connection to a MySQL server called &quot;PlayPen&quot;.  R plays nicely with databases; set it up and forget about it.&lt;p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------save to database---------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;creds &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; AskCreds&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Credentials for someone who can create databases&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; odbcConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PlayPen_prod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; uid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; creds&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;uid&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; pwd &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; creds&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;pwd&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;create database nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;use nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# fact tables.  These take a long time to load up with sqlSave (which adds one row at a time)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# but it&amp;#39;s easier (quick and dirty) than creating a table and doing a bulk upload from a temp &lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# file.  Any bigger than this you&amp;#39;d want to bulk upload though - took 20 minutes or more.&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; f_mainheader&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; f_ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                                            &lt;span class=&quot;c1&quot;&gt;# add a primary key on the fly in this case.  All other tables&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                                            &lt;span class=&quot;c1&quot;&gt;# have their own already created by R.&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# dimension tables&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_sex&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_agegrp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_occupation&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_qualification&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_region&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------indexing----------------------&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE f_mainheader ADD PRIMARY KEY(survey_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_sex ADD PRIMARY KEY(sex_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_agegrp ADD PRIMARY KEY(agegrp_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_ethnicity ADD PRIMARY KEY(ethnicity_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_occupation ADD PRIMARY KEY(occupation_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_qualification ADD PRIMARY KEY(qualification_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_region ADD PRIMARY KEY(region_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------create an analysis-ready view-------------------&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# In Oracle we&amp;#39;d use a materialized view, which MySQL can&amp;#39;t do.  But&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the below is fast enough anyway:&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;sql1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;CREATE VIEW vw_mainheader AS SELECT sex, agegrp, occupation, qualification, region, income FROM&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      f_mainheader a   JOIN&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_sex b          on a.sex_id = b.sex_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_agegrp c       on a.agegrp_id = c.agegrp_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_occupation e   on a.occupation_id = e.occupation_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_qualification f on a.qualification_id = f.qualification_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_region g       on a.region_id = g.region_id&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; sql1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Average weekly income in NZ 2011 by various slices and dices&lt;/h2&gt;
&lt;p&gt;Whew, that&#39;s out of the way.  Next post that I use this data I can go straight to the database.  We&#39;re now in a position to check our data matches the summary totals provided by Statistics New Zealand.  Statistics New Zealand say this SURF can be treated as a simple random sample, which means each point can get an identical individual weight, which we can estimate from the summary tables in their data dictionary.  Each person in the sample represents 1,174 in the population (in the below I have population figures in thousands, to match the Statistics New Zealand summaries.&lt;p&gt;

&lt;p&gt;Statistics New Zealand doesn&#39;t provide region and occupation summary statistics, and the qualification summaries they provide use a more detailed classification than is in the actual SURF.  But for the other categories - sex, age group, and the trick ethnicity - my results match theirs, so I know I haven&#39;t munched the data.&lt;p&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; sex &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; female &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 611 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 15217 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1787.10 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; male &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 779 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 14254 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1674.00 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tab1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              sex,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY sex&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; agegrp &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 15-19 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 198 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2632 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 309.10 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 20-24 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 567 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2739 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 321.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 25-29 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 715 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2564 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 301.10 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 30-34 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 796 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2349 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 275.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 35-39 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 899 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2442 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 286.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 40-44 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 883 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2625 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 308.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 45-49 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 871 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2745 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 322.40 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 50-54 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 911 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2522 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 296.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 55-59 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 844 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2140 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 251.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 60-64 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 816 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1994 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 234.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 65+ &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 421 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 4719 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 554.20 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tab2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              agegrp,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY agegrp&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; qualification &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; School &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 564 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 7064 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 829.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; None &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 565 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 6891 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 809.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Other &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 725 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1858 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 218.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Vocational/Trade &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 734 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 8435 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 990.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Bachelor or Higher &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 955 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 5223 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 613.40 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# qualification summary in data dictionary uses a different classification to that in data&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;tab3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              qualification,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY qualification&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           ORDER BY Mean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; occupation &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; No occupation &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 257 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 10617 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1246.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Labourers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 705 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2154 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 253.00 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Residual Categories &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 726 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  24 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Community and Personal Service Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 745 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1734 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 203.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Sales Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 800 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1688 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 198.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Clerical and Adminsitrative Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 811 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2126 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 249.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Technicians and Trades Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 886 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2377 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 279.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Machinery Operators and Drivers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 917 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1049 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 123.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Professionals &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1105 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 4540 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 533.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Managers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1164 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3162 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 371.30 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# occupation summary not given in data dictionary&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;tab4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             occupation,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY occupation&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           ORDER BY Mean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; region &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Bay of Plenty &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 620 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1701 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 199.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Taranaki &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 634 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 728 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 85.50 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Waikato &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 648 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2619 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 307.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Southland &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 648 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 637 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 74.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Manawatu-Wanganui &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 656 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1564 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 183.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Northland &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 667 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1095 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 128.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Nelson/Tasman/Marlborough/West Coast &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 680 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1253 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 147.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Otago &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 686 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1556 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 182.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Gisborne / Hawke&#39;s Bay &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 693 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1418 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 166.50 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Canterbury &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 701 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 4373 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 513.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Auckland &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 720 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 9063 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1064.40 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Wellington &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 729 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3464 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 406.80 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# region summary not given in data dictionary&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;tab5 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             region,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY region&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           ORDER BY Mean &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; ethnicity &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Residual Categories &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 555 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  85 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 10.00 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Maori &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 590 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3652 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 428.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Pacific Peoples &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 606 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1566 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 183.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Middle Eastern/Latin American/African &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 658 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 343 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 40.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Asian &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 678 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3110 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 365.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; European &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 706 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 22011 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2585.00 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Other Ethnicity &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 756 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 611 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 71.80 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tab6 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     ethnicity,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     ROUND(AVG(income))          as Mean,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  FROM f_mainheader m&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  JOIN f_ethnicity e ON m.survey_id = e.survey_id&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  JOIN d_ethnicity d ON e.ethnicity_id = d.ethnicity_id&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  GROUP BY ethnicity&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  ORDER BY Mean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Graphics showing density of income&lt;/h2&gt;
&lt;p&gt;Finally, here&#39;s the code that drew the charts we started with, showing the distribution of the weekly income New Zealanders of different ethnicity.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download individual level data from database&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;dtf &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                   ethnicity,&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                   income&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                FROM f_mainheader m&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                JOIN f_ethnicity e ON m.survey_id = e.survey_id&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                JOIN d_ethnicity d ON e.ethnicity_id = d.ethnicity_id&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;dtf &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Asian&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;European&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Pacific Peoples&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ethnicity&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income from all sources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;345&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;825&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bottom&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   scale_colour_brewer&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; palette &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Set1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;dtf &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ethnicity&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   geom_boxplot&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   scale_y_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income from all sources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   coord_flip&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   scale_colour_brewer&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;palette &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Set2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# how did I choose to mark $345 and $825 on the scale?&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ripped off (and improved) from http://stackoverflow.com/questions/27418461/calculate-the-modes-in-a-multimodal-distribution-in-r&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;find_modes&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   dens &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   y &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; dens&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;y
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   modes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;         modes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;modes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;modes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;      modes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;This is a monotonic distribution&amp;#39;&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dens&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;modes&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;x &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; dtf&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# not interested in negative income just now&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# where are those modes?&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;find_modes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Sat, 15 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf</guid>
			</item>
		
			<item>
				<title>Simulating backgammon players&#39; Elo ratings</title>
					<description>&lt;h2 id=&quot;probabilities-of-winning-with-a-given-rating&quot;&gt;Probabilities of winning with a given rating&lt;/h2&gt;
&lt;p&gt;Backgammon clubs and on-line forums use a modified form of the &lt;a href=&quot;https://en.wikipedia.org/wiki/Elo_rating_system&quot;&gt;Elo rating system&lt;/a&gt; to keep track of how well individuals have played and draw inferences about their underlying strength.  The higher the rating, the stronger the player.  Players with higher ratings are inferred to be stronger than those with lower ratings and hence are expected to win; and the longer the match, the more likely the greater skill level will overcome the random chance of the dice.  The animated plot below shows the expected probabilities of two players in the &lt;a href=&quot;http://www.fibs.com/&quot;&gt;FIBS (First Internet Backgammon Server)&lt;/a&gt; internet forum, where players start at 1500 and the very best reach over 2000.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0002-EloProbs.gif&quot; alt=&quot;Animated heatmap of player probabilities of winning&quot; style=&quot;width: 500px;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When the two players have the same rating, they are expected to have a 50/50 chance of winning, and this causes the constant diagonal line in the animation above.  When one player is better than the other they have a higher chance of winning, represented for Player A by the increasingly blue space in the bottom right of the plot and the numbers (which are estimated probabilities) labelling the contour lines.  The actual formula used on FIBS and illustrated above is &lt;a href=&quot;http://www.fibs.com/ratings.html&quot;&gt;defined by on the FIBS site&lt;/a&gt; as:&lt;/p&gt;

&lt;p&gt;Winning prob. = 1 - (1 / (10 ^ ((YOU - HIM) * SQRT(ML) / 2000) + 1))&lt;/p&gt;

&lt;p&gt;(As an aside, I dont think there is a strong theoretical reason for the SQRT(ML) in that formula.  With the complications of the doubling cube I very much doubt that the relationship of the probability winning to match length is as simple as that.  But its a reasonable empirical approximation; I might blog more about that another time.)&lt;/p&gt;

&lt;p&gt;Now, heres how I made that animation.  In the R code below, first, I load up some functionality and the Google font I use for this blog.  Then I define a function that estimates the probability of a player winning using the FIBS formula above.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RColorBrewer&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directlabels&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for labels on contour lines&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;forecast&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for auto.arima later on&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================helper functions=====================&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;fibs_p &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# function to determine the expected probability of player a winning a bachgammon match&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# against player b of length ml, with a and b representing their FIBS Elo ratings&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The strategy to create the animation is simple:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Create all the combinations of two players Elo ratings.&lt;/li&gt;
  &lt;li&gt;Loop through 23 possible match lengths, calculating the probabilities of A winning for each combination of Elo ratings at that match length&lt;/li&gt;
  &lt;li&gt;Draw a still image heatmap for each of those 23 match lengths using {ggplot2}&lt;/li&gt;
  &lt;li&gt;Compile the images into a single animated Gif using &lt;a href=&quot;http://studio.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#================heat maps showing probability of winning&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a matrix of players A and B&amp;#39;s possible Elo ratings&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;mat &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;expand.grid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Var1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Var2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a folder to hold the images and navigate to it&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;dir.create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp0002&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;owd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;setwd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp0002&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# cycle through a range of possible match lengths, drawing a plot for each&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;matchlengths &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;res &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;150&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;matchlengths&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   df1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; mat &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;probs &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fibs_p&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; matchlengths&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;df1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; z &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; probs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;      geom_tile&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; probs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;      theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      scale_fill_gradientn&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colours &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; brewer.pal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Spectral&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; limits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      scale_colour_gradientn&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colours &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;      stat_contour&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;..&lt;/span&gt;level..&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; binwidth &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# force contours to be same distance each image&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Player A Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Player B Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;      theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;      coord_equal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Probability of Player A winning a match to &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; matchlengths&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;letters&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; res&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bg &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;direct.label&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# direct labels used to label the contour points&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# compile the images into a single animated Gif with ImageMagick.  Note that&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the {animation} package provides R wrappers to do this but they often get&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# confused (eg clashes with Windows&amp;#39; convert) and it&amp;#39;s easier to do it explicitly&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# yourself by sending an instruction to the system:&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&amp;quot; -loop 0 -delay 150 *.png &amp;quot;EloProbs.gif&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# move the asset over to where needed for the blog&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;file.copy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;EloProbs.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;../..http://ellisp.github.io/img/0002-EloProbs.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; overwrite &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# clean up&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;setwd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;owd&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;unlink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp0002&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; recursive &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;actual-ratings-varying-true-rating-constant&quot;&gt;Actual ratings varying, true rating constant&lt;/h2&gt;
&lt;p&gt;The estimated probability of winning against a certain opponent at a given match length might be of interest to backgammon players (Im surprised its not referred to more often), but its most common use is embedded in the calculation of how much each players Elo rating changes after a match is decided.  That formula is well explained by FIBS and a little involved so I wont spell it out here, but you can see it in action in the function I provide later in this post.  A key point for our purposes is that as the win/loss of a match is a random event, players Elo ratings which are based on those events are random variables.  Even if we grant the existence of a real value for each player, it is unobservable, and can only be estimated by their actual Elo rating in a tournament or internet forum.&lt;/p&gt;

&lt;p&gt;In fact, my original motivation for this blog post was to see how much Elo ratings fluctuate due to randomness of individual games.  In a later post Ill have a more complex and realistic simulation, but the chart below shows what happens to a players Elo ratings over time in the following situation:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Only two players&lt;/li&gt;
  &lt;li&gt;They only ever play 5 point matches, and they play 10,000 of them&lt;/li&gt;
  &lt;li&gt;Player As chance of winning the 5 point match is 0.6, and this does not change over time (ie no player is improving in skill relative to the other)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The results are shown in the chart below, and in this unrealistically simple scenario theres more variation than Id realised there would be.  Player As actual Elo rating fluctuates fairly wildly around the true value (which can be calculated as 1578.75), hitting 1650 several times and dropping nearly all the way to 1500 at one point.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0002-elo-rating.svg&quot; alt=&quot;Ratings of Player A in 2 player simulation&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Heres the code for that simulation, including my R function that provides FIBS-style Elo ratings, adjusted for experience as set out by FIBS.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#=================determine change of Elo rating ================&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;fibs_scores &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; winner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# a is Elo rating of player A before match&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# b is Elo rating of player B before match&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# ml is match length&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# axp is total match lengths (experience) of player a until this match&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# bxp is total match lengths (experience) of player b until this match&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# see http://www.fibs.com/ratings.html for formulae&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# calculate experience-correction multipliers:&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   multa &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axp &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;axp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   multb &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;bxp &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;axp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# probability of A winning, using fibs_p function defined earlier:&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   winproba &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; fibs_p&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# match value (points to be distributed between the two players):&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   matchvalue &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# who gets them?:&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;winner &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; a &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; winproba &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multa
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      b &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; winproba &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multb
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;      a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; a &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; winproba&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multa 
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;      b &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; winproba&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multb
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# test against &amp;quot;baptism by fire&amp;quot; example at http://www.fibs.com/ratings.html&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# should be 1540.95:&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fibs_scores&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1925&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; winner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#================simulations of how long it takes for scores to stablise================&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# two people playing eachother 5 point games with 0.6 chance of winning&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;A &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; B &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rating &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;timeseries &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;A &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; B &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for reproducibility&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   result &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; fibs_scores&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;               winner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;runif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;               axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   timeseries&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;a
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   timeseries&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;    B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;b
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;exp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;axp
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;exp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;bxp
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;A &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;A&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;B &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;B&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;time &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# theoretical value:&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;tv &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3000&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;svg&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0002-elo-rating.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Player A&amp;#39;s Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;   geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tv&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Elo rating of Player A in two player, constant skill simulation&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;\nNumber of matches played&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tv &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;time&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;            label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Theoretical\nvalue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;            family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In this situation, the resulting players Elo rating bouncing around at random is quite well modelled by an autoregressive AR(1) time series model with an intercept at the true level of the players skill.  With an autoregression parameter of around 0.98, the rating at any point in time is obviously very closely related to the previous rating; almost but not quite a random walk. Showing how and why would make this post too long, but its a useful factoid to note for future work when we come to more realistic and complex simulations of Elo ratings on FIBS.&lt;/p&gt;

</description>
				<pubDate>Fri, 07 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/07/fibs-elo-ratings-basics</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/07/fibs-elo-ratings-basics</guid>
			</item>
		
			<item>
				<title>New Zealand Data &amp; APIs on GitHub</title>
					<description>&lt;h2 id=&quot;new-data-listing-for-new-zealand&quot;&gt;New data listing for New Zealand&lt;/h2&gt;
&lt;p&gt;Wellingtons &lt;a href=&quot;https://github.com/PrototypeAlex&quot;&gt;PrototypeAlex&lt;/a&gt; has created a new &lt;a href=&quot;https://github.com/PrototypeAlex/new-zealand-data&quot;&gt;GitHub repository aiming to list data about New Zealand&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My first reaction was hmm, will this be an improvement?  After all, we already have &lt;a href=&quot;http://data.govt.nz&quot;&gt;data.govt.nz&lt;/a&gt; which is meant to be the definitive aggregator of government datasets; we have the &lt;a href=&quot;http://figure.nz&quot;&gt;Figure.NZ&lt;/a&gt; (recently rebranded from Wiki New Zealand, as it isnt really a Wiki and has evolved into something else, still very useful, entirely) which aims to be:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;the place to play with New Zealands data.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;And according to &lt;a href=&quot;https://twitter.com/PrototypeAlex/status/626689156744265728&quot;&gt;PrototypeAlex on Twitter:&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Theres a heap of NZ data/api metalists floating around, so I made another one.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I think (and am pretty sure so does PrototypeAlex) that the difference is being on GitHub.  This means that anyone with a GitHub account can fork his repository, make and commit additions or corrections, and submit a pull request to him.  Ive already done this twice for a bunch of small things I noticed, as have half a dozen others, and hes pretty prompt at accepting those changes.  In effect, Alex can start crowd sourcing his list.  Maybe he was inspired by Wiki New Zealand dropping the Wiki from their name, because thats what hes doing.  Its simple but effective.&lt;/p&gt;

&lt;p&gt;Its a good initiative and I hope it goes well, but theres a few things to work on.  The fact that its difficult is shown by the problems others have had.  For example both data.govt.nz and opengovt.org.nz try to be catalogues of New Zealand government (national and local) datasets.  Both now show up as links from PrototypeAlexs list (and I think probably rightly - if not, Id probably be obligated to submit a pull request to correct it, rather than blog about it myself).  Both have a number of out of date descriptions, broken links, and the like.&lt;/p&gt;

&lt;p&gt;Reflecting on all this, heres what I think would make the best list possible:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;The list itself should be machine-readable - in fact it should be a database itself, but a super simple one, say a &lt;a href=&quot;https://answers.yahoo.com/question/index?qid=20081022042708AADr82V&quot;&gt;pipe delimited text file&lt;/a&gt;.  I dont think any of the options out there do this yet.&lt;/li&gt;
  &lt;li&gt;It should have one dataset per entry.  opengovt.org.nz and data.govt.nz aspire to this but dont always achieve it (mostly when the hosts of the data, which I concede includes me in my day-job, have an ambiguous view of what is a dataset).&lt;/li&gt;
  &lt;li&gt;Each entry should have metadata - is its format CSV, API, Excel?  Ideas of what constitutes a dataset clearly vary.  Quite a few of the links Ive tried from the various aggregation sites this morning go to web pages that present datasets in human-oriented summary tables or interactive web-apps, but dont have an obvious way of downloading the whole thing for re-use.  In my view being able to download the whole thing (for reasonable definition of whole thing of course - more on that in another post) is the minimum requirement for a dataset to be said to be fully open and available.  Tables that have been summarised beyond the minimum needed for confidentiality dont allow this, and in fact many APIs (for other reasons) dont make it easy either.  Analysts are interested in the datasheet of an Excel pivot table, not so much the pivot table itself; so Excel data is ok (not preferred!), but not if the source is hidden or did not get exported from its database.&lt;/li&gt;
  &lt;li&gt;It should be correctable by the crowd.  The new GitHub version allows this but not others that Im aware of.  Facilitating this is another reason why a text file is the ideal way to store this particular datasets of datasets; technology like Git makes it easy to see who is adding what, and keep track of versions, when its all in text.&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;example-characteristics-of-recipients-of-main-benefits&quot;&gt;Example: characteristics of recipients of main benefits&lt;/h3&gt;
&lt;p&gt;So, inspired by looking at these lists, I had a go at finding some data I could use, to trial end to end identification, download, tidying and use.  I wanted something I knew nothing about, and that was definitely not connected to my work.  After dealing with a few broken links and data-that-wasnt-really-data I chose more or less at random the &lt;a href=&quot;https://www.msd.govt.nz/about-msd-and-our-work/publications-resources/statistics/benefit/index.html#Datatables6&quot;&gt;Ministry of Social Developments Five Year National level datatables&lt;/a&gt;.  Thanks to MSD for making this available!&lt;/p&gt;

&lt;p&gt;I decided to focus on just one of their tables, the Main benefits in the last 5 years.  The value variable is counts of total number of recipients of that categorisation of benefits in New Zealand.  The dimension variables are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;sex&lt;/li&gt;
  &lt;li&gt;age group&lt;/li&gt;
  &lt;li&gt;ethnicity&lt;/li&gt;
  &lt;li&gt;short term (&amp;lt;1 year) or longer term period on benefits&lt;/li&gt;
  &lt;li&gt;time (quarter ending March, June, etc)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The data have been published in aggregate form, which means in this case the first four of those dimensions are only present one at a time.  For example, we can say how many males are in the data, and how many people of Pacific background, but cant disaggregate the Pacific people by sex.  This loss of granularity (which limits the analysis that can be done on interaction effects) might be due to confidentiality and data reliability, or it might be a matter of needing to summarise the data somehow to get it into this human-readable workbook.&lt;/p&gt;

&lt;p&gt;First problem is to get the data out of Excel into R.  My preferred way of doing this is usually the openxlsx package.  However, it only works with newer .xlsx files, which are based on XML.  For the older .xls files there are a range of options, including the useful XLConnect package which in this case preserves a fair bit (not all) of the formatting information (for example, recognising 143,022 as a number despite the comma in it; and keeping the dates).  Heres how I imported the data.  The code below is all in R and should run smoothly end to end.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;XLConnect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;shinyapps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------import data---------------&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Original URL. Use of paste0 here is just to make readable in narrow screen:&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;url &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;https://www.msd.govt.nz/documents/about-msd-and-our-work/publications-resources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;/statistics/benefit/2015/quarterly-benefit-fact-sheets-national-benefit-tables-june-2015.xls&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Note use of wb mode (for binary file)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;download.file&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;url &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; destfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;benefits.xls&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;wb&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Import into R&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;wb &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; loadWorkbook&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;benefits.xls&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;benefits_orig &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; readWorksheet&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;wb&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Main benefits - last 5 years&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;                          startRow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; endRow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;21&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;# excluding total deliberately&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;                          startCol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; endCol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;                          dateTimeFormat &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;%Y-%m&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Now we have the data in our R environment, we have a job to turn it into a &lt;a href=&quot;http://vita.had.co.nz/papers/tidy-data.pdf&quot;&gt;tidy&lt;/a&gt; data set.  There are two little obstacles, arising from the Excel worksheet were using being set up for human rather than computer readers.  Heres how it looks in Excel:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0001-screenshot1.png&quot; alt=&quot;Excel with merged cells&quot; /&gt;&lt;/p&gt;

&lt;p&gt;First challenge is that the time variable is spread across columns, rather than being a set of different values in a single column.  This is a common issue - the need to convert from wide to long format - and there are straightforward solutions, of which the best in todays R environment is the gather function in Hadley Wickhams tidyr package.&lt;/p&gt;

&lt;p&gt;A slightly trickier issue is that the value cells for rows 5 and 6 have been merged together; also for 8 and 9, 14 and 15, etc.  We can fix this by taking advantage of the still regular structure of the data, with an old-school for loop trundling through it one row at a time and looking to see if its one of those rows where a classification heading and a first level of the classification have been merged together. Resolving this and gathering the data into tidy format takes about 30 lines of code:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------tidy----------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# First we need to deal with where merged cells cause problems.  For example, the &amp;quot;Gender&amp;quot; row&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# has the values for &amp;quot;Male&amp;quot;, and &amp;quot;Male&amp;quot; row is all NA.  We get round this by changing the word &amp;quot;Gender&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# to &amp;quot;Male&amp;quot; and adding a new Category column with &amp;quot;Gender&amp;quot; in it, until we get to the next heading.&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Meanwhile we note the original rows of NAs to knock them out&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;benefits &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; benefits_orig
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;knockout &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;Headings &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Gender&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Ethnic Group&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Age Group&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Continuous Duration&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;benefits_orig&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;benefits_orig&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Col1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; Headings&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;      benefits&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Col1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; benefits&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Col1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;      knockout &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;knockout&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;      last_category &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; benefits_orig&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Col1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   benefits&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Category&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; last_category
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;benefits &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; benefits&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;knockout&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# at this point should visually check with View(benefits) matches Excel version&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# put into tidy format and clean up the inconsistent Dates&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;benefits &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; benefits &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Date&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Col1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Category&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Col1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Date &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Date&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;          Date &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;X&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Date&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;          Date &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Jun.15&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;2015.06&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Date&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;          Date &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Mar.15&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;2015.03&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Date&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;          CentreMonth &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Date&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# central month of each quarter&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;          Year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Date&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;          Period &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Year &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;CentreMonth &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;          &lt;span class=&quot;c1&quot;&gt;# decimal representation of mid-quarter&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;CentreMonth&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Date&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So, now our data is tidy and looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0001-screenshot2.png&quot; alt=&quot;Table of tidy data&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Its now straightforward to use the data for analysis.  I wont go into that now, but as a taster here is a simple web-app taking advantage of the tidy format of the data.  The code behind the web app is &lt;a href=&quot;https://github.com/ellisp/ellisp.github.io/tree/source/_working/_output/0001-shiny-benefits&quot;&gt;available on GitHub&lt;/a&gt;.  We can do some simple exploring just with this visual tool.  For example, an overall downwards trend in number of beneficiaries in the last five years is obvious; as is a clear seasonal pattern with an increase in the numbers on benefits in the final quarter of each year.  Choosing the Continuous Duration classification (which splits beneficiaries into those who have been on benefits for less than or more than one year) shows - unsurprisingly that it is the short term beneficiaries that cause that pattern.&lt;/p&gt;

&lt;iframe width=&quot;850&quot; height=&quot;500&quot; src=&quot;https://ellisp.shinyapps.io/0001-shiny-benefits&quot; frameborder=&quot;0&quot; scrolling=&quot;no&quot;&gt;&lt;/iframe&gt;

</description>
				<pubDate>Sat, 01 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/01/new-zealand-data-on-github</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/01/new-zealand-data-on-github</guid>
			</item>
		
	</channel>
</rss>